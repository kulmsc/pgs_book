<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>7 Score Analysis Set-Up | Comparison of PGS Generative Methods</title>
  <meta name="description" content="A deep dive into all the scripts and underlying though processes that create polygenic risk scores" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="7 Score Analysis Set-Up | Comparison of PGS Generative Methods" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A deep dive into all the scripts and underlying though processes that create polygenic risk scores" />
  <meta name="github-repo" content="pgs_book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 Score Analysis Set-Up | Comparison of PGS Generative Methods" />
  
  <meta name="twitter:description" content="A deep dive into all the scripts and underlying though processes that create polygenic risk scores" />
  

<meta name="author" content="Scott Kulm" />


<meta name="date" content="2021-02-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="compiling-the-scores.html"/>
<link rel="next" href="tuning.html"/>
<script src="libs/header-attrs-2.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#directory-framework"><i class="fa fa-check"></i><b>1.1</b> Directory Framework</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="quality-control.html"><a href="quality-control.html"><i class="fa fa-check"></i><b>2</b> Quality Control</a>
<ul>
<li class="chapter" data-level="2.1" data-path="quality-control.html"><a href="quality-control.html#previously-applied-qc"><i class="fa fa-check"></i><b>2.1</b> Previously Applied QC</a></li>
<li class="chapter" data-level="2.2" data-path="quality-control.html"><a href="quality-control.html#initial-qc"><i class="fa fa-check"></i><b>2.2</b> Initial QC</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="summary-statistics.html"><a href="summary-statistics.html"><i class="fa fa-check"></i><b>3</b> Summary Statistics</a></li>
<li class="chapter" data-level="4" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html"><i class="fa fa-check"></i><b>4</b> Getting the Summary Statistics</a>
<ul>
<li class="chapter" data-level="4.1" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#prepare-variants"><i class="fa fa-check"></i><b>4.1</b> Prepare Variants</a></li>
<li class="chapter" data-level="4.2" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#standardize-the-summary-statistics"><i class="fa fa-check"></i><b>4.2</b> Standardize the Summary Statistics</a></li>
<li class="chapter" data-level="4.3" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#heritability-estimation"><i class="fa fa-check"></i><b>4.3</b> Heritability Estimation</a></li>
<li class="chapter" data-level="4.4" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#genetic-correlation-estimation"><i class="fa fa-check"></i><b>4.4</b> Genetic Correlation Estimation</a></li>
<li class="chapter" data-level="4.5" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#final-changes-and-remarks"><i class="fa fa-check"></i><b>4.5</b> Final Changes and Remarks</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html"><i class="fa fa-check"></i><b>5</b> Adjusting Summary Statistics</a>
<ul>
<li class="chapter" data-level="5.0.1" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#computational-framework"><i class="fa fa-check"></i><b>5.0.1</b> Computational Framework</a></li>
<li class="chapter" data-level="5.1" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#simple"><i class="fa fa-check"></i><b>5.1</b> Simple</a></li>
<li class="chapter" data-level="5.2" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#clumping"><i class="fa fa-check"></i><b>5.2</b> Clumping</a></li>
<li class="chapter" data-level="5.3" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#double-weight"><i class="fa fa-check"></i><b>5.3</b> Double Weight</a></li>
<li class="chapter" data-level="5.4" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#ldpred"><i class="fa fa-check"></i><b>5.4</b> LDpred</a></li>
<li class="chapter" data-level="5.5" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#ldpred2"><i class="fa fa-check"></i><b>5.5</b> LDpred2</a></li>
<li class="chapter" data-level="5.6" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#sblup"><i class="fa fa-check"></i><b>5.6</b> SBLUP</a></li>
<li class="chapter" data-level="5.7" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#smtpred"><i class="fa fa-check"></i><b>5.7</b> SMTpred</a></li>
<li class="chapter" data-level="5.8" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#prscs"><i class="fa fa-check"></i><b>5.8</b> prsCS</a></li>
<li class="chapter" data-level="5.9" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#lassosum"><i class="fa fa-check"></i><b>5.9</b> lassosum</a></li>
<li class="chapter" data-level="5.10" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#tweedie"><i class="fa fa-check"></i><b>5.10</b> Tweedie</a></li>
<li class="chapter" data-level="5.11" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#sbayesr"><i class="fa fa-check"></i><b>5.11</b> SBayesR</a></li>
<li class="chapter" data-level="5.12" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#jampred"><i class="fa fa-check"></i><b>5.12</b> JAMPred</a></li>
<li class="chapter" data-level="5.13" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#winners-curse-lasso"><i class="fa fa-check"></i><b>5.13</b> Winner’s Curse Lasso</a></li>
<li class="chapter" data-level="5.14" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#winners-curse-likelihood"><i class="fa fa-check"></i><b>5.14</b> Winner’s Curse Likelihood</a></li>
<li class="chapter" data-level="5.15" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#winners-curse-2d"><i class="fa fa-check"></i><b>5.15</b> Winner’s Curse 2D</a>
<ul>
<li class="chapter" data-level="5.15.1" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#additional-methods"><i class="fa fa-check"></i><b>5.15.1</b> Additional Methods</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html"><i class="fa fa-check"></i><b>6</b> Compiling the Scores</a>
<ul>
<li class="chapter" data-level="6.1" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#simple-score-approach"><i class="fa fa-check"></i><b>6.1</b> Simple Score Approach</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#what-to-worry-about"><i class="fa fa-check"></i><b>6.1.1</b> What to Worry About</a></li>
<li class="chapter" data-level="6.1.2" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#controlling-and-assembling"><i class="fa fa-check"></i><b>6.1.2</b> Controlling and Assembling</a></li>
<li class="chapter" data-level="6.1.3" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#verifying-everything-worked"><i class="fa fa-check"></i><b>6.1.3</b> Verifying Everything Worked</a></li>
<li class="chapter" data-level="6.1.4" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#other-options"><i class="fa fa-check"></i><b>6.1.4</b> Other Options</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html"><i class="fa fa-check"></i><b>7</b> Score Analysis Set-Up</a>
<ul>
<li class="chapter" data-level="7.1" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html#defining-the-phenotypes"><i class="fa fa-check"></i><b>7.1</b> Defining the Phenotypes</a></li>
<li class="chapter" data-level="7.2" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html#making-the-phenotype"><i class="fa fa-check"></i><b>7.2</b> Making the Phenotype</a></li>
<li class="chapter" data-level="7.3" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html#other-scores"><i class="fa fa-check"></i><b>7.3</b> Other Scores</a></li>
<li class="chapter" data-level="7.4" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html#other-covariates"><i class="fa fa-check"></i><b>7.4</b> Other Covariates</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="tuning.html"><a href="tuning.html"><i class="fa fa-check"></i><b>8</b> Tuning</a>
<ul>
<li class="chapter" data-level="8.1" data-path="tuning.html"><a href="tuning.html#generating-metrics"><i class="fa fa-check"></i><b>8.1</b> Generating Metrics</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="tuning.html"><a href="tuning.html#overall-set-up"><i class="fa fa-check"></i><b>8.1.1</b> Overall Set-Up</a></li>
<li class="chapter" data-level="8.1.2" data-path="tuning.html"><a href="tuning.html#survival-set-up"><i class="fa fa-check"></i><b>8.1.2</b> Survival Set-up</a></li>
<li class="chapter" data-level="8.1.3" data-path="tuning.html"><a href="tuning.html#survival-base-metrics"><i class="fa fa-check"></i><b>8.1.3</b> Survival Base Metrics</a></li>
<li class="chapter" data-level="8.1.4" data-path="tuning.html"><a href="tuning.html#survival-score-metrics"><i class="fa fa-check"></i><b>8.1.4</b> Survival Score Metrics</a></li>
<li class="chapter" data-level="8.1.5" data-path="tuning.html"><a href="tuning.html#logistic-regression-base-metrics"><i class="fa fa-check"></i><b>8.1.5</b> Logistic Regression Base Metrics</a></li>
<li class="chapter" data-level="8.1.6" data-path="tuning.html"><a href="tuning.html#logistic-regression-score-metrics"><i class="fa fa-check"></i><b>8.1.6</b> Logistic Regression Score Metrics</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="tuning.html"><a href="tuning.html#choosing-the-best-score"><i class="fa fa-check"></i><b>8.2</b> Choosing the Best Score</a></li>
<li class="chapter" data-level="8.3" data-path="tuning.html"><a href="tuning.html#plotting"><i class="fa fa-check"></i><b>8.3</b> Plotting</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="testing.html"><a href="testing.html"><i class="fa fa-check"></i><b>9</b> Testing</a>
<ul>
<li class="chapter" data-level="9.1" data-path="testing.html"><a href="testing.html#obtaining-the-statistics"><i class="fa fa-check"></i><b>9.1</b> Obtaining the Statistics</a></li>
<li class="chapter" data-level="9.2" data-path="testing.html"><a href="testing.html#plotting-1"><i class="fa fa-check"></i><b>9.2</b> Plotting</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="testing.html"><a href="testing.html#concordance"><i class="fa fa-check"></i><b>9.2.1</b> Concordance</a></li>
<li class="chapter" data-level="9.2.2" data-path="testing.html"><a href="testing.html#survival-curve-fit"><i class="fa fa-check"></i><b>9.2.2</b> Survival Curve Fit</a></li>
<li class="chapter" data-level="9.2.3" data-path="testing.html"><a href="testing.html#roc-and-auc"><i class="fa fa-check"></i><b>9.2.3</b> ROC and AUC</a></li>
<li class="chapter" data-level="9.2.4" data-path="testing.html"><a href="testing.html#odds-ratios"><i class="fa fa-check"></i><b>9.2.4</b> Odds Ratios</a></li>
<li class="chapter" data-level="9.2.5" data-path="testing.html"><a href="testing.html#pr-curves"><i class="fa fa-check"></i><b>9.2.5</b> PR Curves</a></li>
<li class="chapter" data-level="9.2.6" data-path="testing.html"><a href="testing.html#other-scores-1"><i class="fa fa-check"></i><b>9.2.6</b> Other Scores</a></li>
<li class="chapter" data-level="9.2.7" data-path="testing.html"><a href="testing.html#extra-covariates"><i class="fa fa-check"></i><b>9.2.7</b> Extra Covariates</a></li>
<li class="chapter" data-level="9.2.8" data-path="testing.html"><a href="testing.html#saving"><i class="fa fa-check"></i><b>9.2.8</b> Saving</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html"><i class="fa fa-check"></i><b>10</b> Additional Testing Statistics</a>
<ul>
<li class="chapter" data-level="10.1" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#calculating-the-statistics"><i class="fa fa-check"></i><b>10.1</b> Calculating the Statistics</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#brier-score"><i class="fa fa-check"></i><b>10.1.1</b> Brier Score</a></li>
<li class="chapter" data-level="10.1.2" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#reclassification-statistics-nri-and-idi"><i class="fa fa-check"></i><b>10.1.2</b> Reclassification Statistics (NRI and IDI)</a></li>
<li class="chapter" data-level="10.1.3" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#true-and-false-positive-rates"><i class="fa fa-check"></i><b>10.1.3</b> True and False Positive Rates</a></li>
<li class="chapter" data-level="10.1.4" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#reclassification-values"><i class="fa fa-check"></i><b>10.1.4</b> Reclassification Values</a></li>
<li class="chapter" data-level="10.1.5" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#decision-curve-analyses"><i class="fa fa-check"></i><b>10.1.5</b> Decision Curve Analyses</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#making-the-plots"><i class="fa fa-check"></i><b>10.2</b> Making the Plots</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html"><i class="fa fa-check"></i><b>11</b> Non-Predictive Evaluation</a>
<ul>
<li class="chapter" data-level="11.1" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#individual-score-evaluation"><i class="fa fa-check"></i><b>11.1</b> Individual Score Evaluation</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#set-up"><i class="fa fa-check"></i><b>11.1.1</b> Set Up</a></li>
<li class="chapter" data-level="11.1.2" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#analysis-of-score-sizes"><i class="fa fa-check"></i><b>11.1.2</b> Analysis of Score Sizes</a></li>
<li class="chapter" data-level="11.1.3" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#analysis-of-phenotype-definitions"><i class="fa fa-check"></i><b>11.1.3</b> Analysis of Phenotype Definitions</a></li>
<li class="chapter" data-level="11.1.4" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#comparison-between-the-sexes"><i class="fa fa-check"></i><b>11.1.4</b> Comparison Between the Sexes</a></li>
<li class="chapter" data-level="11.1.5" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#comparison-of-ethnic-groups"><i class="fa fa-check"></i><b>11.1.5</b> Comparison of Ethnic Groups</a></li>
<li class="chapter" data-level="11.1.6" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#comparison-of-siblings"><i class="fa fa-check"></i><b>11.1.6</b> Comparison of Siblings</a></li>
<li class="chapter" data-level="11.1.7" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#comparison-of-age"><i class="fa fa-check"></i><b>11.1.7</b> Comparison of Age</a></li>
<li class="chapter" data-level="11.1.8" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#comparison-of-many-other"><i class="fa fa-check"></i><b>11.1.8</b> Comparison of Many Other</a></li>
<li class="chapter" data-level="11.1.9" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#plotting-2"><i class="fa fa-check"></i><b>11.1.9</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="to-do.html"><a href="to-do.html"><i class="fa fa-check"></i><b>12</b> To Do</a>
<ul>
<li class="chapter" data-level="12.1" data-path="to-do.html"><a href="to-do.html#across-score-evaluations"><i class="fa fa-check"></i><b>12.1</b> Across Score Evaluations</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="to-do.html"><a href="to-do.html#set-up-1"><i class="fa fa-check"></i><b>12.1.1</b> Set-Up</a></li>
<li class="chapter" data-level="12.1.2" data-path="to-do.html"><a href="to-do.html#meta-info-regressions"><i class="fa fa-check"></i><b>12.1.2</b> Meta Info Regressions</a></li>
<li class="chapter" data-level="12.1.3" data-path="to-do.html"><a href="to-do.html#testing-and-training-comparison"><i class="fa fa-check"></i><b>12.1.3</b> Testing and Training Comparison</a></li>
<li class="chapter" data-level="12.1.4" data-path="to-do.html"><a href="to-do.html#plotting-3"><i class="fa fa-check"></i><b>12.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html"><i class="fa fa-check"></i><b>13</b> Lifestyle and Medications</a>
<ul>
<li class="chapter" data-level="13.1" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#lifestyle-modifcations"><i class="fa fa-check"></i><b>13.1</b> Lifestyle Modifcations</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#getting-the-statistics"><i class="fa fa-check"></i><b>13.1.1</b> Getting the Statistics</a></li>
<li class="chapter" data-level="13.1.2" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#plotting-4"><i class="fa fa-check"></i><b>13.1.2</b> Plotting</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#medications"><i class="fa fa-check"></i><b>13.2</b> Medications</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#set-up-2"><i class="fa fa-check"></i><b>13.2.1</b> Set Up</a></li>
<li class="chapter" data-level="13.2.2" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#meications"><i class="fa fa-check"></i><b>13.2.2</b> Meications</a></li>
<li class="chapter" data-level="13.2.3" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#analysis"><i class="fa fa-check"></i><b>13.2.3</b> Analysis</a></li>
<li class="chapter" data-level="13.2.4" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#change-in-plans"><i class="fa fa-check"></i><b>13.2.4</b> Change in Plans</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Comparison of PGS Generative Methods</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="score-analysis-set-up" class="section level1" number="7">
<h1><span class="header-section-number">7</span> Score Analysis Set-Up</h1>
<p>Now that we have the scores we are nearly ready for analysis. However, there are actually several more things that need to be done, namely setting up all of the phenotypes and covariates. Similar to creating the scores, this is an often underrated process that needs to be done carefully or everything else fails.</p>
<div id="defining-the-phenotypes" class="section level2" number="7.1">
<h2><span class="header-section-number">7.1</span> Defining the Phenotypes</h2>
<p>By phenotype I mean status of whether an individual has the disease corresponding to the polygenic risk score. This is a tricky problem, since first of all each underlying GWAS of the polygenic risk scores may construct phenotypes differently. Adjusting our phenotypes to each GWAS does not seem easy however, or even possible given the limited information within the UK Biobank. However the UK Biobank does have a great deal of information. The sources that we will use to construct phenotypes are as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Self-Reported - Each individual was interviewed by a trained nurse and asked about any illnesses they may have. The nurse then placed any description by the individual into a pre-specified tree of diseases. This data can be suspect as the individual may report self-diagnoses not confirmed by a doctor and not really existing, but overall they are likely to line up with actual conditions for most of the individuals.
Further description on the self-reported data-type can be found here, <a href="http://biobank.ndph.ox.ac.uk/showcase/field.cgi?id=20002" class="uri">http://biobank.ndph.ox.ac.uk/showcase/field.cgi?id=20002</a>, and all possible self-reported codings can be found here, <a href="http://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=3" class="uri">http://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=3</a>, and here <a href="http://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=6" class="uri">http://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=6</a> (for cancer and non-cancer).</p></li>
<li><p>ICD - The UK Biobank has pulled in the electronic health record of every individual. Specifically, when a doctor makes a diagnosis they will record the ICD code in the computer. These should be highly accurate, however there is always the change of a typo or a doctor recording a similar diagnosis that does not quite match what we want, making ICD codes rather fickle. These records have been parsed into hesin files (hospital episode statistics). In short there this one file, hesin_diag, with ICD codes on every line, and another file, hesin, with dates of hospital episodes. One can look up the dates for a given ICD code by using the EID and instance index. We will go over this more later.
More information on the hesin data can be found here, <a href="https://biobank.ndph.ox.ac.uk/showcase/showcase/docs/HospitalEpisodeStatistics.pdf" class="uri">https://biobank.ndph.ox.ac.uk/showcase/showcase/docs/HospitalEpisodeStatistics.pdf</a>. The coding for ICD9 codes can be found here, <a href="http://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=87" class="uri">http://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=87</a>. The coding for ICD10 codes can be found here, <a href="http://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=19" class="uri">http://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=19</a>. Note that ICD9 codes are older than ICD10.</p></li>
<li><p>OPCS - Similar to ICD, OPCS codes are generally part of the electronic health record and are accessed from the hesin set of files. However, instead of recording diagnoses they record operations. While generally not helpful for our purposes, some publications have used specific OPCS codes to assume that an underlying phenotype was the cause. Following precendent I will do the same.
More information on OPCS coding can be found here, <a href="http://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=240" class="uri">http://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=240</a>. There are also OPCS3 codes, but they are very, very sparse.</p></li>
<li><p>Medications - This is the least orthodox way of determining phenotype. But I figure if someone is taking a medication that is only used for one illness, then there is a very good chance the person has that illness. Unfortunately the UK Biobank does not have to the day records of medications, but only inventories when individuals come in for assessments. By looking over CDC, respective professional society, and Mayo Clinic websites I determine the associated medications and convert them into the UK Biobank codes.
More information on Medication coding can be found here, <a href="http://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=4" class="uri">http://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=4</a>. More information on how medication data was recorded can be found here, <a href="http://biobank.ndph.ox.ac.uk/showcase/field.cgi?id=20003" class="uri">http://biobank.ndph.ox.ac.uk/showcase/field.cgi?id=20003</a>.</p></li>
</ol>
<p>The table that actually holds the conversion from the many possible codes of each category into a 1/0 phenotype is as follows.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="score-analysis-set-up.html#cb67-1" aria-hidden="true" tabindex="-1"></a>  pheno_defs <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;../analyze_score/descript_defs/author_defs&quot;</span>, <span class="at">stringsAsFactors=</span>F, <span class="at">header=</span>T)</span>
<span id="cb67-2"><a href="score-analysis-set-up.html#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(pheno_defs)</span></code></pre></div>
<pre><code>##            author                             name sex cancer noncancer
## 1         Bentham                              sle   A     NA      1381
## 2  Christophersen               atrial_fibrilation   A     NA      1471
## 3        Demenais                           asthma   A     NA      1111
## 4        Demontis                             adhd   A     NA      &lt;NA&gt;
## 5          Dubois                   celiac_disease   A     NA      1456
## 6         Gormley                         migraine   A     NA      1265
## 7           IMSGC                               ms   A     NA      1261
## 8             Jin                         vitiligo   A     NA      1661
## 9         Kottgen                             gout   A     NA      1466
## 10          Liu-1               ulcerative_colitis   A     NA      1463
## 11          Liu-2                   crohns_disease   A     NA      1462
## 12        Mahajan                  type_2_diabetes   A     NA      1223
## 13          Malik                           stroke   A     NA      1081
## 14    Michailidou                    breast_cancer   F   1002      &lt;NA&gt;
## 15         Namjou nonalcoholic_fatty_liver_disease   A     NA      &lt;NA&gt;
## 16         Nikpay          coronary_artery_disease   A     NA 1075|1076
## 17          Okada             rheumatoid_arthritis   A     NA      1464
## 18        Onengut                  type_1_diabetes   A     NA      1222
## 19         Phelan                   ovarian_cancer   F   1039      &lt;NA&gt;
## 20        Rheenen                              als   A     NA      &lt;NA&gt;
## 21     Schumacher                  prostate_cancer   M   1044      &lt;NA&gt;
## 22           Shah                    heart_failure   A     NA      1076
## 23          Sklar                  bipolar_disease   A     NA      1291
## 24           Tsoi                        psoriaris   A     NA      1453
## 25           Wray        major_depressive_disorder   A     NA      1286
## 26            Xie    membranous_glomerulonephritis   A     NA      &lt;NA&gt;
##                               icd9                                    icd10
## 1                              710                           M321|M328|M329
## 2                             4273                                      I48
## 3                              493                                  J45|J46
## 4                              314                                      F90
## 5                              579                                     &lt;NA&gt;
## 6                              346                                      G43
## 7                              340                                      G35
## 8                             7091                                      L80
## 9                              274                                      M10
## 10                             556                                      K51
## 11                             555                                      K50
## 12                            &lt;NA&gt;                                      E11
## 13 431|432|433|434|435|436|437|438 I60|I61|I62|I633|I64|I65|I66|I67|I68|I69
## 14                             174                                      C50
## 15                            5718                                     K760
## 16                     410|411|412                    I21|I22|I23|I241|I252
## 17                             714                                  M05|M06
## 18                            &lt;NA&gt;                                      E10
## 19                             183                                      C56
## 20                            3352                                     G122
## 21                             185                                      C61
## 22                             428                                      I50
## 23                             296                                      F31
## 24                       6960|6961                                      L40
## 25                            &lt;NA&gt;                                      F33
## 26                            5831                                     N002
##                       opcs
## 1                     &lt;NA&gt;
## 2                K622|K623
## 3                     &lt;NA&gt;
## 4                     &lt;NA&gt;
## 5                     &lt;NA&gt;
## 6                     &lt;NA&gt;
## 7                     &lt;NA&gt;
## 8                     &lt;NA&gt;
## 9                     &lt;NA&gt;
## 10                    &lt;NA&gt;
## 11                    &lt;NA&gt;
## 12                    &lt;NA&gt;
## 13                U543|Z35
## 14             B27|B28|B29
## 15                    &lt;NA&gt;
## 16 K40|K41|K45|K49|K50|K75
## 17                    U504
## 18                    &lt;NA&gt;
## 19                    &lt;NA&gt;
## 20                    X852
## 21                    &lt;NA&gt;
## 22                    &lt;NA&gt;
## 23                    &lt;NA&gt;
## 24                    &lt;NA&gt;
## 25                    &lt;NA&gt;
## 26                    &lt;NA&gt;
##                                                                                       meds
## 1                                                                                     &lt;NA&gt;
## 2                                                                               1140888482
## 3                                                                               1141168340
## 4                                                                                     &lt;NA&gt;
## 5                                                                                     &lt;NA&gt;
## 6             1141163670|1141167932|1141172728|1141185436|1141192666|1141150620|1141151284
## 7  1141188640|1141188642|1141150596|1141172620|1141165546|1141167618|1141189254|1141189256
## 8                                                                                     &lt;NA&gt;
## 9                                                                               1140875408
## 10                                                                              1141153242
## 11                                                                                    &lt;NA&gt;
## 12                                                                                    &lt;NA&gt;
## 13                                                                                    &lt;NA&gt;
## 14                                                                   1140923018|1141190734
## 15                                                                                    &lt;NA&gt;
## 16                                                                                    &lt;NA&gt;
## 17                                  1141145896|1140909702|1141188588|1141180070|1140871188
## 18                                                                                    &lt;NA&gt;
## 19                                                                                    &lt;NA&gt;
## 20                                                                              1141195974
## 21                                                        1141150594|1140870274|1140921100
## 22                                                                                    &lt;NA&gt;
## 23                                                                                    &lt;NA&gt;
## 24                                                                                    &lt;NA&gt;
## 25                                                                                    &lt;NA&gt;
## 26                                                                                    &lt;NA&gt;</code></pre>
<p>The pipe symbol is used to indicate that if any of the codes can be found in the respective data type the phenotype will be called positive.</p>
</div>
<div id="making-the-phenotype" class="section level2" number="7.2">
<h2><span class="header-section-number">7.2</span> Making the Phenotype</h2>
<p>Now that we know what codes go to which phenotype, we simply need to go through the respective data files and check off when we find one for each EID. Easier said than done, so I’ve broken down things into parts. The first part is preparing the data, specifically breaking down the large phenotype file downloaded from the UK Biobank into parts that are easy to inspect and read in. Along with these files, the hesin files are also nescessary, although they do not need any breaking down. I would display these files but I do not think I am allowed to. Anyway, the breaking down scripts looks like the following (note that if following along your indices are likely different).</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb69-1"><a href="score-analysis-set-up.html#cb69-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-2"><a href="score-analysis-set-up.html#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="co">#self diag from 472 to 573</span></span>
<span id="cb69-3"><a href="score-analysis-set-up.html#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="co">#date attend assessment center from 41 to 43</span></span>
<span id="cb69-4"><a href="score-analysis-set-up.html#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co">#medication from 574 to 717</span></span>
<span id="cb69-5"><a href="score-analysis-set-up.html#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="score-analysis-set-up.html#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="fu">zcat</span> ~/athena/ukbiobank/phenotypes/ukb26867.csv.gz <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d</span><span class="st">&#39;,&#39;</span> <span class="at">-f1</span> <span class="op">&gt;</span> eid.csv</span>
<span id="cb69-7"><a href="score-analysis-set-up.html#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="fu">zcat</span> ~/athena/ukbiobank/phenotypes/ukb26867.csv.gz <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d</span><span class="st">&#39;,&#39;</span> <span class="at">-f472-573</span> <span class="op">&gt;</span> self_report_diag.csv</span>
<span id="cb69-8"><a href="score-analysis-set-up.html#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="fu">zcat</span> ~/athena/ukbiobank/phenotypes/ukb26867.csv.gz <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d</span><span class="st">&#39;,&#39;</span> <span class="at">-f454-471</span> <span class="op">&gt;</span> self_report_cancer.csv</span>
<span id="cb69-9"><a href="score-analysis-set-up.html#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="fu">zcat</span> ~/athena/ukbiobank/phenotypes/ukb26867.csv.gz <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d</span><span class="st">&#39;,&#39;</span> <span class="at">-f41-43</span> <span class="op">&gt;</span> date_assessed.csv</span>
<span id="cb69-10"><a href="score-analysis-set-up.html#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="fu">zcat</span> ~/athena/ukbiobank/phenotypes/ukb26867.csv.gz <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d</span><span class="st">&#39;,&#39;</span> <span class="at">-f574-717</span> <span class="op">&gt;</span> medications.csv</span></code></pre></div>
<p>Now that everything is prepared data-wise we can get on with inspecting and calling phenotypes. I have tried this in many different ways, and the fastest option seems to be breaking down the total 500,000 people into groups and calling phenotypes for each group in parallel. This parallel component is controlled by the following script, which is straightforward.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb70-1"><a href="score-analysis-set-up.html#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> parallel_splits <span class="kw">|</span> <span class="cf">while</span> <span class="bu">read</span> <span class="va">line</span><span class="kw">;</span><span class="cf">do</span></span>
<span id="cb70-2"><a href="score-analysis-set-up.html#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">star=</span><span class="kw">`</span><span class="bu">echo</span> <span class="va">$line</span> <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d</span><span class="st">&#39; &#39;</span> <span class="at">-f1</span><span class="kw">`</span></span>
<span id="cb70-3"><a href="score-analysis-set-up.html#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">end=</span><span class="kw">`</span><span class="bu">echo</span> <span class="va">$line</span> <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d</span><span class="st">&#39; &#39;</span> <span class="at">-f2</span><span class="kw">`</span></span>
<span id="cb70-4"><a href="score-analysis-set-up.html#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="va">$star</span></span>
<span id="cb70-5"><a href="score-analysis-set-up.html#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">python</span> better_pheno.py <span class="va">$star</span> <span class="va">$end</span> <span class="kw">&amp;</span></span>
<span id="cb70-6"><a href="score-analysis-set-up.html#cb70-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sleep</span> 80</span>
<span id="cb70-7"><a href="score-analysis-set-up.html#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p>As you may be able to see the key script here is called better_pheno.py. This script has a few different parts. First it reads in all of the prepared data. Next it subsets down to the group of individuals specified by the control_make_pheno, and sorts each file so the EIDs line up. This sorting is important as it allows for quick indexing of EIDs (just iterate to the next unique EID rather than searching for the index). Lastly I check each type of phenotype (self-report, ICD, etc.) for the coding that was specified. For the ICD and OPCS this process required me to check not just the exact code, but also a more general code due to the hierarchical natur of their coding. For example if I am looking for G35 and an individual has G351 then I will still count that as a match. Further details on how this script works can be found in the well recorded comments of the script itself, which starts below.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="score-analysis-set-up.html#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb71-2"><a href="score-analysis-set-up.html#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb71-3"><a href="score-analysis-set-up.html#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb71-4"><a href="score-analysis-set-up.html#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb71-5"><a href="score-analysis-set-up.html#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pdb</span>
<span id="cb71-6"><a href="score-analysis-set-up.html#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gzip</span>
<span id="cb71-7"><a href="score-analysis-set-up.html#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb71-8"><a href="score-analysis-set-up.html#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb71-9"><a href="score-analysis-set-up.html#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb71-10"><a href="score-analysis-set-up.html#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb71-11"><a href="score-analysis-set-up.html#cb71-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-12"><a href="score-analysis-set-up.html#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="co">#Declare the author that corresponds to the phenotype you want</span></span>
<span id="cb71-13"><a href="score-analysis-set-up.html#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Also the indices of the group we want phenotypes for</span></span>
<span id="cb71-14"><a href="score-analysis-set-up.html#cb71-14" aria-hidden="true" tabindex="-1"></a>author <span class="op">=</span> <span class="st">&quot;Christophersen&quot;</span></span>
<span id="cb71-15"><a href="score-analysis-set-up.html#cb71-15" aria-hidden="true" tabindex="-1"></a>start_ind <span class="op">=</span> <span class="bu">int</span>(sys.argv[<span class="dv">1</span>])</span>
<span id="cb71-16"><a href="score-analysis-set-up.html#cb71-16" aria-hidden="true" tabindex="-1"></a>end_ind <span class="op">=</span> <span class="bu">int</span>(sys.argv[<span class="dv">2</span>])</span>
<span id="cb71-17"><a href="score-analysis-set-up.html#cb71-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-18"><a href="score-analysis-set-up.html#cb71-18" aria-hidden="true" tabindex="-1"></a><span class="co">#Function to read in the data</span></span>
<span id="cb71-19"><a href="score-analysis-set-up.html#cb71-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normRead(fileName, withHeader <span class="op">=</span> <span class="va">True</span>, delim <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>, removeQuote <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb71-20"><a href="score-analysis-set-up.html#cb71-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(fileName,<span class="st">&quot;r&quot;</span>,encoding <span class="op">=</span> <span class="st">&quot;latin-1&quot;</span>) <span class="im">as</span> f:</span>
<span id="cb71-21"><a href="score-analysis-set-up.html#cb71-21" aria-hidden="true" tabindex="-1"></a>        totalData<span class="op">=</span>[]</span>
<span id="cb71-22"><a href="score-analysis-set-up.html#cb71-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> line <span class="kw">in</span> f.read().splitlines():</span>
<span id="cb71-23"><a href="score-analysis-set-up.html#cb71-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> removeQuote:</span>
<span id="cb71-24"><a href="score-analysis-set-up.html#cb71-24" aria-hidden="true" tabindex="-1"></a>                totalData.append(line.replace(<span class="st">&#39;&quot;&#39;</span>, <span class="st">&#39;&#39;</span>).strip().split(delim))</span>
<span id="cb71-25"><a href="score-analysis-set-up.html#cb71-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb71-26"><a href="score-analysis-set-up.html#cb71-26" aria-hidden="true" tabindex="-1"></a>                totalData.append(line.split(delim))</span>
<span id="cb71-27"><a href="score-analysis-set-up.html#cb71-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> withHeader:</span>
<span id="cb71-28"><a href="score-analysis-set-up.html#cb71-28" aria-hidden="true" tabindex="-1"></a>        header<span class="op">=</span>totalData[<span class="dv">0</span>]</span>
<span id="cb71-29"><a href="score-analysis-set-up.html#cb71-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> totalData[<span class="dv">0</span>]</span>
<span id="cb71-30"><a href="score-analysis-set-up.html#cb71-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb71-31"><a href="score-analysis-set-up.html#cb71-31" aria-hidden="true" tabindex="-1"></a>        header <span class="op">=</span> <span class="va">None</span></span>
<span id="cb71-32"><a href="score-analysis-set-up.html#cb71-32" aria-hidden="true" tabindex="-1"></a>    totalData<span class="op">=</span>np.array(totalData)</span>
<span id="cb71-33"><a href="score-analysis-set-up.html#cb71-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(totalData,header)</span>
<span id="cb71-34"><a href="score-analysis-set-up.html#cb71-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-35"><a href="score-analysis-set-up.html#cb71-35" aria-hidden="true" tabindex="-1"></a><span class="co">#Read in the files that were split from the main UKBB phenotype file</span></span>
<span id="cb71-36"><a href="score-analysis-set-up.html#cb71-36" aria-hidden="true" tabindex="-1"></a>date_ass,ass_header <span class="op">=</span> normRead(<span class="st">&quot;date_assessed.csv&quot;</span>, <span class="va">True</span>, <span class="st">&quot;,&quot;</span>, <span class="va">True</span>)</span>
<span id="cb71-37"><a href="score-analysis-set-up.html#cb71-37" aria-hidden="true" tabindex="-1"></a>meds, meds_header <span class="op">=</span> normRead(<span class="st">&quot;medications.csv&quot;</span>, <span class="va">True</span>, <span class="st">&quot;,&quot;</span>, <span class="va">True</span>)</span>
<span id="cb71-38"><a href="score-analysis-set-up.html#cb71-38" aria-hidden="true" tabindex="-1"></a>self_rep, self_rep_header <span class="op">=</span> normRead(<span class="st">&quot;self_report_diag.csv&quot;</span>, <span class="va">True</span>, <span class="st">&quot;,&quot;</span>, <span class="va">True</span>)</span>
<span id="cb71-39"><a href="score-analysis-set-up.html#cb71-39" aria-hidden="true" tabindex="-1"></a>cancer_rep, cancer_rep_header <span class="op">=</span> normRead(<span class="st">&quot;self_report_cancer.csv&quot;</span>, <span class="va">True</span>, <span class="st">&quot;,&quot;</span>, <span class="va">True</span>)</span>
<span id="cb71-40"><a href="score-analysis-set-up.html#cb71-40" aria-hidden="true" tabindex="-1"></a>big_eid, eid_head <span class="op">=</span> normRead(<span class="st">&quot;eid.csv&quot;</span>, <span class="va">True</span>, <span class="st">&quot;,&quot;</span>, <span class="va">True</span>)</span>
<span id="cb71-41"><a href="score-analysis-set-up.html#cb71-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-42"><a href="score-analysis-set-up.html#cb71-42" aria-hidden="true" tabindex="-1"></a><span class="co">#sort the files just read in so they are in EID order</span></span>
<span id="cb71-43"><a href="score-analysis-set-up.html#cb71-43" aria-hidden="true" tabindex="-1"></a>date_ass <span class="op">=</span> date_ass[big_eid[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb71-44"><a href="score-analysis-set-up.html#cb71-44" aria-hidden="true" tabindex="-1"></a>meds <span class="op">=</span> meds[big_eid[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb71-45"><a href="score-analysis-set-up.html#cb71-45" aria-hidden="true" tabindex="-1"></a>self_rep <span class="op">=</span> self_rep[big_eid[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb71-46"><a href="score-analysis-set-up.html#cb71-46" aria-hidden="true" tabindex="-1"></a>cancer_rep <span class="op">=</span> cancer_rep[big_eid[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb71-47"><a href="score-analysis-set-up.html#cb71-47" aria-hidden="true" tabindex="-1"></a>big_eid <span class="op">=</span> big_eid[big_eid[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb71-48"><a href="score-analysis-set-up.html#cb71-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-49"><a href="score-analysis-set-up.html#cb71-49" aria-hidden="true" tabindex="-1"></a><span class="co">#Get the phase, or the assessment type for cancer, self-report and medication report</span></span>
<span id="cb71-50"><a href="score-analysis-set-up.html#cb71-50" aria-hidden="true" tabindex="-1"></a><span class="co">#Phase meaning what index, or what time the person came in to be assessed (first, second or third assessment)</span></span>
<span id="cb71-51"><a href="score-analysis-set-up.html#cb71-51" aria-hidden="true" tabindex="-1"></a>cancer_phase <span class="op">=</span> [x.split(<span class="st">&quot;-&quot;</span>)[<span class="dv">1</span>].split(<span class="st">&quot;.&quot;</span>)[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> cancer_rep_header]</span>
<span id="cb71-52"><a href="score-analysis-set-up.html#cb71-52" aria-hidden="true" tabindex="-1"></a>self_phase <span class="op">=</span> [x.split(<span class="st">&quot;-&quot;</span>)[<span class="dv">1</span>].split(<span class="st">&quot;.&quot;</span>)[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> self_rep_header]</span>
<span id="cb71-53"><a href="score-analysis-set-up.html#cb71-53" aria-hidden="true" tabindex="-1"></a>meds_phase <span class="op">=</span> [x.split(<span class="st">&quot;-&quot;</span>)[<span class="dv">1</span>].split(<span class="st">&quot;.&quot;</span>)[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> meds_header]</span>
<span id="cb71-54"><a href="score-analysis-set-up.html#cb71-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-55"><a href="score-analysis-set-up.html#cb71-55" aria-hidden="true" tabindex="-1"></a><span class="co">#Read in the hesin type of data and again sort by EID</span></span>
<span id="cb71-56"><a href="score-analysis-set-up.html#cb71-56" aria-hidden="true" tabindex="-1"></a>diag, head_diag <span class="op">=</span> normRead(<span class="st">&quot;/home/kulmsc/athena/ukbiobank/hesin/hesin_diag.txt&quot;</span>)</span>
<span id="cb71-57"><a href="score-analysis-set-up.html#cb71-57" aria-hidden="true" tabindex="-1"></a>oper, head_oper <span class="op">=</span> normRead(<span class="st">&quot;/home/kulmsc/athena/ukbiobank/hesin/hesin_oper.txt&quot;</span>)</span>
<span id="cb71-58"><a href="score-analysis-set-up.html#cb71-58" aria-hidden="true" tabindex="-1"></a>hesin, head_hesin <span class="op">=</span> normRead(<span class="st">&quot;/home/kulmsc/athena/ukbiobank/hesin/hesin.txt&quot;</span>)</span>
<span id="cb71-59"><a href="score-analysis-set-up.html#cb71-59" aria-hidden="true" tabindex="-1"></a>diag <span class="op">=</span> diag[diag[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb71-60"><a href="score-analysis-set-up.html#cb71-60" aria-hidden="true" tabindex="-1"></a>oper <span class="op">=</span> oper[oper[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb71-61"><a href="score-analysis-set-up.html#cb71-61" aria-hidden="true" tabindex="-1"></a>hesin <span class="op">=</span> hesin[hesin[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb71-62"><a href="score-analysis-set-up.html#cb71-62" aria-hidden="true" tabindex="-1"></a>diag_eid <span class="op">=</span> np.unique(diag[:,<span class="dv">0</span>])</span>
<span id="cb71-63"><a href="score-analysis-set-up.html#cb71-63" aria-hidden="true" tabindex="-1"></a>oper_eid <span class="op">=</span> np.unique(diag[:,<span class="dv">0</span>])</span>
<span id="cb71-64"><a href="score-analysis-set-up.html#cb71-64" aria-hidden="true" tabindex="-1"></a>diag_max <span class="op">=</span> diag.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb71-65"><a href="score-analysis-set-up.html#cb71-65" aria-hidden="true" tabindex="-1"></a>oper_max <span class="op">=</span> oper.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb71-66"><a href="score-analysis-set-up.html#cb71-66" aria-hidden="true" tabindex="-1"></a>diag_eid_list <span class="op">=</span> diag[:,<span class="dv">0</span>].tolist()</span>
<span id="cb71-67"><a href="score-analysis-set-up.html#cb71-67" aria-hidden="true" tabindex="-1"></a>oper_eid_list <span class="op">=</span> oper[:,<span class="dv">0</span>].tolist()</span>
<span id="cb71-68"><a href="score-analysis-set-up.html#cb71-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-69"><a href="score-analysis-set-up.html#cb71-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-70"><a href="score-analysis-set-up.html#cb71-70" aria-hidden="true" tabindex="-1"></a><span class="co">#Read in the disease defintion and split the types with multiple condictions, then make into a dict</span></span>
<span id="cb71-71"><a href="score-analysis-set-up.html#cb71-71" aria-hidden="true" tabindex="-1"></a>defs, head_defs <span class="op">=</span> normRead(<span class="st">&quot;../descript_defs/author_defs&quot;</span>)</span>
<span id="cb71-72"><a href="score-analysis-set-up.html#cb71-72" aria-hidden="true" tabindex="-1"></a>def_ind <span class="op">=</span> defs[:,<span class="dv">0</span>].tolist().index(author)</span>
<span id="cb71-73"><a href="score-analysis-set-up.html#cb71-73" aria-hidden="true" tabindex="-1"></a>split_defs <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb71-74"><a href="score-analysis-set-up.html#cb71-74" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> type_def <span class="kw">in</span> defs[def_ind, <span class="dv">3</span>:<span class="dv">9</span>]:</span>
<span id="cb71-75"><a href="score-analysis-set-up.html#cb71-75" aria-hidden="true" tabindex="-1"></a>    split_defs.append(type_def.split(<span class="st">&quot;|&quot;</span>))</span>
<span id="cb71-76"><a href="score-analysis-set-up.html#cb71-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-77"><a href="score-analysis-set-up.html#cb71-77" aria-hidden="true" tabindex="-1"></a><span class="co">#Produce a dictionary so we can easily pull out the codes for each data type</span></span>
<span id="cb71-78"><a href="score-analysis-set-up.html#cb71-78" aria-hidden="true" tabindex="-1"></a>use_defs <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(head_defs[<span class="dv">3</span>:<span class="dv">9</span>], split_defs))</span>
<span id="cb71-79"><a href="score-analysis-set-up.html#cb71-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-80"><a href="score-analysis-set-up.html#cb71-80" aria-hidden="true" tabindex="-1"></a><span class="co">#This if for timing, which I do not do anymore</span></span>
<span id="cb71-81"><a href="score-analysis-set-up.html#cb71-81" aria-hidden="true" tabindex="-1"></a><span class="co">#cancer_sr_time = 0</span></span>
<span id="cb71-82"><a href="score-analysis-set-up.html#cb71-82" aria-hidden="true" tabindex="-1"></a><span class="co">#noncancer_sr_time = 0</span></span>
<span id="cb71-83"><a href="score-analysis-set-up.html#cb71-83" aria-hidden="true" tabindex="-1"></a><span class="co">#hesin_setup_time = 0</span></span>
<span id="cb71-84"><a href="score-analysis-set-up.html#cb71-84" aria-hidden="true" tabindex="-1"></a><span class="co">#icd9_time = 0</span></span>
<span id="cb71-85"><a href="score-analysis-set-up.html#cb71-85" aria-hidden="true" tabindex="-1"></a><span class="co">#icd10_time = 0</span></span>
<span id="cb71-86"><a href="score-analysis-set-up.html#cb71-86" aria-hidden="true" tabindex="-1"></a><span class="co">#hesin_oper_time = 0</span></span>
<span id="cb71-87"><a href="score-analysis-set-up.html#cb71-87" aria-hidden="true" tabindex="-1"></a><span class="co">#med_time = 0</span></span>
<span id="cb71-88"><a href="score-analysis-set-up.html#cb71-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-89"><a href="score-analysis-set-up.html#cb71-89" aria-hidden="true" tabindex="-1"></a><span class="co">#Find the splits of the input data, so RAM will be less</span></span>
<span id="cb71-90"><a href="score-analysis-set-up.html#cb71-90" aria-hidden="true" tabindex="-1"></a><span class="co">#Simply find the eid corresponding to the start and stop index</span></span>
<span id="cb71-91"><a href="score-analysis-set-up.html#cb71-91" aria-hidden="true" tabindex="-1"></a><span class="co">#Continuing to skip them if they do not appear in the given data type</span></span>
<span id="cb71-92"><a href="score-analysis-set-up.html#cb71-92" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> subset_big_data(eid_list, big_data):</span>
<span id="cb71-93"><a href="score-analysis-set-up.html#cb71-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-94"><a href="score-analysis-set-up.html#cb71-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ind <span class="kw">in</span> <span class="bu">range</span>(start_ind, end_ind):</span>
<span id="cb71-95"><a href="score-analysis-set-up.html#cb71-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> big_eid[ind][<span class="dv">0</span>] <span class="kw">in</span> eid_list:</span>
<span id="cb71-96"><a href="score-analysis-set-up.html#cb71-96" aria-hidden="true" tabindex="-1"></a>            start_eid <span class="op">=</span> eid_list.index(big_eid[ind][<span class="dv">0</span>])</span>
<span id="cb71-97"><a href="score-analysis-set-up.html#cb71-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb71-98"><a href="score-analysis-set-up.html#cb71-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-99"><a href="score-analysis-set-up.html#cb71-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ind <span class="kw">in</span> <span class="bu">range</span>(end_ind, start_ind,<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb71-100"><a href="score-analysis-set-up.html#cb71-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> big_eid[ind][<span class="dv">0</span>] <span class="kw">in</span> eid_list:</span>
<span id="cb71-101"><a href="score-analysis-set-up.html#cb71-101" aria-hidden="true" tabindex="-1"></a>            end_eid <span class="op">=</span> np.where(big_data[:,<span class="dv">0</span>] <span class="op">==</span> big_eid[ind][<span class="dv">0</span>])[<span class="dv">0</span>][<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb71-102"><a href="score-analysis-set-up.html#cb71-102" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb71-103"><a href="score-analysis-set-up.html#cb71-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-104"><a href="score-analysis-set-up.html#cb71-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(big_data[start_eid:end_eid,:])</span>
<span id="cb71-105"><a href="score-analysis-set-up.html#cb71-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-106"><a href="score-analysis-set-up.html#cb71-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-107"><a href="score-analysis-set-up.html#cb71-107" aria-hidden="true" tabindex="-1"></a><span class="co">#I&#39;m still bad at python indexing so I have to include this line to fix a single case example</span></span>
<span id="cb71-108"><a href="score-analysis-set-up.html#cb71-108" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> end_ind <span class="op">&gt;</span> big_eid.shape[<span class="dv">0</span>]:</span>
<span id="cb71-109"><a href="score-analysis-set-up.html#cb71-109" aria-hidden="true" tabindex="-1"></a>    end_ind <span class="op">=</span> big_eid.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb71-110"><a href="score-analysis-set-up.html#cb71-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-111"><a href="score-analysis-set-up.html#cb71-111" aria-hidden="true" tabindex="-1"></a><span class="co">#Apply the subset_big_data, and convert some things to lists for easier indexing</span></span>
<span id="cb71-112"><a href="score-analysis-set-up.html#cb71-112" aria-hidden="true" tabindex="-1"></a>diag <span class="op">=</span> subset_big_data(diag_eid_list, diag)</span>
<span id="cb71-113"><a href="score-analysis-set-up.html#cb71-113" aria-hidden="true" tabindex="-1"></a>oper <span class="op">=</span> subset_big_data(oper_eid_list, oper)</span>
<span id="cb71-114"><a href="score-analysis-set-up.html#cb71-114" aria-hidden="true" tabindex="-1"></a>hesin <span class="op">=</span> subset_big_data(hesin[:,<span class="dv">0</span>].tolist(), hesin)</span>
<span id="cb71-115"><a href="score-analysis-set-up.html#cb71-115" aria-hidden="true" tabindex="-1"></a>diag_eid_list <span class="op">=</span> diag[:,<span class="dv">0</span>].tolist()</span>
<span id="cb71-116"><a href="score-analysis-set-up.html#cb71-116" aria-hidden="true" tabindex="-1"></a>oper_eid_list <span class="op">=</span> oper[:,<span class="dv">0</span>].tolist()</span>
<span id="cb71-117"><a href="score-analysis-set-up.html#cb71-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-118"><a href="score-analysis-set-up.html#cb71-118" aria-hidden="true" tabindex="-1"></a><span class="co">#Establish indicdes of diag and oper for easy indexing (do not need to look and make index every time</span></span>
<span id="cb71-119"><a href="score-analysis-set-up.html#cb71-119" aria-hidden="true" tabindex="-1"></a><span class="co">#only need to add the extent of the current eid to this index)</span></span>
<span id="cb71-120"><a href="score-analysis-set-up.html#cb71-120" aria-hidden="true" tabindex="-1"></a>start_eid_diag <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb71-121"><a href="score-analysis-set-up.html#cb71-121" aria-hidden="true" tabindex="-1"></a>start_eid_oper <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb71-122"><a href="score-analysis-set-up.html#cb71-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-123"><a href="score-analysis-set-up.html#cb71-123" aria-hidden="true" tabindex="-1"></a><span class="co">#Subset the things that do not require the subset_big_data function</span></span>
<span id="cb71-124"><a href="score-analysis-set-up.html#cb71-124" aria-hidden="true" tabindex="-1"></a>meds <span class="op">=</span> meds[start_ind:end_ind,:]</span>
<span id="cb71-125"><a href="score-analysis-set-up.html#cb71-125" aria-hidden="true" tabindex="-1"></a>self_rep <span class="op">=</span> self_rep[start_ind:end_ind,:]</span>
<span id="cb71-126"><a href="score-analysis-set-up.html#cb71-126" aria-hidden="true" tabindex="-1"></a>date_ass <span class="op">=</span> date_ass[start_ind:end_ind,:]</span>
<span id="cb71-127"><a href="score-analysis-set-up.html#cb71-127" aria-hidden="true" tabindex="-1"></a>cancer_rep <span class="op">=</span> cancer_rep[start_ind:end_ind,:]</span>
<span id="cb71-128"><a href="score-analysis-set-up.html#cb71-128" aria-hidden="true" tabindex="-1"></a>big_eid <span class="op">=</span> big_eid[start_ind:end_ind,:]</span>
<span id="cb71-129"><a href="score-analysis-set-up.html#cb71-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-130"><a href="score-analysis-set-up.html#cb71-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-131"><a href="score-analysis-set-up.html#cb71-131" aria-hidden="true" tabindex="-1"></a><span class="co">#Prepare the data objects that will hold diagnosis results</span></span>
<span id="cb71-132"><a href="score-analysis-set-up.html#cb71-132" aria-hidden="true" tabindex="-1"></a>df_occur <span class="op">=</span> np.zeros((big_eid.shape[<span class="dv">0</span>], <span class="dv">6</span>))</span>
<span id="cb71-133"><a href="score-analysis-set-up.html#cb71-133" aria-hidden="true" tabindex="-1"></a>df_date <span class="op">=</span> np.tile(<span class="st">&quot;__________&quot;</span>, (big_eid.shape[<span class="dv">0</span>], <span class="dv">6</span>))</span>
<span id="cb71-134"><a href="score-analysis-set-up.html#cb71-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-135"><a href="score-analysis-set-up.html#cb71-135" aria-hidden="true" tabindex="-1"></a><span class="co">#Iterate through the indices of each unique EID</span></span>
<span id="cb71-136"><a href="score-analysis-set-up.html#cb71-136" aria-hidden="true" tabindex="-1"></a><span class="co">#Note for lessons learned in speed-up:</span></span>
<span id="cb71-137"><a href="score-analysis-set-up.html#cb71-137" aria-hidden="true" tabindex="-1"></a><span class="co"># - do not subset objects (I think copies are made in RAM which really slow things down)</span></span>
<span id="cb71-138"><a href="score-analysis-set-up.html#cb71-138" aria-hidden="true" tabindex="-1"></a><span class="co"># - always try to just iterate to the next index rather than searching for some keyword</span></span>
<span id="cb71-139"><a href="score-analysis-set-up.html#cb71-139" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ind <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, (end_ind <span class="op">-</span> start_ind)):</span>
<span id="cb71-140"><a href="score-analysis-set-up.html#cb71-140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ind <span class="op">%</span> <span class="dv">10000</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb71-141"><a href="score-analysis-set-up.html#cb71-141" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(ind) <span class="co">#So I know how fast things are running</span></span>
<span id="cb71-142"><a href="score-analysis-set-up.html#cb71-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-143"><a href="score-analysis-set-up.html#cb71-143" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set the value of the actual eid</span></span>
<span id="cb71-144"><a href="score-analysis-set-up.html#cb71-144" aria-hidden="true" tabindex="-1"></a>    curr_eid <span class="op">=</span> big_eid[ind][<span class="dv">0</span>]</span>
<span id="cb71-145"><a href="score-analysis-set-up.html#cb71-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-146"><a href="score-analysis-set-up.html#cb71-146" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Now we go through and fill in each column of df_occur and df_date, one data type at a time</span></span>
<span id="cb71-147"><a href="score-analysis-set-up.html#cb71-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-148"><a href="score-analysis-set-up.html#cb71-148" aria-hidden="true" tabindex="-1"></a>    <span class="co">#CANCER SELF REPORT (this is the name of the column in df_occur and df_date I am filling in)</span></span>
<span id="cb71-149"><a href="score-analysis-set-up.html#cb71-149" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_defs[<span class="st">&quot;cancer&quot;</span>][<span class="dv">0</span>] <span class="op">!=</span> <span class="st">&quot;NA&quot;</span>: <span class="co">#check to see if there is a noncancer definition</span></span>
<span id="cb71-150"><a href="score-analysis-set-up.html#cb71-150" aria-hidden="true" tabindex="-1"></a>        <span class="co">#t1 = time.time()</span></span>
<span id="cb71-151"><a href="score-analysis-set-up.html#cb71-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[<span class="st">&quot;cancer&quot;</span>], cancer_rep[ind,:])): <span class="co">#if the cancer definition is in the cancer data</span></span>
<span id="cb71-152"><a href="score-analysis-set-up.html#cb71-152" aria-hidden="true" tabindex="-1"></a>            locs <span class="op">=</span> np.where(np.isin(cancer_rep[ind,:], use_defs[<span class="st">&quot;cancer&quot;</span>]))[<span class="dv">0</span>] <span class="co">#get assessment index of the cancer occurence</span></span>
<span id="cb71-153"><a href="score-analysis-set-up.html#cb71-153" aria-hidden="true" tabindex="-1"></a>            try_date <span class="op">=</span> date_ass[ind, <span class="bu">int</span>(cancer_phase[locs[<span class="dv">0</span>]])] <span class="co">#record the date based on index of ind. assessment</span></span>
<span id="cb71-154"><a href="score-analysis-set-up.html#cb71-154" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> try_date <span class="op">==</span> <span class="st">&quot;&quot;</span>: <span class="co">#somtimes the data is empty so we go back to the last date we know</span></span>
<span id="cb71-155"><a href="score-analysis-set-up.html#cb71-155" aria-hidden="true" tabindex="-1"></a>                try_date <span class="op">=</span> date_ass[ind,<span class="dv">0</span>]</span>
<span id="cb71-156"><a href="score-analysis-set-up.html#cb71-156" aria-hidden="true" tabindex="-1"></a>            df_date[ind,<span class="dv">0</span>] <span class="op">=</span> try_date</span>
<span id="cb71-157"><a href="score-analysis-set-up.html#cb71-157" aria-hidden="true" tabindex="-1"></a>            df_occur[ind,<span class="dv">0</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb71-158"><a href="score-analysis-set-up.html#cb71-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-159"><a href="score-analysis-set-up.html#cb71-159" aria-hidden="true" tabindex="-1"></a>        <span class="co">#t2 = time.time()</span></span>
<span id="cb71-160"><a href="score-analysis-set-up.html#cb71-160" aria-hidden="true" tabindex="-1"></a>        <span class="co">#cancer_sr_time += t2-t1</span></span>
<span id="cb71-161"><a href="score-analysis-set-up.html#cb71-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-162"><a href="score-analysis-set-up.html#cb71-162" aria-hidden="true" tabindex="-1"></a>    <span class="co">#NON-CANCER SELF REPORT #this is the same process as with the cancer data, but now with non-cancer data</span></span>
<span id="cb71-163"><a href="score-analysis-set-up.html#cb71-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_defs[<span class="st">&quot;noncancer&quot;</span>][<span class="dv">0</span>] <span class="op">!=</span> <span class="st">&quot;NA&quot;</span>:</span>
<span id="cb71-164"><a href="score-analysis-set-up.html#cb71-164" aria-hidden="true" tabindex="-1"></a>        <span class="co">#t22 = time.time()</span></span>
<span id="cb71-165"><a href="score-analysis-set-up.html#cb71-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[<span class="st">&quot;noncancer&quot;</span>], self_rep[ind,:])):</span>
<span id="cb71-166"><a href="score-analysis-set-up.html#cb71-166" aria-hidden="true" tabindex="-1"></a>            locs <span class="op">=</span> np.where(np.isin(self_rep[ind,:], use_defs[<span class="st">&quot;noncancer&quot;</span>]))[<span class="dv">0</span>]</span>
<span id="cb71-167"><a href="score-analysis-set-up.html#cb71-167" aria-hidden="true" tabindex="-1"></a>            try_date <span class="op">=</span> date_ass[ind, <span class="bu">int</span>(self_phase[locs[<span class="dv">0</span>]])]</span>
<span id="cb71-168"><a href="score-analysis-set-up.html#cb71-168" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> try_date <span class="op">==</span> <span class="st">&quot;&quot;</span>:</span>
<span id="cb71-169"><a href="score-analysis-set-up.html#cb71-169" aria-hidden="true" tabindex="-1"></a>                try_date <span class="op">=</span> date_ass[ind, <span class="dv">0</span>]</span>
<span id="cb71-170"><a href="score-analysis-set-up.html#cb71-170" aria-hidden="true" tabindex="-1"></a>            df_date[ind,<span class="dv">1</span>] <span class="op">=</span> try_date</span>
<span id="cb71-171"><a href="score-analysis-set-up.html#cb71-171" aria-hidden="true" tabindex="-1"></a>            df_occur[ind,<span class="dv">1</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb71-172"><a href="score-analysis-set-up.html#cb71-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-173"><a href="score-analysis-set-up.html#cb71-173" aria-hidden="true" tabindex="-1"></a>        <span class="co">#t3 = time.time()</span></span>
<span id="cb71-174"><a href="score-analysis-set-up.html#cb71-174" aria-hidden="true" tabindex="-1"></a>        <span class="co">#noncancer_sr_time += t3-t22</span></span>
<span id="cb71-175"><a href="score-analysis-set-up.html#cb71-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-176"><a href="score-analysis-set-up.html#cb71-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-177"><a href="score-analysis-set-up.html#cb71-177" aria-hidden="true" tabindex="-1"></a>    <span class="co">#HESIN DIAG</span></span>
<span id="cb71-178"><a href="score-analysis-set-up.html#cb71-178" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> curr_eid <span class="kw">in</span> diag_eid_list: <span class="co">#check if the eid has ever had any ICD codes</span></span>
<span id="cb71-179"><a href="score-analysis-set-up.html#cb71-179" aria-hidden="true" tabindex="-1"></a>        <span class="co">#t4 = time.time()</span></span>
<span id="cb71-180"><a href="score-analysis-set-up.html#cb71-180" aria-hidden="true" tabindex="-1"></a>        <span class="co">#set up the hesin indexing, since multiple rows can have the same eid we use this</span></span>
<span id="cb71-181"><a href="score-analysis-set-up.html#cb71-181" aria-hidden="true" tabindex="-1"></a>        <span class="co">#use this technique to get the index of the next unique EID</span></span>
<span id="cb71-182"><a href="score-analysis-set-up.html#cb71-182" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> curr_eid <span class="op">!=</span> diag_eid_list[<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb71-183"><a href="score-analysis-set-up.html#cb71-183" aria-hidden="true" tabindex="-1"></a>            next_eid <span class="op">=</span> np.unique(diag[start_eid_diag:(start_eid_diag<span class="op">+</span><span class="dv">7000</span>),<span class="dv">0</span>])[<span class="dv">1</span>]</span>
<span id="cb71-184"><a href="score-analysis-set-up.html#cb71-184" aria-hidden="true" tabindex="-1"></a>            ext_eid <span class="op">=</span> diag_eid_list.index(next_eid)</span>
<span id="cb71-185"><a href="score-analysis-set-up.html#cb71-185" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb71-186"><a href="score-analysis-set-up.html#cb71-186" aria-hidden="true" tabindex="-1"></a>            ext_eid <span class="op">=</span> diag_max</span>
<span id="cb71-187"><a href="score-analysis-set-up.html#cb71-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-188"><a href="score-analysis-set-up.html#cb71-188" aria-hidden="true" tabindex="-1"></a>        <span class="co">#t5 = time.time()</span></span>
<span id="cb71-189"><a href="score-analysis-set-up.html#cb71-189" aria-hidden="true" tabindex="-1"></a>        <span class="co">#hesin_setup_time += t5-t4</span></span>
<span id="cb71-190"><a href="score-analysis-set-up.html#cb71-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-191"><a href="score-analysis-set-up.html#cb71-191" aria-hidden="true" tabindex="-1"></a>        <span class="co">#ICD - 9</span></span>
<span id="cb71-192"><a href="score-analysis-set-up.html#cb71-192" aria-hidden="true" tabindex="-1"></a>        <span class="co">#as was explained either the full or slightly shorter ICD code may match what we want, so we create both</span></span>
<span id="cb71-193"><a href="score-analysis-set-up.html#cb71-193" aria-hidden="true" tabindex="-1"></a>        use_short_icd9_diag <span class="op">=</span> [x[<span class="dv">0</span>:<span class="dv">3</span>] <span class="cf">for</span> x <span class="kw">in</span> diag[start_eid_diag:ext_eid,<span class="dv">4</span>]]</span>
<span id="cb71-194"><a href="score-analysis-set-up.html#cb71-194" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Then we check to see if either the short short or long ICD codes (from the hesin) match any of the definitions</span></span>
<span id="cb71-195"><a href="score-analysis-set-up.html#cb71-195" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[<span class="st">&quot;icd9&quot;</span>], use_short_icd9_diag)):</span>
<span id="cb71-196"><a href="score-analysis-set-up.html#cb71-196" aria-hidden="true" tabindex="-1"></a>            <span class="co">#If there is a match we get all of the locations in the hesin of the match</span></span>
<span id="cb71-197"><a href="score-analysis-set-up.html#cb71-197" aria-hidden="true" tabindex="-1"></a>            short_icd9_locs <span class="op">=</span> np.where(np.isin(use_short_icd9_diag, use_defs[<span class="st">&quot;icd9&quot;</span>]))[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb71-198"><a href="score-analysis-set-up.html#cb71-198" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb71-199"><a href="score-analysis-set-up.html#cb71-199" aria-hidden="true" tabindex="-1"></a>            short_icd9_locs <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb71-200"><a href="score-analysis-set-up.html#cb71-200" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[<span class="st">&quot;icd9&quot;</span>], diag[start_eid_diag:ext_eid,<span class="dv">4</span>])):</span>
<span id="cb71-201"><a href="score-analysis-set-up.html#cb71-201" aria-hidden="true" tabindex="-1"></a>                        long_icd9_locs <span class="op">=</span> np.where(np.isin(diag[start_eid_diag:ext_eid,<span class="dv">4</span>], use_defs[<span class="st">&quot;icd9&quot;</span>]))[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb71-202"><a href="score-analysis-set-up.html#cb71-202" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb71-203"><a href="score-analysis-set-up.html#cb71-203" aria-hidden="true" tabindex="-1"></a>            long_icd9_locs <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb71-204"><a href="score-analysis-set-up.html#cb71-204" aria-hidden="true" tabindex="-1"></a>        <span class="co">#There cannot possibly be a match greater than 10000, so I set it to the impossible value</span></span>
<span id="cb71-205"><a href="score-analysis-set-up.html#cb71-205" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> long_icd9_locs <span class="op">!=</span> <span class="dv">10000</span> <span class="kw">or</span> short_icd9_locs <span class="op">!=</span> <span class="dv">10000</span>:</span>
<span id="cb71-206"><a href="score-analysis-set-up.html#cb71-206" aria-hidden="true" tabindex="-1"></a>            <span class="co">#Find the minimum matching location as it is the earliest time</span></span>
<span id="cb71-207"><a href="score-analysis-set-up.html#cb71-207" aria-hidden="true" tabindex="-1"></a>            icd9_locs <span class="op">=</span> <span class="bu">min</span>((long_icd9_locs, short_icd9_locs))</span>
<span id="cb71-208"><a href="score-analysis-set-up.html#cb71-208" aria-hidden="true" tabindex="-1"></a>            <span class="co">#Then we get the instance or the numbered time the EID went to the hospital</span></span>
<span id="cb71-209"><a href="score-analysis-set-up.html#cb71-209" aria-hidden="true" tabindex="-1"></a>            icd9_ins_index <span class="op">=</span> diag[start_eid_diag<span class="op">+</span>icd9_locs,<span class="dv">1</span>]</span>
<span id="cb71-210"><a href="score-analysis-set-up.html#cb71-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-211"><a href="score-analysis-set-up.html#cb71-211" aria-hidden="true" tabindex="-1"></a>            <span class="co">#We carry the ins_index and EID to the larger hesin array to get the date</span></span>
<span id="cb71-212"><a href="score-analysis-set-up.html#cb71-212" aria-hidden="true" tabindex="-1"></a>            <span class="co">#Somtimes the most accurate form of the date is empty so we go to the next best</span></span>
<span id="cb71-213"><a href="score-analysis-set-up.html#cb71-213" aria-hidden="true" tabindex="-1"></a>            raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> icd9_ins_index),<span class="dv">5</span>][<span class="dv">0</span>]</span>
<span id="cb71-214"><a href="score-analysis-set-up.html#cb71-214" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> raw_date <span class="op">==</span> <span class="st">&quot;&quot;</span>:</span>
<span id="cb71-215"><a href="score-analysis-set-up.html#cb71-215" aria-hidden="true" tabindex="-1"></a>                raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> icd9_ins_index),<span class="dv">21</span>][<span class="dv">0</span>]</span>
<span id="cb71-216"><a href="score-analysis-set-up.html#cb71-216" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> raw_date <span class="op">==</span> <span class="st">&quot;&quot;</span>:</span>
<span id="cb71-217"><a href="score-analysis-set-up.html#cb71-217" aria-hidden="true" tabindex="-1"></a>                    raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> icd9_ins_index),<span class="dv">4</span>][<span class="dv">0</span>]</span>
<span id="cb71-218"><a href="score-analysis-set-up.html#cb71-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-219"><a href="score-analysis-set-up.html#cb71-219" aria-hidden="true" tabindex="-1"></a>            df_occur[ind,<span class="dv">2</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb71-220"><a href="score-analysis-set-up.html#cb71-220" aria-hidden="true" tabindex="-1"></a>            df_date[ind,<span class="dv">2</span>] <span class="op">=</span> raw_date</span>
<span id="cb71-221"><a href="score-analysis-set-up.html#cb71-221" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb71-222"><a href="score-analysis-set-up.html#cb71-222" aria-hidden="true" tabindex="-1"></a>        <span class="co">#t6 = time.time()</span></span>
<span id="cb71-223"><a href="score-analysis-set-up.html#cb71-223" aria-hidden="true" tabindex="-1"></a>        <span class="co">#icd9_time += t6-t5</span></span>
<span id="cb71-224"><a href="score-analysis-set-up.html#cb71-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-225"><a href="score-analysis-set-up.html#cb71-225" aria-hidden="true" tabindex="-1"></a>        <span class="co">#The process for ICD10 is nearly exactly the same as for ICD9</span></span>
<span id="cb71-226"><a href="score-analysis-set-up.html#cb71-226" aria-hidden="true" tabindex="-1"></a>        <span class="co">#ICD - 10</span></span>
<span id="cb71-227"><a href="score-analysis-set-up.html#cb71-227" aria-hidden="true" tabindex="-1"></a>        use_short_icd10_diag <span class="op">=</span> [x[<span class="dv">0</span>:<span class="dv">3</span>] <span class="cf">for</span> x <span class="kw">in</span> diag[start_eid_diag:ext_eid,<span class="dv">6</span>]]</span>
<span id="cb71-228"><a href="score-analysis-set-up.html#cb71-228" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[<span class="st">&quot;icd10&quot;</span>], use_short_icd10_diag)):</span>
<span id="cb71-229"><a href="score-analysis-set-up.html#cb71-229" aria-hidden="true" tabindex="-1"></a>            short_icd10_locs <span class="op">=</span> np.where(np.isin(use_short_icd10_diag, use_defs[<span class="st">&quot;icd10&quot;</span>]))[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb71-230"><a href="score-analysis-set-up.html#cb71-230" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb71-231"><a href="score-analysis-set-up.html#cb71-231" aria-hidden="true" tabindex="-1"></a>            short_icd10_locs <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb71-232"><a href="score-analysis-set-up.html#cb71-232" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[<span class="st">&quot;icd10&quot;</span>], diag[start_eid_diag:ext_eid,<span class="dv">6</span>])):</span>
<span id="cb71-233"><a href="score-analysis-set-up.html#cb71-233" aria-hidden="true" tabindex="-1"></a>            long_icd10_locs <span class="op">=</span> np.where(np.isin(diag[start_eid_diag:ext_eid,<span class="dv">6</span>], use_defs[<span class="st">&quot;icd10&quot;</span>]))[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb71-234"><a href="score-analysis-set-up.html#cb71-234" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb71-235"><a href="score-analysis-set-up.html#cb71-235" aria-hidden="true" tabindex="-1"></a>            long_icd10_locs <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb71-236"><a href="score-analysis-set-up.html#cb71-236" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> long_icd10_locs <span class="op">!=</span> <span class="dv">10000</span> <span class="kw">or</span> short_icd10_locs <span class="op">!=</span> <span class="dv">10000</span>:</span>
<span id="cb71-237"><a href="score-analysis-set-up.html#cb71-237" aria-hidden="true" tabindex="-1"></a>            icd10_locs <span class="op">=</span> <span class="bu">min</span>((long_icd10_locs, short_icd10_locs))</span>
<span id="cb71-238"><a href="score-analysis-set-up.html#cb71-238" aria-hidden="true" tabindex="-1"></a>            icd10_ins_index <span class="op">=</span> diag[start_eid_diag<span class="op">+</span>icd10_locs,<span class="dv">1</span>]</span>
<span id="cb71-239"><a href="score-analysis-set-up.html#cb71-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-240"><a href="score-analysis-set-up.html#cb71-240" aria-hidden="true" tabindex="-1"></a>            raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> icd10_ins_index),<span class="dv">5</span>][<span class="dv">0</span>]</span>
<span id="cb71-241"><a href="score-analysis-set-up.html#cb71-241" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> raw_date <span class="op">==</span> <span class="st">&quot;&quot;</span>:</span>
<span id="cb71-242"><a href="score-analysis-set-up.html#cb71-242" aria-hidden="true" tabindex="-1"></a>                raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> icd10_ins_index),<span class="dv">21</span>][<span class="dv">0</span>]</span>
<span id="cb71-243"><a href="score-analysis-set-up.html#cb71-243" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> raw_date <span class="op">==</span> <span class="st">&quot;&quot;</span>:</span>
<span id="cb71-244"><a href="score-analysis-set-up.html#cb71-244" aria-hidden="true" tabindex="-1"></a>                    raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> icd10_ins_index),<span class="dv">4</span>][<span class="dv">0</span>]</span>
<span id="cb71-245"><a href="score-analysis-set-up.html#cb71-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-246"><a href="score-analysis-set-up.html#cb71-246" aria-hidden="true" tabindex="-1"></a>            df_occur[ind,<span class="dv">3</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb71-247"><a href="score-analysis-set-up.html#cb71-247" aria-hidden="true" tabindex="-1"></a>            df_date[ind,<span class="dv">3</span>] <span class="op">=</span> raw_date</span>
<span id="cb71-248"><a href="score-analysis-set-up.html#cb71-248" aria-hidden="true" tabindex="-1"></a>        start_eid_diag <span class="op">=</span> ext_eid</span>
<span id="cb71-249"><a href="score-analysis-set-up.html#cb71-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-250"><a href="score-analysis-set-up.html#cb71-250" aria-hidden="true" tabindex="-1"></a>        <span class="co">#t7 = time.time()</span></span>
<span id="cb71-251"><a href="score-analysis-set-up.html#cb71-251" aria-hidden="true" tabindex="-1"></a>        <span class="co">#icd10_time += t7-t6</span></span>
<span id="cb71-252"><a href="score-analysis-set-up.html#cb71-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-253"><a href="score-analysis-set-up.html#cb71-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-254"><a href="score-analysis-set-up.html#cb71-254" aria-hidden="true" tabindex="-1"></a>    <span class="co">#The process for HESIN OPER is nearly exactly the same as for HESIN DIAG (which includes ICD10 and ICD))</span></span>
<span id="cb71-255"><a href="score-analysis-set-up.html#cb71-255" aria-hidden="true" tabindex="-1"></a>    <span class="co">#HESIN OPER</span></span>
<span id="cb71-256"><a href="score-analysis-set-up.html#cb71-256" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> curr_eid <span class="kw">in</span> oper_eid_list <span class="kw">and</span> use_defs[<span class="st">&quot;opcs&quot;</span>][<span class="dv">0</span>] <span class="op">!=</span> <span class="st">&quot;NA&quot;</span>:</span>
<span id="cb71-257"><a href="score-analysis-set-up.html#cb71-257" aria-hidden="true" tabindex="-1"></a>        <span class="co">#t8 = time.time()</span></span>
<span id="cb71-258"><a href="score-analysis-set-up.html#cb71-258" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> curr_eid <span class="op">!=</span> oper_eid_list[<span class="op">-</span><span class="dv">1</span>]: <span class="co">#if it is not the last in the list</span></span>
<span id="cb71-259"><a href="score-analysis-set-up.html#cb71-259" aria-hidden="true" tabindex="-1"></a>            next_eid <span class="op">=</span> np.unique(oper[start_eid_oper:(start_eid_oper<span class="op">+</span><span class="dv">7000</span>),<span class="dv">0</span>])[<span class="dv">1</span>]</span>
<span id="cb71-260"><a href="score-analysis-set-up.html#cb71-260" aria-hidden="true" tabindex="-1"></a>            ext_eid <span class="op">=</span> oper_eid_list.index(next_eid)</span>
<span id="cb71-261"><a href="score-analysis-set-up.html#cb71-261" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb71-262"><a href="score-analysis-set-up.html#cb71-262" aria-hidden="true" tabindex="-1"></a>            ext_eid <span class="op">=</span> oper_max</span>
<span id="cb71-263"><a href="score-analysis-set-up.html#cb71-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-264"><a href="score-analysis-set-up.html#cb71-264" aria-hidden="true" tabindex="-1"></a>        use_short_oper <span class="op">=</span> [x[<span class="dv">0</span>:<span class="dv">3</span>] <span class="cf">for</span> x <span class="kw">in</span> oper[start_eid_oper:ext_eid,<span class="dv">7</span>]]</span>
<span id="cb71-265"><a href="score-analysis-set-up.html#cb71-265" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[<span class="st">&quot;opcs&quot;</span>], use_short_oper)):</span>
<span id="cb71-266"><a href="score-analysis-set-up.html#cb71-266" aria-hidden="true" tabindex="-1"></a>            short_oper_locs <span class="op">=</span> np.where(np.isin(use_short_oper, use_defs[<span class="st">&quot;opcs&quot;</span>]))[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb71-267"><a href="score-analysis-set-up.html#cb71-267" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb71-268"><a href="score-analysis-set-up.html#cb71-268" aria-hidden="true" tabindex="-1"></a>            short_oper_locs <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb71-269"><a href="score-analysis-set-up.html#cb71-269" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[<span class="st">&quot;opcs&quot;</span>], oper[start_eid_oper:ext_eid,<span class="dv">7</span>])):</span>
<span id="cb71-270"><a href="score-analysis-set-up.html#cb71-270" aria-hidden="true" tabindex="-1"></a>            long_oper_locs <span class="op">=</span> np.where(np.isin(oper[start_eid_oper:ext_eid,<span class="dv">7</span>], use_defs[<span class="st">&quot;opcs&quot;</span>]))[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb71-271"><a href="score-analysis-set-up.html#cb71-271" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb71-272"><a href="score-analysis-set-up.html#cb71-272" aria-hidden="true" tabindex="-1"></a>            long_oper_locs <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb71-273"><a href="score-analysis-set-up.html#cb71-273" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> long_oper_locs <span class="op">!=</span> <span class="dv">10000</span> <span class="kw">or</span> short_oper_locs <span class="op">!=</span> <span class="dv">10000</span>:</span>
<span id="cb71-274"><a href="score-analysis-set-up.html#cb71-274" aria-hidden="true" tabindex="-1"></a>            oper_locs <span class="op">=</span> <span class="bu">min</span>((long_oper_locs, short_oper_locs))</span>
<span id="cb71-275"><a href="score-analysis-set-up.html#cb71-275" aria-hidden="true" tabindex="-1"></a>            oper_ins_index <span class="op">=</span> oper[start_eid_oper<span class="op">+</span>oper_locs,<span class="dv">1</span>]</span>
<span id="cb71-276"><a href="score-analysis-set-up.html#cb71-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-277"><a href="score-analysis-set-up.html#cb71-277" aria-hidden="true" tabindex="-1"></a>            raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> oper_ins_index),<span class="dv">5</span>][<span class="dv">0</span>]</span>
<span id="cb71-278"><a href="score-analysis-set-up.html#cb71-278" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> raw_date <span class="op">==</span> <span class="st">&quot;&quot;</span>:</span>
<span id="cb71-279"><a href="score-analysis-set-up.html#cb71-279" aria-hidden="true" tabindex="-1"></a>                raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> oper_ins_index),<span class="dv">21</span>][<span class="dv">0</span>]</span>
<span id="cb71-280"><a href="score-analysis-set-up.html#cb71-280" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> raw_date <span class="op">==</span> <span class="st">&quot;&quot;</span>:</span>
<span id="cb71-281"><a href="score-analysis-set-up.html#cb71-281" aria-hidden="true" tabindex="-1"></a>                    raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> oper_ins_index),<span class="dv">4</span>][<span class="dv">0</span>]</span>
<span id="cb71-282"><a href="score-analysis-set-up.html#cb71-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-283"><a href="score-analysis-set-up.html#cb71-283" aria-hidden="true" tabindex="-1"></a>            df_occur[ind,<span class="dv">4</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb71-284"><a href="score-analysis-set-up.html#cb71-284" aria-hidden="true" tabindex="-1"></a>            df_date[ind,<span class="dv">4</span>] <span class="op">=</span> raw_date</span>
<span id="cb71-285"><a href="score-analysis-set-up.html#cb71-285" aria-hidden="true" tabindex="-1"></a>        start_eid_oper <span class="op">=</span> ext_eid</span>
<span id="cb71-286"><a href="score-analysis-set-up.html#cb71-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-287"><a href="score-analysis-set-up.html#cb71-287" aria-hidden="true" tabindex="-1"></a>        <span class="co">#t9 = time.time()</span></span>
<span id="cb71-288"><a href="score-analysis-set-up.html#cb71-288" aria-hidden="true" tabindex="-1"></a>        <span class="co">#hesin_oper_time += t9-t8</span></span>
<span id="cb71-289"><a href="score-analysis-set-up.html#cb71-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-290"><a href="score-analysis-set-up.html#cb71-290" aria-hidden="true" tabindex="-1"></a>    <span class="co">#The medication process is nearly the same as for cancer and non-cancer</span></span>
<span id="cb71-291"><a href="score-analysis-set-up.html#cb71-291" aria-hidden="true" tabindex="-1"></a>    <span class="co">#MEDICATION</span></span>
<span id="cb71-292"><a href="score-analysis-set-up.html#cb71-292" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_defs[<span class="st">&quot;meds&quot;</span>][<span class="dv">0</span>] <span class="op">!=</span> <span class="st">&quot;NA&quot;</span>:</span>
<span id="cb71-293"><a href="score-analysis-set-up.html#cb71-293" aria-hidden="true" tabindex="-1"></a>        <span class="co">#t10 = time.time()</span></span>
<span id="cb71-294"><a href="score-analysis-set-up.html#cb71-294" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[<span class="st">&quot;meds&quot;</span>], meds[ind,:])):</span>
<span id="cb71-295"><a href="score-analysis-set-up.html#cb71-295" aria-hidden="true" tabindex="-1"></a>            locs <span class="op">=</span> np.where(np.isin(meds[ind,:], use_defs[<span class="st">&quot;meds&quot;</span>]))[<span class="dv">0</span>]</span>
<span id="cb71-296"><a href="score-analysis-set-up.html#cb71-296" aria-hidden="true" tabindex="-1"></a>            df_date[ind,<span class="dv">5</span>] <span class="op">=</span> date_ass[ind, <span class="bu">int</span>(meds_phase[locs[<span class="dv">0</span>]])]</span>
<span id="cb71-297"><a href="score-analysis-set-up.html#cb71-297" aria-hidden="true" tabindex="-1"></a>            df_occur[ind,<span class="dv">5</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb71-298"><a href="score-analysis-set-up.html#cb71-298" aria-hidden="true" tabindex="-1"></a>        <span class="co">#t11 = time.time()</span></span>
<span id="cb71-299"><a href="score-analysis-set-up.html#cb71-299" aria-hidden="true" tabindex="-1"></a>        <span class="co">#med_time += t11 - t10</span></span>
<span id="cb71-300"><a href="score-analysis-set-up.html#cb71-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-301"><a href="score-analysis-set-up.html#cb71-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-302"><a href="score-analysis-set-up.html#cb71-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-303"><a href="score-analysis-set-up.html#cb71-303" aria-hidden="true" tabindex="-1"></a><span class="co">#save the output phenos</span></span>
<span id="cb71-304"><a href="score-analysis-set-up.html#cb71-304" aria-hidden="true" tabindex="-1"></a>np.savetxt(<span class="st">&quot;raw_output/diag.coding.&quot;</span> <span class="op">+</span> author.lower() <span class="op">+</span> <span class="st">&quot;.&quot;</span> <span class="op">+</span> <span class="bu">str</span>(start_ind) <span class="op">+</span> <span class="st">&quot;.txt.gz&quot;</span>, df_occur, fmt<span class="op">=</span><span class="st">&#39;</span><span class="sc">%i</span><span class="st">&#39;</span>)</span>
<span id="cb71-305"><a href="score-analysis-set-up.html#cb71-305" aria-hidden="true" tabindex="-1"></a>np.savetxt(<span class="st">&quot;raw_output/diag.time.&quot;</span> <span class="op">+</span> author.lower() <span class="op">+</span> <span class="st">&quot;.&quot;</span> <span class="op">+</span> <span class="bu">str</span>(start_ind) <span class="op">+</span> <span class="st">&quot;.txt.gz&quot;</span>, df_date, fmt<span class="op">=</span><span class="st">&#39;</span><span class="sc">%s</span><span class="st">&#39;</span>)</span>
<span id="cb71-306"><a href="score-analysis-set-up.html#cb71-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-307"><a href="score-analysis-set-up.html#cb71-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-308"><a href="score-analysis-set-up.html#cb71-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-309"><a href="score-analysis-set-up.html#cb71-309" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;end&quot;</span>)</span></code></pre></div>
<p>The final step in the process is combining all of the small subset phenotype file into one large phenotype file. The mechanics of this script are very simple, as all that needs to be done is iterating over the subsets and concatenating them together.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb72-1"><a href="score-analysis-set-up.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> raw_output/ <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-f3</span> <span class="at">-d</span><span class="st">&#39;.&#39;</span> <span class="kw">|</span> <span class="fu">sort</span> <span class="kw">|</span> <span class="fu">uniq</span> <span class="kw">|</span> <span class="cf">while</span> <span class="bu">read</span> <span class="va">author</span><span class="kw">;</span><span class="cf">do</span></span>
<span id="cb72-2"><a href="score-analysis-set-up.html#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span> pheno_defs/diag.<span class="va">${author}</span>.txt.gz</span>
<span id="cb72-3"><a href="score-analysis-set-up.html#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span> pheno_defs/time.<span class="va">${author}</span>.txt.gz</span>
<span id="cb72-4"><a href="score-analysis-set-up.html#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ls</span> raw_output/diag.coding.<span class="va">${author}</span><span class="pp">*</span> <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-f2</span> <span class="at">-d</span><span class="st">&#39;/&#39;</span> <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-f4</span> <span class="at">-d</span><span class="st">&#39;.&#39;</span> <span class="kw">|</span> <span class="fu">sort</span> <span class="at">-n</span> <span class="kw">|</span> <span class="cf">while</span> <span class="bu">read</span> <span class="va">num</span><span class="kw">;</span><span class="cf">do</span></span>
<span id="cb72-5"><a href="score-analysis-set-up.html#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">zcat</span> raw_output/diag.coding.<span class="va">${author}</span>.<span class="va">${num}</span>.txt.gz <span class="op">&gt;&gt;</span> pheno_defs/diag.<span class="va">${author}</span>.txt</span>
<span id="cb72-6"><a href="score-analysis-set-up.html#cb72-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">zcat</span> raw_output/diag.time.<span class="va">${author}</span>.<span class="va">${num}</span>.txt.gz <span class="op">&gt;&gt;</span> pheno_defs/time.<span class="va">${author}</span>.txt</span>
<span id="cb72-7"><a href="score-analysis-set-up.html#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">done</span></span>
<span id="cb72-8"><a href="score-analysis-set-up.html#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gzip</span> pheno_defs/diag.<span class="va">${author}</span>.txt</span>
<span id="cb72-9"><a href="score-analysis-set-up.html#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gzip</span> pheno_defs/time.<span class="va">${author}</span>.txt</span>
<span id="cb72-10"><a href="score-analysis-set-up.html#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p>The final output are two files for each phenotype. Both files contain six columns for each different defintion type, and 502,535 rows for each individual. One file will either contain 0’s and 1’s for no phenotype present or yes phenotype present. The other file will have a series of dahes where there is a 0 in the corresponding file, and the date the phenotype started where there are 1’s in the corresponding file.</p>
</div>
<div id="other-scores" class="section level2" number="7.3">
<h2><span class="header-section-number">7.3</span> Other Scores</h2>
<p>To evaluate the prior methods against more curated scores I will downloaded scoring summary statistics and creating scores here. The problem, with this aim is that scoring summary statistics are often hard to find and come in various formats that are difficult to standardize. For example scoring summary statistics are often not located within figures, may not contain rsIDs or genome reference, may not label the type of effect or be saved in a difficult format. Luckily a great resource has come into existence recently called PGS Catalog, <a href="https://www.pgscatalog.org/browse/all/" class="uri">https://www.pgscatalog.org/browse/all/</a>. My idea to ensure that the other scores I create are all reasonable is that I will only use scores within PGS Catalog. While there are other scores that I probably could access, I think this is a good compromise to keep things accurate while still carrying out the mission of checking on other scores (and just maybe this will motivate people to upload their scoring summary statistics to PGS catalog with all of the important information nescessary to recreate).</p>
<p>To get the scoring summary statistics I simply searched for all of the phenotypes that I am researching within the PGS Catalog. I checked all available scores to ensure they were not derived from the UK Biobank. I then saved the name of the all the scores that met both of these requirements. Then iterating through the list each score was downloaded with a call to wget and the address <a href="http://ftp.ebi.ac.uk/pub/databases/spot/pgs/scores/%7BSCORING_NAME%7D/ScoringFiles/%7BSCORING_NAME%7D.txt.gz" class="uri">http://ftp.ebi.ac.uk/pub/databases/spot/pgs/scores/{SCORING_NAME}/ScoringFiles/{SCORING_NAME}.txt.gz</a>. Each of the summary statistics then had to be checked just as the summary statistics from GWAS Catalog were. The process is rather similar to before, making sure that the rsIDs in the score exist within the UK Biobank, removing ambigous SNPs and flipping SNPs where nescessary. The full script looks like:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="score-analysis-set-up.html#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vroom)</span>
<span id="cb73-2"><a href="score-analysis-set-up.html#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb73-3"><a href="score-analysis-set-up.html#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bigsnpr)</span>
<span id="cb73-4"><a href="score-analysis-set-up.html#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="score-analysis-set-up.html#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">warn=</span><span class="dv">2</span>)</span>
<span id="cb73-6"><a href="score-analysis-set-up.html#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="score-analysis-set-up.html#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Read in the UKBB summary statistics</span></span>
<span id="cb73-8"><a href="score-analysis-set-up.html#cb73-8" aria-hidden="true" tabindex="-1"></a>impute <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;../../raw_ss/common_files/impute_rsids&quot;</span>, <span class="at">header =</span> F, <span class="at">stringsAsFactors =</span> F)</span>
<span id="cb73-9"><a href="score-analysis-set-up.html#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(impute) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;LOC&quot;</span>, <span class="st">&quot;SNP&quot;</span>, <span class="st">&quot;POS&quot;</span>, <span class="st">&quot;A1&quot;</span>, <span class="st">&quot;A2&quot;</span>, <span class="st">&quot;MAF&quot;</span>, <span class="st">&quot;AX&quot;</span>, <span class="st">&quot;INFO&quot;</span>)</span>
<span id="cb73-10"><a href="score-analysis-set-up.html#cb73-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-11"><a href="score-analysis-set-up.html#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Make sure the UKBB summary statistics have alleles that match ACGT and are not ambigous</span></span>
<span id="cb73-12"><a href="score-analysis-set-up.html#cb73-12" aria-hidden="true" tabindex="-1"></a>impute <span class="ot">&lt;-</span> impute[<span class="fu">nchar</span>(impute<span class="sc">$</span>A1) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="fu">nchar</span>(impute<span class="sc">$</span>A2) <span class="sc">==</span> <span class="dv">1</span>,]</span>
<span id="cb73-13"><a href="score-analysis-set-up.html#cb73-13" aria-hidden="true" tabindex="-1"></a>impute <span class="ot">&lt;-</span> impute[impute<span class="sc">$</span>A1 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;C&quot;</span>, <span class="st">&quot;G&quot;</span>, <span class="st">&quot;T&quot;</span>) <span class="sc">&amp;</span> impute<span class="sc">$</span>A2 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;C&quot;</span>, <span class="st">&quot;G&quot;</span>, <span class="st">&quot;T&quot;</span>),]</span>
<span id="cb73-14"><a href="score-analysis-set-up.html#cb73-14" aria-hidden="true" tabindex="-1"></a>impute <span class="ot">&lt;-</span> impute[<span class="sc">!</span>((impute<span class="sc">$</span>A1 <span class="sc">==</span> <span class="st">&quot;A&quot;</span> <span class="sc">&amp;</span> impute<span class="sc">$</span>A2 <span class="sc">==</span> <span class="st">&quot;T&quot;</span>) <span class="sc">|</span></span>
<span id="cb73-15"><a href="score-analysis-set-up.html#cb73-15" aria-hidden="true" tabindex="-1"></a>             (impute<span class="sc">$</span>A1 <span class="sc">==</span> <span class="st">&quot;T&quot;</span> <span class="sc">&amp;</span> impute<span class="sc">$</span>A2 <span class="sc">==</span> <span class="st">&quot;A&quot;</span>) <span class="sc">|</span></span>
<span id="cb73-16"><a href="score-analysis-set-up.html#cb73-16" aria-hidden="true" tabindex="-1"></a>             (impute<span class="sc">$</span>A1 <span class="sc">==</span> <span class="st">&quot;G&quot;</span> <span class="sc">&amp;</span> impute<span class="sc">$</span>A2 <span class="sc">==</span> <span class="st">&quot;C&quot;</span>) <span class="sc">|</span></span>
<span id="cb73-17"><a href="score-analysis-set-up.html#cb73-17" aria-hidden="true" tabindex="-1"></a>             (impute<span class="sc">$</span>A1 <span class="sc">==</span> <span class="st">&quot;C&quot;</span> <span class="sc">&amp;</span> impute<span class="sc">$</span>A2 <span class="sc">==</span> <span class="st">&quot;G&quot;</span>)),]</span>
<span id="cb73-18"><a href="score-analysis-set-up.html#cb73-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-19"><a href="score-analysis-set-up.html#cb73-19" aria-hidden="true" tabindex="-1"></a><span class="co">#Read in other UKBB data that comes with chromosomes so I can give a chromosome to each SNP</span></span>
<span id="cb73-20"><a href="score-analysis-set-up.html#cb73-20" aria-hidden="true" tabindex="-1"></a>impute<span class="sc">$</span>CHR <span class="ot">&lt;-</span> <span class="st">&quot;X&quot;</span></span>
<span id="cb73-21"><a href="score-analysis-set-up.html#cb73-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">22</span>){</span>
<span id="cb73-22"><a href="score-analysis-set-up.html#cb73-22" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">&quot;~/athena/ukbiobank/qc/imputed/chr&quot;</span>, i, <span class="st">&quot;.RDS&quot;</span>))</span>
<span id="cb73-23"><a href="score-analysis-set-up.html#cb73-23" aria-hidden="true" tabindex="-1"></a>  impute<span class="sc">$</span>CHR[impute<span class="sc">$</span>SNP <span class="sc">%in%</span> temp[,<span class="dv">2</span>]] <span class="ot">&lt;-</span> i</span>
<span id="cb73-24"><a href="score-analysis-set-up.html#cb73-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb73-25"><a href="score-analysis-set-up.html#cb73-25" aria-hidden="true" tabindex="-1"></a>impute <span class="ot">&lt;-</span> impute[impute<span class="sc">$</span>CHR <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">22</span>,]</span>
<span id="cb73-26"><a href="score-analysis-set-up.html#cb73-26" aria-hidden="true" tabindex="-1"></a>impute<span class="sc">$</span>SUPERPOS <span class="ot">&lt;-</span> <span class="fu">paste0</span>(impute<span class="sc">$</span>CHR, <span class="st">&quot;_&quot;</span>, impute<span class="sc">$</span>POS)</span>
<span id="cb73-27"><a href="score-analysis-set-up.html#cb73-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-28"><a href="score-analysis-set-up.html#cb73-28" aria-hidden="true" tabindex="-1"></a><span class="co">#Now iterating through each of the score summary statistics</span></span>
<span id="cb73-29"><a href="score-analysis-set-up.html#cb73-29" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb73-30"><a href="score-analysis-set-up.html#cb73-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(filename <span class="cf">in</span> <span class="fu">list.files</span>(<span class="st">&quot;raw_other_ss/&quot;</span>)){</span>
<span id="cb73-31"><a href="score-analysis-set-up.html#cb73-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">#read the summary statistic in</span></span>
<span id="cb73-32"><a href="score-analysis-set-up.html#cb73-32" aria-hidden="true" tabindex="-1"></a>  ss <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">paste0</span>(<span class="st">&quot;raw_other_ss/&quot;</span>, filename), <span class="at">stringsAsFactors=</span>F, <span class="at">header=</span>T, <span class="at">sep=</span><span class="st">&#39;</span><span class="sc">\t</span><span class="st">&#39;</span>)</span>
<span id="cb73-33"><a href="score-analysis-set-up.html#cb73-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-34"><a href="score-analysis-set-up.html#cb73-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">#require both a column for major and minor allele, if only one exists refining is not possible</span></span>
<span id="cb73-35"><a href="score-analysis-set-up.html#cb73-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">&quot;effect_allele&quot;</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(ss) <span class="sc">&amp;</span> <span class="st">&quot;reference_allele&quot;</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(ss)){</span>
<span id="cb73-36"><a href="score-analysis-set-up.html#cb73-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-37"><a href="score-analysis-set-up.html#cb73-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">#limit SNPs to those with ACGT</span></span>
<span id="cb73-38"><a href="score-analysis-set-up.html#cb73-38" aria-hidden="true" tabindex="-1"></a>    ss<span class="sc">$</span>effect_allele <span class="ot">&lt;-</span> <span class="fu">toupper</span>(ss<span class="sc">$</span>effect_allele)</span>
<span id="cb73-39"><a href="score-analysis-set-up.html#cb73-39" aria-hidden="true" tabindex="-1"></a>    ss<span class="sc">$</span>reference_allele <span class="ot">&lt;-</span> <span class="fu">toupper</span>(ss<span class="sc">$</span>reference_allele)</span>
<span id="cb73-40"><a href="score-analysis-set-up.html#cb73-40" aria-hidden="true" tabindex="-1"></a>    ss <span class="ot">&lt;-</span> ss[<span class="fu">nchar</span>(ss<span class="sc">$</span>effect_allele) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="fu">nchar</span>(ss<span class="sc">$</span>reference_allele) <span class="sc">==</span> <span class="dv">1</span>,]</span>
<span id="cb73-41"><a href="score-analysis-set-up.html#cb73-41" aria-hidden="true" tabindex="-1"></a>    ss <span class="ot">&lt;-</span> ss[ss<span class="sc">$</span>effect_allele <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;C&quot;</span>, <span class="st">&quot;G&quot;</span>, <span class="st">&quot;T&quot;</span>) <span class="sc">&amp;</span> ss<span class="sc">$</span>reference_allele <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;C&quot;</span>, <span class="st">&quot;G&quot;</span>, <span class="st">&quot;T&quot;</span>),]</span>
<span id="cb73-42"><a href="score-analysis-set-up.html#cb73-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-43"><a href="score-analysis-set-up.html#cb73-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">#remove ambigous SNPs</span></span>
<span id="cb73-44"><a href="score-analysis-set-up.html#cb73-44" aria-hidden="true" tabindex="-1"></a>    ss <span class="ot">&lt;-</span> ss[<span class="sc">!</span>((ss<span class="sc">$</span>effect_allele <span class="sc">==</span> <span class="st">&quot;A&quot;</span> <span class="sc">&amp;</span> ss<span class="sc">$</span>reference_allele <span class="sc">==</span> <span class="st">&quot;T&quot;</span>) <span class="sc">|</span></span>
<span id="cb73-45"><a href="score-analysis-set-up.html#cb73-45" aria-hidden="true" tabindex="-1"></a>               (ss<span class="sc">$</span>effect_allele <span class="sc">==</span> <span class="st">&quot;T&quot;</span> <span class="sc">&amp;</span> ss<span class="sc">$</span>reference_allele <span class="sc">==</span> <span class="st">&quot;A&quot;</span>) <span class="sc">|</span></span>
<span id="cb73-46"><a href="score-analysis-set-up.html#cb73-46" aria-hidden="true" tabindex="-1"></a>               (ss<span class="sc">$</span>effect_allele <span class="sc">==</span> <span class="st">&quot;G&quot;</span> <span class="sc">&amp;</span> ss<span class="sc">$</span>reference_allele <span class="sc">==</span> <span class="st">&quot;C&quot;</span>) <span class="sc">|</span></span>
<span id="cb73-47"><a href="score-analysis-set-up.html#cb73-47" aria-hidden="true" tabindex="-1"></a>               (ss<span class="sc">$</span>effect_allele <span class="sc">==</span> <span class="st">&quot;C&quot;</span> <span class="sc">&amp;</span> ss<span class="sc">$</span>reference_allele <span class="sc">==</span> <span class="st">&quot;G&quot;</span>)),]</span>
<span id="cb73-48"><a href="score-analysis-set-up.html#cb73-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-49"><a href="score-analysis-set-up.html#cb73-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">#if rsID in the ss use it to match and sort to the UKBB</span></span>
<span id="cb73-50"><a href="score-analysis-set-up.html#cb73-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">#if not then use the chromosome and position (I already checked that all scores&#39; ref genomes match UKBB)</span></span>
<span id="cb73-51"><a href="score-analysis-set-up.html#cb73-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="st">&quot;rsID&quot;</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(ss)){</span>
<span id="cb73-52"><a href="score-analysis-set-up.html#cb73-52" aria-hidden="true" tabindex="-1"></a>      ss <span class="ot">&lt;-</span> ss[<span class="sc">!</span><span class="fu">is.na</span>(ss<span class="sc">$</span>rsID),]</span>
<span id="cb73-53"><a href="score-analysis-set-up.html#cb73-53" aria-hidden="true" tabindex="-1"></a>      ss<span class="sc">$</span>rsID <span class="ot">&lt;-</span> <span class="fu">tolower</span>(ss<span class="sc">$</span>rsID)</span>
<span id="cb73-54"><a href="score-analysis-set-up.html#cb73-54" aria-hidden="true" tabindex="-1"></a>      ss <span class="ot">&lt;-</span> ss[ss<span class="sc">$</span>rsID <span class="sc">%in%</span> impute<span class="sc">$</span>SNP,]</span>
<span id="cb73-55"><a href="score-analysis-set-up.html#cb73-55" aria-hidden="true" tabindex="-1"></a>      sub_impute <span class="ot">&lt;-</span> impute[impute<span class="sc">$</span>SNP <span class="sc">%in%</span> ss<span class="sc">$</span>rsID,]</span>
<span id="cb73-56"><a href="score-analysis-set-up.html#cb73-56" aria-hidden="true" tabindex="-1"></a>      ss <span class="ot">&lt;-</span> ss[<span class="fu">order</span>(ss<span class="sc">$</span>rsID)[<span class="fu">rank</span>(sub_impute<span class="sc">$</span>SNP)],]</span>
<span id="cb73-57"><a href="score-analysis-set-up.html#cb73-57" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb73-58"><a href="score-analysis-set-up.html#cb73-58" aria-hidden="true" tabindex="-1"></a>      ss<span class="sc">$</span>SUPERPOS <span class="ot">&lt;-</span> <span class="fu">paste0</span>(ss<span class="sc">$</span>chr_name, <span class="st">&quot;_&quot;</span>, ss<span class="sc">$</span>chr_position)</span>
<span id="cb73-59"><a href="score-analysis-set-up.html#cb73-59" aria-hidden="true" tabindex="-1"></a>      ss <span class="ot">&lt;-</span> ss[ss<span class="sc">$</span>SUPERPOS <span class="sc">%in%</span> impute<span class="sc">$</span>SUPERPOS,]</span>
<span id="cb73-60"><a href="score-analysis-set-up.html#cb73-60" aria-hidden="true" tabindex="-1"></a>      sub_impute <span class="ot">&lt;-</span> impute[impute<span class="sc">$</span>SUPERPOS <span class="sc">%in%</span> ss<span class="sc">$</span>SUPERPOS,]</span>
<span id="cb73-61"><a href="score-analysis-set-up.html#cb73-61" aria-hidden="true" tabindex="-1"></a>      ss <span class="ot">&lt;-</span> ss[<span class="fu">order</span>(ss<span class="sc">$</span>SUPERPOS)[<span class="fu">rank</span>(sub_impute<span class="sc">$</span>SUPERPOS)],]</span>
<span id="cb73-62"><a href="score-analysis-set-up.html#cb73-62" aria-hidden="true" tabindex="-1"></a>      ss<span class="sc">$</span>rsID <span class="ot">&lt;-</span> sub_impute<span class="sc">$</span>SNP    </span>
<span id="cb73-63"><a href="score-analysis-set-up.html#cb73-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb73-64"><a href="score-analysis-set-up.html#cb73-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-65"><a href="score-analysis-set-up.html#cb73-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Change the column names and then use the snp_match function from bigsnpr to flip alleles</span></span>
<span id="cb73-66"><a href="score-analysis-set-up.html#cb73-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(sub_impute) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;loc&quot;</span>, <span class="st">&quot;rsid&quot;</span>, <span class="st">&quot;pos&quot;</span>, <span class="st">&quot;a0&quot;</span>, <span class="st">&quot;a1&quot;</span>, <span class="st">&quot;maf&quot;</span>, <span class="st">&quot;ax&quot;</span>, <span class="st">&quot;info&quot;</span>, <span class="st">&quot;chr&quot;</span>, <span class="st">&quot;superpos&quot;</span>)</span>
<span id="cb73-67"><a href="score-analysis-set-up.html#cb73-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(ss)[<span class="fu">colnames</span>(ss) <span class="sc">==</span> <span class="st">&quot;effect_allele&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;a0&quot;</span></span>
<span id="cb73-68"><a href="score-analysis-set-up.html#cb73-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(ss)[<span class="fu">colnames</span>(ss) <span class="sc">==</span> <span class="st">&quot;reference_allele&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;a1&quot;</span></span>
<span id="cb73-69"><a href="score-analysis-set-up.html#cb73-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(ss)[<span class="fu">colnames</span>(ss) <span class="sc">==</span> <span class="st">&quot;rsID&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rsid&quot;</span></span>
<span id="cb73-70"><a href="score-analysis-set-up.html#cb73-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(ss)[<span class="fu">colnames</span>(ss) <span class="sc">==</span> <span class="st">&quot;effect_weight&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;beta&quot;</span></span>
<span id="cb73-71"><a href="score-analysis-set-up.html#cb73-71" aria-hidden="true" tabindex="-1"></a>    ss<span class="sc">$</span>pos <span class="ot">&lt;-</span> sub_impute<span class="sc">$</span>pos</span>
<span id="cb73-72"><a href="score-analysis-set-up.html#cb73-72" aria-hidden="true" tabindex="-1"></a>    ss<span class="sc">$</span>chr <span class="ot">&lt;-</span> sub_impute<span class="sc">$</span>chr</span>
<span id="cb73-73"><a href="score-analysis-set-up.html#cb73-73" aria-hidden="true" tabindex="-1"></a>    ss <span class="ot">&lt;-</span> <span class="fu">snp_match</span>(ss, sub_impute)</span>
<span id="cb73-74"><a href="score-analysis-set-up.html#cb73-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-75"><a href="score-analysis-set-up.html#cb73-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">#write out the refined summary statistic</span></span>
<span id="cb73-76"><a href="score-analysis-set-up.html#cb73-76" aria-hidden="true" tabindex="-1"></a>    out_ss <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">chr =</span> ss<span class="sc">$</span>chr, <span class="at">rsid =</span> ss<span class="sc">$</span>rsid.ss, <span class="at">A1 =</span> ss<span class="sc">$</span>a0, <span class="at">beta =</span> ss<span class="sc">$</span>beta)</span>
<span id="cb73-77"><a href="score-analysis-set-up.html#cb73-77" aria-hidden="true" tabindex="-1"></a>    new_name <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(filename, <span class="st">&quot;.&quot;</span>, <span class="at">fixed =</span> T)[[<span class="dv">1</span>]][<span class="dv">1</span>]</span>
<span id="cb73-78"><a href="score-analysis-set-up.html#cb73-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.table</span>(out_ss, <span class="fu">paste0</span>(<span class="st">&quot;refine_other_ss/&quot;</span>, new_name, <span class="st">&quot;.new.ss&quot;</span>), <span class="at">col.names =</span> T, <span class="at">row.names =</span> F, <span class="at">sep =</span> <span class="st">&#39;</span><span class="sc">\t</span><span class="st">&#39;</span>, <span class="at">quote=</span>F)</span>
<span id="cb73-79"><a href="score-analysis-set-up.html#cb73-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb73-80"><a href="score-analysis-set-up.html#cb73-80" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Within this process a key limitation was that both major and minor allele are present. Approximitley 30% of scores did not have both and therefore could not be used in scoring. While I considered laxing this requirement, making sure the alleles are flipped correctly (which requires both alleles) seemed too important of a step to just throw out for nearly any reason. In the end 24 summary statistics were refined. For the record their names are:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="score-analysis-set-up.html#cb74-1" aria-hidden="true" tabindex="-1"></a>score_names <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;../analyze_score/other_scores/score_names&quot;</span>)</span>
<span id="cb74-2"><a href="score-analysis-set-up.html#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(score_names)</span></code></pre></div>
<pre><code>##                 V1               V2               V3               V4
## 1 PGS000007.new.ss PGS000014.new.ss PGS000020.new.ss PGS000039.new.ss
## 2 PGS000011.new.ss PGS000015.new.ss PGS000036.new.ss PGS000044.new.ss
## 3 PGS000013.new.ss PGS000016.new.ss PGS000037.new.ss PGS000045.new.ss
##                 V5               V6               V7               V8
## 1 PGS000046.new.ss PGS000058.new.ss PGS000082.new.ss PGS000195.new.ss
## 2 PGS000047.new.ss PGS000067.new.ss PGS000084.new.ss PGS000196.new.ss
## 3 PGS000052.new.ss PGS000072.new.ss PGS000194.new.ss PGS000199.new.ss</code></pre>
<p>With the summary statistics made I continued on with scoring following nearly the same process as was carried out within the previous scoring section. In short I iterated through each score and chromosome, generating a score. At the end of this process I summed together all of the chromosomes to generate one score. To run in parallel a control script is nescessary, which looks very similar to the adjusting summary statistic control script.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb76-1"><a href="score-analysis-set-up.html#cb76-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-2"><a href="score-analysis-set-up.html#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="va">maxGo=</span>3</span>
<span id="cb76-3"><a href="score-analysis-set-up.html#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> temp_files/poss_go</span>
<span id="cb76-4"><a href="score-analysis-set-up.html#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/athena/doc_score/qc/cv_files/train_eid.0.2.txt <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-f1</span> <span class="op">&gt;</span> temp_files/brit_eid</span>
<span id="cb76-5"><a href="score-analysis-set-up.html#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/athena/doc_score/qc/cv_files/test_eid.0.8.txt <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-f1</span> <span class="op">&gt;&gt;</span> temp_files/brit_eid</span>
<span id="cb76-6"><a href="score-analysis-set-up.html#cb76-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-7"><a href="score-analysis-set-up.html#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="kw">((</span> <span class="va">i</span><span class="op">=</span><span class="dv">1</span><span class="kw">;</span> <span class="va">i</span><span class="op">&lt;=</span><span class="va">$maxGo</span><span class="kw">;</span> <span class="va">i</span><span class="op">++</span> <span class="kw">));</span> <span class="cf">do</span></span>
<span id="cb76-8"><a href="score-analysis-set-up.html#cb76-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="va">$i</span> <span class="op">&gt;&gt;</span> temp_files/poss_go</span>
<span id="cb76-9"><a href="score-analysis-set-up.html#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb76-10"><a href="score-analysis-set-up.html#cb76-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-11"><a href="score-analysis-set-up.html#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> 1 <span class="op">&gt;</span> temp_files/counter</span>
<span id="cb76-12"><a href="score-analysis-set-up.html#cb76-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-13"><a href="score-analysis-set-up.html#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> refine_other_ss/ <span class="kw">|</span> <span class="cf">while</span> <span class="bu">read</span> <span class="va">scorename</span><span class="kw">;</span><span class="cf">do</span></span>
<span id="cb76-14"><a href="score-analysis-set-up.html#cb76-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cchr <span class="kw">in</span> {1..22}<span class="kw">;</span><span class="cf">do</span></span>
<span id="cb76-15"><a href="score-analysis-set-up.html#cb76-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-16"><a href="score-analysis-set-up.html#cb76-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">counter_var=</span><span class="kw">`</span><span class="fu">cat</span> temp_files/counter<span class="kw">`</span></span>
<span id="cb76-17"><a href="score-analysis-set-up.html#cb76-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="va">$counter_var</span></span>
<span id="cb76-18"><a href="score-analysis-set-up.html#cb76-18" aria-hidden="true" tabindex="-1"></a>        <span class="ex">./simple_score.sh</span> <span class="va">$scorename</span> <span class="va">$cchr</span> <span class="va">$counter_var</span> <span class="op">&amp;&gt;</span> logs/log.<span class="va">${counter_var}</span>.log <span class="kw">&amp;</span></span>
<span id="cb76-19"><a href="score-analysis-set-up.html#cb76-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="va">$counter_var</span> + 1 <span class="kw">|</span> <span class="fu">bc</span> <span class="op">&gt;</span> temp_files/counter</span>
<span id="cb76-20"><a href="score-analysis-set-up.html#cb76-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-21"><a href="score-analysis-set-up.html#cb76-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sleep</span> <span class="va">$((</span> ( <span class="va">RANDOM</span> <span class="op">%</span> <span class="dv">10</span> )  <span class="op">+</span> <span class="dv">1</span> <span class="va">))</span></span>
<span id="cb76-22"><a href="score-analysis-set-up.html#cb76-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-23"><a href="score-analysis-set-up.html#cb76-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">goOn=</span>False</span>
<span id="cb76-24"><a href="score-analysis-set-up.html#cb76-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="bu">[</span> <span class="va">$goOn</span> <span class="ot">==</span> <span class="st">&quot;False&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb76-25"><a href="score-analysis-set-up.html#cb76-25" aria-hidden="true" tabindex="-1"></a>          <span class="va">openSlots=</span><span class="kw">`</span><span class="fu">cat</span> temp_files/poss_go <span class="kw">|</span> <span class="fu">wc</span> <span class="at">-l</span><span class="kw">`</span></span>
<span id="cb76-26"><a href="score-analysis-set-up.html#cb76-26" aria-hidden="true" tabindex="-1"></a>          <span class="va">sizedir=</span><span class="kw">`</span><span class="fu">du</span> temp_files/ <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-f1</span><span class="kw">`</span></span>
<span id="cb76-27"><a href="score-analysis-set-up.html#cb76-27" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="bu">[</span> <span class="va">$openSlots</span> <span class="ot">-gt</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb76-28"><a href="score-analysis-set-up.html#cb76-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">[</span> <span class="va">$sizedir</span> <span class="ot">-lt</span> 20164096 <span class="bu">]</span><span class="kw">;</span><span class="cf">then</span></span>
<span id="cb76-29"><a href="score-analysis-set-up.html#cb76-29" aria-hidden="true" tabindex="-1"></a>              <span class="bu">echo</span> NOW WE CAN GO</span>
<span id="cb76-30"><a href="score-analysis-set-up.html#cb76-30" aria-hidden="true" tabindex="-1"></a>              <span class="va">goOn=</span>True</span>
<span id="cb76-31"><a href="score-analysis-set-up.html#cb76-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">fi</span></span>
<span id="cb76-32"><a href="score-analysis-set-up.html#cb76-32" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span></span>
<span id="cb76-33"><a href="score-analysis-set-up.html#cb76-33" aria-hidden="true" tabindex="-1"></a>            <span class="bu">echo</span> MUST WAIT FOR ROOM TO GO</span>
<span id="cb76-34"><a href="score-analysis-set-up.html#cb76-34" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sleep</span> <span class="va">$((</span> ( <span class="va">RANDOM</span> <span class="op">%</span> <span class="dv">5</span> )  <span class="op">+</span> <span class="dv">1</span> <span class="va">))</span></span>
<span id="cb76-35"><a href="score-analysis-set-up.html#cb76-35" aria-hidden="true" tabindex="-1"></a>          <span class="cf">fi</span></span>
<span id="cb76-36"><a href="score-analysis-set-up.html#cb76-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">done</span></span>
<span id="cb76-37"><a href="score-analysis-set-up.html#cb76-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-38"><a href="score-analysis-set-up.html#cb76-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">done</span></span>
<span id="cb76-39"><a href="score-analysis-set-up.html#cb76-39" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p>The key line within this control script is the line that launches simple_score.sh. This sub-script creates the nescessary genotypic information from the larger UKBB imputed file, and then uses PLINK to create the score.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb77-1"><a href="score-analysis-set-up.html#cb77-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-2"><a href="score-analysis-set-up.html#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="va">ss_name=$1</span></span>
<span id="cb77-3"><a href="score-analysis-set-up.html#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="va">chr=$2</span></span>
<span id="cb77-4"><a href="score-analysis-set-up.html#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="va">i=$3</span></span>
<span id="cb77-5"><a href="score-analysis-set-up.html#cb77-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-6"><a href="score-analysis-set-up.html#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$ss_name</span> <span class="va">$author</span> <span class="va">$method</span> <span class="va">$chr</span> <span class="va">$i</span></span>
<span id="cb77-7"><a href="score-analysis-set-up.html#cb77-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-8"><a href="score-analysis-set-up.html#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Just logistics around controlling parallelism</span></span>
<span id="cb77-9"><a href="score-analysis-set-up.html#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="va">go_num=</span><span class="kw">`</span><span class="fu">head</span> <span class="at">-1</span> temp_files/poss_go<span class="kw">`</span></span>
<span id="cb77-10"><a href="score-analysis-set-up.html#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="at">-v</span> <span class="at">-w</span> <span class="va">$go_num</span> temp_files/poss_go <span class="op">&gt;</span> temp_files/temp_poss</span>
<span id="cb77-11"><a href="score-analysis-set-up.html#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> temp_files/temp_poss temp_files/poss_go</span>
<span id="cb77-12"><a href="score-analysis-set-up.html#cb77-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-13"><a href="score-analysis-set-up.html#cb77-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-e</span> small_score_files/score.<span class="va">${ss_name}</span>.<span class="va">${chr}</span>.profile.zst <span class="bu">]</span><span class="kw">;</span><span class="cf">then</span></span>
<span id="cb77-14"><a href="score-analysis-set-up.html#cb77-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-15"><a href="score-analysis-set-up.html#cb77-15" aria-hidden="true" tabindex="-1"></a>  <span class="va">len=</span><span class="kw">`</span><span class="fu">cat</span> refine_other_ss/<span class="va">${ss_name}</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="at">-v</span> var=<span class="st">&quot;</span><span class="va">$chr</span><span class="st">&quot;</span> <span class="st">&#39;$1 == var {print $0}&#39;</span> <span class="kw">|</span> <span class="fu">wc</span> <span class="at">-l</span><span class="kw">`</span></span>
<span id="cb77-16"><a href="score-analysis-set-up.html#cb77-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">[</span> <span class="va">$len</span> <span class="ot">!=</span> 0 <span class="bu">]</span><span class="kw">;</span><span class="cf">then</span></span>
<span id="cb77-17"><a href="score-analysis-set-up.html#cb77-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span> refine_other_ss/<span class="va">${ss_name}</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="at">-v</span> var=<span class="st">&quot;</span><span class="va">$chr</span><span class="st">&quot;</span> <span class="st">&#39;$1 == var {print $0}&#39;</span> <span class="op">&gt;</span> temp_files/ss.<span class="va">${i}</span></span>
<span id="cb77-18"><a href="score-analysis-set-up.html#cb77-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-19"><a href="score-analysis-set-up.html#cb77-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span> temp_files/ss.<span class="va">${i}</span> <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-f2</span> <span class="op">&gt;</span> temp_files/rsids.<span class="va">${i}</span></span>
<span id="cb77-20"><a href="score-analysis-set-up.html#cb77-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-21"><a href="score-analysis-set-up.html#cb77-21" aria-hidden="true" tabindex="-1"></a>    <span class="ex">bgenix</span> <span class="at">-g</span> ~/athena/ukbiobank/imputed/ukbb.<span class="va">${chr}</span>.bgen <span class="at">-incl-rsids</span> temp_files/rsids.<span class="va">${i}</span> <span class="op">&gt;</span> temp_files/temp.<span class="va">${i}</span>.bgen</span>
<span id="cb77-22"><a href="score-analysis-set-up.html#cb77-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-23"><a href="score-analysis-set-up.html#cb77-23" aria-hidden="true" tabindex="-1"></a>    <span class="ex">plink2_new</span> <span class="at">--memory</span> 12000 <span class="at">--threads</span> 12 <span class="at">--bgen</span> temp_files/temp.<span class="va">${i}</span>.bgen ref-first <span class="at">--sample</span> ~/athena/ukbiobank/imputed/ukbb.<span class="va">${chr}</span>.sample <span class="at">--keep-fam</span> temp_files/brit_eid <span class="at">--make-bed</span> <span class="at">--out</span> temp_files/geno.<span class="va">${i}</span></span>
<span id="cb77-24"><a href="score-analysis-set-up.html#cb77-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-25"><a href="score-analysis-set-up.html#cb77-25" aria-hidden="true" tabindex="-1"></a>    <span class="ex">plink</span> <span class="at">--memory</span> 12000 <span class="at">--threads</span> 12 <span class="at">--bfile</span> temp_files/geno.<span class="va">${i}</span> <span class="at">--keep-allele-order</span> <span class="at">--score</span> temp_files/ss.<span class="va">${i}</span> 2 3 4 sum <span class="at">--out</span> small_score_files/score.<span class="va">${ss_name}</span>.<span class="va">${chr}</span></span>
<span id="cb77-26"><a href="score-analysis-set-up.html#cb77-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-27"><a href="score-analysis-set-up.html#cb77-27" aria-hidden="true" tabindex="-1"></a>    <span class="ex">zstd</span> <span class="at">--rm</span> small_score_files/score.<span class="va">${ss_name}</span>.<span class="va">${chr}</span>.profile</span>
<span id="cb77-28"><a href="score-analysis-set-up.html#cb77-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">fi</span></span>
<span id="cb77-29"><a href="score-analysis-set-up.html#cb77-29" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb77-30"><a href="score-analysis-set-up.html#cb77-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-31"><a href="score-analysis-set-up.html#cb77-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span> temp_files/ss.<span class="va">${i}</span></span>
<span id="cb77-32"><a href="score-analysis-set-up.html#cb77-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span> temp_files/rsids.<span class="va">${i}</span></span>
<span id="cb77-33"><a href="score-analysis-set-up.html#cb77-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span> temp_files/temp.<span class="va">${i}</span>.bgen</span>
<span id="cb77-34"><a href="score-analysis-set-up.html#cb77-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span> temp_files/geno.<span class="va">${i}</span>.<span class="pp">*</span></span>
<span id="cb77-35"><a href="score-analysis-set-up.html#cb77-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-36"><a href="score-analysis-set-up.html#cb77-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-37"><a href="score-analysis-set-up.html#cb77-37" aria-hidden="true" tabindex="-1"></a><span class="co">#Just logistics around controlling parallelism</span></span>
<span id="cb77-38"><a href="score-analysis-set-up.html#cb77-38" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$go_num</span> <span class="op">&gt;&gt;</span> temp_files/poss_go</span></code></pre></div>
<p>Finally, all of the scores are added together.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="score-analysis-set-up.html#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb78-2"><a href="score-analysis-set-up.html#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="score-analysis-set-up.html#cb78-3" aria-hidden="true" tabindex="-1"></a>all_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;small_score_files/&quot;</span>, <span class="at">pattern =</span> <span class="st">&quot;profile&quot;</span>)</span>
<span id="cb78-4"><a href="score-analysis-set-up.html#cb78-4" aria-hidden="true" tabindex="-1"></a>split_files <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(all_files, <span class="st">&quot;.&quot;</span>, <span class="at">fixed =</span> T)</span>
<span id="cb78-5"><a href="score-analysis-set-up.html#cb78-5" aria-hidden="true" tabindex="-1"></a>all_author <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(split_files, <span class="cf">function</span>(x) x[<span class="dv">2</span>]))</span>
<span id="cb78-6"><a href="score-analysis-set-up.html#cb78-6" aria-hidden="true" tabindex="-1"></a>all_chr <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(split_files, <span class="cf">function</span>(x) x[<span class="dv">5</span>]))</span>
<span id="cb78-7"><a href="score-analysis-set-up.html#cb78-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-8"><a href="score-analysis-set-up.html#cb78-8" aria-hidden="true" tabindex="-1"></a>brit_eid <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;temp_files/brit_eid&quot;</span>, <span class="at">stringsAsFactors=</span>F)</span>
<span id="cb78-9"><a href="score-analysis-set-up.html#cb78-9" aria-hidden="true" tabindex="-1"></a>new_name <span class="ot">&lt;-</span> <span class="fu">unique</span>(all_author)</span>
<span id="cb78-10"><a href="score-analysis-set-up.html#cb78-10" aria-hidden="true" tabindex="-1"></a>all_score <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(brit_eid), <span class="at">ncol =</span> <span class="fu">length</span>(new_name))</span>
<span id="cb78-11"><a href="score-analysis-set-up.html#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(all_score) <span class="ot">&lt;-</span> new_name</span>
<span id="cb78-12"><a href="score-analysis-set-up.html#cb78-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-13"><a href="score-analysis-set-up.html#cb78-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-14"><a href="score-analysis-set-up.html#cb78-14" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb78-15"><a href="score-analysis-set-up.html#cb78-15" aria-hidden="true" tabindex="-1"></a>j <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb78-16"><a href="score-analysis-set-up.html#cb78-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(all_files)){</span>
<span id="cb78-17"><a href="score-analysis-set-up.html#cb78-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-18"><a href="score-analysis-set-up.html#cb78-18" aria-hidden="true" tabindex="-1"></a>          <span class="fu">system</span>(<span class="fu">paste0</span>(<span class="st">&quot;zstd -d small_score_files/&quot;</span>, all_files[i]))</span>
<span id="cb78-19"><a href="score-analysis-set-up.html#cb78-19" aria-hidden="true" tabindex="-1"></a>          sub_score <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">fread</span>(<span class="fu">paste0</span>(<span class="st">&quot;small_score_files/&quot;</span>, <span class="fu">substr</span>(all_files[i], <span class="dv">1</span>, <span class="fu">nchar</span>(all_files[i])<span class="sc">-</span><span class="dv">4</span>))))</span>
<span id="cb78-20"><a href="score-analysis-set-up.html#cb78-20" aria-hidden="true" tabindex="-1"></a>          <span class="fu">system</span>(<span class="fu">paste0</span>(<span class="st">&quot;rm small_score_files/&quot;</span>, <span class="fu">substr</span>(all_files[i], <span class="dv">1</span>, <span class="fu">nchar</span>(all_files[i])<span class="sc">-</span><span class="dv">4</span>)))</span>
<span id="cb78-21"><a href="score-analysis-set-up.html#cb78-21" aria-hidden="true" tabindex="-1"></a>          all_score[,new_name <span class="sc">==</span> all_author[i]] <span class="ot">&lt;-</span> all_score[,new_name <span class="sc">==</span> all_author[i]] <span class="sc">+</span> sub_score<span class="sc">$</span>SCORESUM </span>
<span id="cb78-22"><a href="score-analysis-set-up.html#cb78-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-23"><a href="score-analysis-set-up.html#cb78-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb78-24"><a href="score-analysis-set-up.html#cb78-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-25"><a href="score-analysis-set-up.html#cb78-25" aria-hidden="true" tabindex="-1"></a>all_score <span class="ot">&lt;-</span> all_score[,<span class="fu">colSums</span>(all_score) <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb78-26"><a href="score-analysis-set-up.html#cb78-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-27"><a href="score-analysis-set-up.html#cb78-27" aria-hidden="true" tabindex="-1"></a>next_file <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">grep</span>(<span class="st">&quot;RDS&quot;</span>, <span class="fu">list.files</span>(<span class="st">&quot;final_scores&quot;</span>, <span class="st">&quot;all_score&quot;</span>))) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb78-28"><a href="score-analysis-set-up.html#cb78-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-29"><a href="score-analysis-set-up.html#cb78-29" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(all_score, <span class="fu">paste0</span>(<span class="st">&quot;final_scores/all_score.&quot;</span>, next_file), <span class="at">row.names =</span> F, <span class="at">col.names =</span> T, <span class="at">quote =</span> F, <span class="at">sep =</span> <span class="st">&#39; &#39;</span>)</span>
<span id="cb78-30"><a href="score-analysis-set-up.html#cb78-30" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_score, <span class="fu">paste0</span>(<span class="st">&quot;final_scores/all_score.&quot;</span>, next_file, <span class="st">&quot;.RDS&quot;</span>))</span>
<span id="cb78-31"><a href="score-analysis-set-up.html#cb78-31" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(<span class="fu">colnames</span>(all_score), <span class="fu">paste0</span>(<span class="st">&quot;final_scores/done_names.&quot;</span>, next_file), <span class="at">row.names =</span> F, <span class="at">col.names =</span> F, <span class="at">quote =</span> F)</span>
<span id="cb78-32"><a href="score-analysis-set-up.html#cb78-32" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(<span class="fu">paste0</span>(<span class="st">&quot;gzip final_scores/all_score.&quot;</span>, next_file))</span></code></pre></div>
<p>If this process seemed a little too fast I encourage you to look at the 5th chapter that goes over many scoring processes and caveats. The end product are 24 polygenic risk scores that may be used to supplement future analyses of the phenotypes already discussed.</p>
</div>
<div id="other-covariates" class="section level2" number="7.4">
<h2><span class="header-section-number">7.4</span> Other Covariates</h2>
<p>In order to get a better picture of how well the PGS is working, we collect other covariates that may be included in a linear prediction model. While this is a good idea, complications quickly emerge in determining which covariates should be included. One way forward is simple including a wide variety of covariates and then paring those away based on feature selection. While this is a fine idea, and is a good idea that I may follow in another project, it makes overfitting quite possible (which is not good) and is alot of work (which is not good). Therefore I will only include covariates which have been declared to be significant. The sources I am looking at for this significance is the Mayo Clinic, NIH and various respective professional organizations. The list of covariates for each disease under analysis includes:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="score-analysis-set-up.html#cb79-1" aria-hidden="true" tabindex="-1"></a>covar_names <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;../analyze_score/descript_defs/author_covar&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb79-2"><a href="score-analysis-set-up.html#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(covar_names)</span></code></pre></div>
<pre><code>##                V1
## 1         Bentham
## 2  Christophersen
## 3        Demenais
## 4        Demontis
## 5          Dubois
## 6         Gormley
## 7           IMSGC
## 8             Jin
## 9         Kottgen
## 10           Liu1
## 11           Liu2
## 12        Mahajan
## 13          Malik
## 14    Michailidou
## 15         Namjou
## 16         Nikpay
## 17          Okada
## 18        Onengut
## 19         Phelan
## 20        Rheenen
## 21     Schumacher
## 22           Shah
## 23          Sklar
## 24           Tsoi
## 25           Wray
## 26            Xie
##                                                                                                      V2
## 1                                                                                                   sex
## 2  age,hypertension,congenital heart disease,cardiac arrest,coronary artery disease,alcohol,sleep apnea
## 3                                                                         allergic rhinitis,smoking,bmi
## 4                                                                                                  none
## 5                                                                                       type 1 diabetes
## 6                                                     age,sex,age menopause,hormone replacement therapy
## 7                                                                            age,sex,epstein barr virus
## 8                                                  use of sun protection,melanona,non-hodgkins lymphoma
## 9                                                                 age,sex,obesity,hypertension,diabetes
## 10                                                                                              smoking
## 11                                                                                              smoking
## 12                                                 age,sex,bmi,exercise,hypertension,hypocholesteroemia
## 13  age,sex,bmi,age started oral contraceptive,hypertension,hypocholesteroemia,smoking,alcohol,diabetes
## 14                                              age,sex,bmi,alcohol,age menarche,age menopause,pregnant
## 15                                                 age,obesity,hypertension,hypocholesteroemia,diabetes
## 16                                         age,sex,bmi,hypocholesteroemia,hypertension,diabetes,smoking
## 17                                                                     age,sex,smoking,obesity,pregnant
## 18                                                                                                 none
## 19                                           age,bmi,hormone replacement therapy,pregnant,breast cancer
## 20                                                                                 age,diabetes,obesity
## 21                                                                                          age,obesity
## 22                      cardiac arrest,hypertension,congenital heart defects,obesity,diabetes,arrythmia
## 23                                                                                                 none
## 24                                                                                              smoking
## 25                                                    alcohol,hormone replacement therapy,age menopause
## 26                                                                                          age,sex,sle</code></pre>
<p>These other covariates are obtained in two very different ways as there are two very different types of covariates, those from the ICD records and those that are not. We will start off with the non-ICD covariates, as it is simpler. We start off by reading in all of the UK Biobank phenotypes, subsetting to make sure the EIDs are held within all of the files, then sort so all of the EIDs are in the same order. We then extract the columns that are within the author covariates shown above. The second part of the non-ICD covariate extraction process is some manual data cleaning. Some of the covariates have NA entries, which we either fill in with the mean value of the remaining non-NA entries, or we select the mode or other obvious answer that assumes the person did not do something. For example we take the mean for BMI and assume horome replacement therapy was not taken. A final data cleaning step sets NA for male individuals to female-specific features (such as age of menopause). We lastly write out the covariates into a text file. The exact process is shown above.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="score-analysis-set-up.html#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vroom)</span>
<span id="cb81-2"><a href="score-analysis-set-up.html#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="score-analysis-set-up.html#cb81-3" aria-hidden="true" tabindex="-1"></a>defs <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;../descript_defs/covar_defs_singlecol&quot;</span>, <span class="at">stringsAsFactors=</span>F, <span class="at">header =</span> T)</span>
<span id="cb81-4"><a href="score-analysis-set-up.html#cb81-4" aria-hidden="true" tabindex="-1"></a>preg_codes <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(defs[<span class="fu">which</span>(defs[,<span class="dv">1</span>] <span class="sc">==</span> <span class="st">&quot;pregnant&quot;</span>),<span class="dv">2</span>], <span class="st">&quot;,&quot;</span>)[[<span class="dv">1</span>]]</span>
<span id="cb81-5"><a href="score-analysis-set-up.html#cb81-5" aria-hidden="true" tabindex="-1"></a>use_codes <span class="ot">&lt;-</span> <span class="fu">c</span>(defs<span class="sc">$</span>single_col[<span class="sc">-</span><span class="fu">which</span>(defs[,<span class="dv">1</span>] <span class="sc">==</span> <span class="st">&quot;pregnant&quot;</span>)], preg_codes)</span>
<span id="cb81-6"><a href="score-analysis-set-up.html#cb81-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-7"><a href="score-analysis-set-up.html#cb81-7" aria-hidden="true" tabindex="-1"></a>phen <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">vroom</span>(<span class="st">&quot;~/athena/ukbiobank/phenotypes/ukb26867.csv.gz&quot;</span>, <span class="at">delim =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb81-8"><a href="score-analysis-set-up.html#cb81-8" aria-hidden="true" tabindex="-1"></a>sub_phen_1 <span class="ot">&lt;-</span> phen[,<span class="fu">colnames</span>(phen) <span class="sc">%in%</span> <span class="fu">c</span>(use_codes, <span class="st">&quot;eid&quot;</span>)]</span>
<span id="cb81-9"><a href="score-analysis-set-up.html#cb81-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-10"><a href="score-analysis-set-up.html#cb81-10" aria-hidden="true" tabindex="-1"></a>phen <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">vroom</span>(<span class="st">&quot;~/athena/ukbiobank/phenotypes/ukb33822.csv.gz&quot;</span>, <span class="at">delim =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb81-11"><a href="score-analysis-set-up.html#cb81-11" aria-hidden="true" tabindex="-1"></a>sub_phen_2 <span class="ot">&lt;-</span> phen[,<span class="fu">colnames</span>(phen) <span class="sc">%in%</span> <span class="fu">c</span>(use_codes, <span class="st">&quot;eid&quot;</span>)]</span>
<span id="cb81-12"><a href="score-analysis-set-up.html#cb81-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-13"><a href="score-analysis-set-up.html#cb81-13" aria-hidden="true" tabindex="-1"></a>phen <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">vroom</span>(<span class="st">&quot;~/athena/ukbiobank/phenotypes/ukb42385.csv.gz&quot;</span>, <span class="at">delim =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb81-14"><a href="score-analysis-set-up.html#cb81-14" aria-hidden="true" tabindex="-1"></a>sub_phen_3 <span class="ot">&lt;-</span> phen[,<span class="fu">colnames</span>(phen) <span class="sc">%in%</span> <span class="fu">c</span>(use_codes, <span class="st">&quot;eid&quot;</span>)]</span>
<span id="cb81-15"><a href="score-analysis-set-up.html#cb81-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-16"><a href="score-analysis-set-up.html#cb81-16" aria-hidden="true" tabindex="-1"></a>sub_phen_1 <span class="ot">&lt;-</span> sub_phen_1[sub_phen_1<span class="sc">$</span>eid <span class="sc">%in%</span> sub_phen_2<span class="sc">$</span>eid <span class="sc">&amp;</span> sub_phen_1<span class="sc">$</span>eid <span class="sc">%in%</span> sub_phen_3<span class="sc">$</span>eid,]</span>
<span id="cb81-17"><a href="score-analysis-set-up.html#cb81-17" aria-hidden="true" tabindex="-1"></a>sub_phen_2 <span class="ot">&lt;-</span> sub_phen_2[sub_phen_2<span class="sc">$</span>eid <span class="sc">%in%</span> sub_phen_1<span class="sc">$</span>eid <span class="sc">&amp;</span> sub_phen_2<span class="sc">$</span>eid <span class="sc">%in%</span> sub_phen_3<span class="sc">$</span>eid,]</span>
<span id="cb81-18"><a href="score-analysis-set-up.html#cb81-18" aria-hidden="true" tabindex="-1"></a>sub_phen_3 <span class="ot">&lt;-</span> sub_phen_3[sub_phen_3<span class="sc">$</span>eid <span class="sc">%in%</span> sub_phen_2<span class="sc">$</span>eid <span class="sc">&amp;</span> sub_phen_3<span class="sc">$</span>eid <span class="sc">%in%</span> sub_phen_1<span class="sc">$</span>eid,]</span>
<span id="cb81-19"><a href="score-analysis-set-up.html#cb81-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-20"><a href="score-analysis-set-up.html#cb81-20" aria-hidden="true" tabindex="-1"></a>sub_phen_2 <span class="ot">&lt;-</span> sub_phen_2[<span class="fu">order</span>(sub_phen_2<span class="sc">$</span>eid)[<span class="fu">rank</span>(sub_phen_1<span class="sc">$</span>eid)],]</span>
<span id="cb81-21"><a href="score-analysis-set-up.html#cb81-21" aria-hidden="true" tabindex="-1"></a>sub_phen_3 <span class="ot">&lt;-</span> sub_phen_3[<span class="fu">order</span>(sub_phen_3<span class="sc">$</span>eid)[<span class="fu">rank</span>(sub_phen_1<span class="sc">$</span>eid)],]</span>
<span id="cb81-22"><a href="score-analysis-set-up.html#cb81-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-23"><a href="score-analysis-set-up.html#cb81-23" aria-hidden="true" tabindex="-1"></a>new_phen <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sub_phen_1, sub_phen_2[,<span class="sc">-</span><span class="dv">1</span>, <span class="at">drop =</span> F], sub_phen_3[,<span class="sc">-</span><span class="dv">1</span>, <span class="at">drop =</span> F])</span>
<span id="cb81-24"><a href="score-analysis-set-up.html#cb81-24" aria-hidden="true" tabindex="-1"></a>preg_ans <span class="ot">&lt;-</span> (new_phen[[<span class="st">&quot;3140-0.0&quot;</span>]] <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(new_phen[[<span class="st">&quot;3140-0.0&quot;</span>]])) <span class="sc">|</span> (<span class="sc">!</span><span class="fu">is.na</span>(new_phen[[<span class="st">&quot;2754-0.0&quot;</span>]]))</span>
<span id="cb81-25"><a href="score-analysis-set-up.html#cb81-25" aria-hidden="true" tabindex="-1"></a>preg_ans <span class="ot">&lt;-</span> preg_ans<span class="sc">*</span><span class="dv">1</span></span>
<span id="cb81-26"><a href="score-analysis-set-up.html#cb81-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-27"><a href="score-analysis-set-up.html#cb81-27" aria-hidden="true" tabindex="-1"></a>inds <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(defs)[<span class="sc">-</span><span class="dv">10</span>]</span>
<span id="cb81-28"><a href="score-analysis-set-up.html#cb81-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> inds){</span>
<span id="cb81-29"><a href="score-analysis-set-up.html#cb81-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(new_phen)[<span class="fu">colnames</span>(new_phen) <span class="sc">==</span> defs[i,<span class="dv">2</span>]] <span class="ot">&lt;-</span> defs[i,<span class="dv">1</span>]</span>
<span id="cb81-30"><a href="score-analysis-set-up.html#cb81-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb81-31"><a href="score-analysis-set-up.html#cb81-31" aria-hidden="true" tabindex="-1"></a>new_phen <span class="ot">&lt;-</span> new_phen[,<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">&quot;0.0&quot;</span>, <span class="fu">colnames</span>(new_phen))]</span>
<span id="cb81-32"><a href="score-analysis-set-up.html#cb81-32" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>pregnant <span class="ot">&lt;-</span> preg_ans</span>
<span id="cb81-33"><a href="score-analysis-set-up.html#cb81-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-34"><a href="score-analysis-set-up.html#cb81-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-35"><a href="score-analysis-set-up.html#cb81-35" aria-hidden="true" tabindex="-1"></a><span class="do">##################### CLEAN BY HAND ##############################</span></span>
<span id="cb81-36"><a href="score-analysis-set-up.html#cb81-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-37"><a href="score-analysis-set-up.html#cb81-37" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>alcohol[<span class="fu">is.na</span>(new_phen<span class="sc">$</span>alcohol) <span class="sc">|</span> new_phen<span class="sc">$</span>alcohol <span class="sc">==</span> <span class="sc">-</span><span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb81-38"><a href="score-analysis-set-up.html#cb81-38" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>smoking[<span class="fu">is.na</span>(new_phen<span class="sc">$</span>smoking) <span class="sc">|</span> new_phen<span class="sc">$</span>smoking <span class="sc">==</span> <span class="sc">-</span><span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb81-39"><a href="score-analysis-set-up.html#cb81-39" aria-hidden="true" tabindex="-1"></a>new_phen <span class="ot">&lt;-</span> new_phen[,<span class="sc">-</span><span class="fu">which</span>(<span class="fu">colnames</span>(new_phen) <span class="sc">==</span> <span class="st">&quot;alcohol.1&quot;</span>)]</span>
<span id="cb81-40"><a href="score-analysis-set-up.html#cb81-40" aria-hidden="true" tabindex="-1"></a>new_phen <span class="ot">&lt;-</span> new_phen[,<span class="sc">-</span><span class="fu">which</span>(<span class="fu">colnames</span>(new_phen) <span class="sc">==</span> <span class="st">&quot;smoking.1&quot;</span>)]</span>
<span id="cb81-41"><a href="score-analysis-set-up.html#cb81-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-42"><a href="score-analysis-set-up.html#cb81-42" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>bmi[<span class="fu">is.na</span>(new_phen<span class="sc">$</span>bmi)] <span class="ot">&lt;-</span> <span class="fu">mean</span>(new_phen<span class="sc">$</span>bmi, <span class="at">na.rm =</span> T)</span>
<span id="cb81-43"><a href="score-analysis-set-up.html#cb81-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-44"><a href="score-analysis-set-up.html#cb81-44" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>exercise[<span class="fu">is.na</span>(new_phen<span class="sc">$</span>exercise) <span class="sc">|</span> new_phen<span class="sc">$</span>exercise <span class="sc">==</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">|</span> new_phen<span class="sc">$</span>exercise <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb81-45"><a href="score-analysis-set-up.html#cb81-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-46"><a href="score-analysis-set-up.html#cb81-46" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>use_of_sun_protection[<span class="fu">is.na</span>(new_phen<span class="sc">$</span>use_of_sun_protection) <span class="sc">|</span> new_phen<span class="sc">$</span>use_of_sun_protection <span class="sc">==</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">|</span> new_phen<span class="sc">$</span>use_of_sun_protection <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb81-47"><a href="score-analysis-set-up.html#cb81-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-48"><a href="score-analysis-set-up.html#cb81-48" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>age_menarche[<span class="fu">is.na</span>(new_phen<span class="sc">$</span>age_menarche) <span class="sc">|</span> new_phen<span class="sc">$</span>age_menarche <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">|</span> new_phen<span class="sc">$</span>age_menarche <span class="sc">==</span> <span class="sc">-</span><span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(new_phen<span class="sc">$</span>age_menarche[<span class="sc">!</span>(<span class="fu">is.na</span>(new_phen<span class="sc">$</span>age_menarche) <span class="sc">|</span> new_phen<span class="sc">$</span>age_menarche <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">|</span> new_phen<span class="sc">$</span>age_menarche <span class="sc">==</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">|</span> new_phen<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">1</span>)])</span>
<span id="cb81-49"><a href="score-analysis-set-up.html#cb81-49" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>age_menarche[new_phen<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb81-50"><a href="score-analysis-set-up.html#cb81-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-51"><a href="score-analysis-set-up.html#cb81-51" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>hormone_replacement_therapy[<span class="fu">is.na</span>(new_phen<span class="sc">$</span>hormone_replacement_therapy) <span class="sc">|</span> new_phen<span class="sc">$</span>hormone_replacement_therapy <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">|</span> new_phen<span class="sc">$</span>hormone_replacement_therapy <span class="sc">==</span> <span class="sc">-</span><span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb81-52"><a href="score-analysis-set-up.html#cb81-52" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>hormone_replacement_therapy[new_phen<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb81-53"><a href="score-analysis-set-up.html#cb81-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-54"><a href="score-analysis-set-up.html#cb81-54" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>had_menopause[<span class="fu">is.na</span>(new_phen<span class="sc">$</span>had_menopause) <span class="sc">|</span> new_phen<span class="sc">$</span>had_menopause <span class="sc">==</span> <span class="dv">2</span> <span class="sc">|</span> new_phen<span class="sc">$</span>had_menopause <span class="sc">==</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb81-55"><a href="score-analysis-set-up.html#cb81-55" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>had_menopause[new_phen<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb81-56"><a href="score-analysis-set-up.html#cb81-56" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>age_menopause[new_phen<span class="sc">$</span>had_menopause <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb81-57"><a href="score-analysis-set-up.html#cb81-57" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>age_menopause[new_phen<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(new_phen<span class="sc">$</span>age_menopause)] <span class="ot">&lt;-</span> <span class="fu">mean</span>(new_phen<span class="sc">$</span>age_menopause, <span class="at">na.rm =</span> T)</span>
<span id="cb81-58"><a href="score-analysis-set-up.html#cb81-58" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>age_menopause[new_phen<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb81-59"><a href="score-analysis-set-up.html#cb81-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-60"><a href="score-analysis-set-up.html#cb81-60" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>ever_used_oral_contraceptive[<span class="fu">is.na</span>(new_phen<span class="sc">$</span>ever_used_oral_contraceptive) <span class="sc">|</span> new_phen<span class="sc">$</span>ever_used_oral_contraceptive <span class="sc">==</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">|</span> new_phen<span class="sc">$</span>ever_used_oral_contraceptive <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb81-61"><a href="score-analysis-set-up.html#cb81-61" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>ever_used_oral_contraceptive[new_phen<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb81-62"><a href="score-analysis-set-up.html#cb81-62" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>age_started_oral_contraceptive[new_phen<span class="sc">$</span>ever_used_oral_contraceptive <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> new_phen<span class="sc">$</span>age_started_oral_contraceptive <span class="sc">&lt;</span> <span class="dv">10</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb81-63"><a href="score-analysis-set-up.html#cb81-63" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>age_started_oral_contraceptive[new_phen<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(new_phen<span class="sc">$</span>age_started_oral_contraceptive)] <span class="ot">&lt;-</span> <span class="fu">mean</span>(new_phen<span class="sc">$</span>age_started_oral_contraceptive, <span class="at">na.rm =</span> T)</span>
<span id="cb81-64"><a href="score-analysis-set-up.html#cb81-64" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>age_started_oral_contraceptive[new_phen<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb81-65"><a href="score-analysis-set-up.html#cb81-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-66"><a href="score-analysis-set-up.html#cb81-66" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>epstein_barr_virus[<span class="fu">is.na</span>(new_phen<span class="sc">$</span>epstein_barr_virus)] <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb81-67"><a href="score-analysis-set-up.html#cb81-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-68"><a href="score-analysis-set-up.html#cb81-68" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>obesity <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb81-69"><a href="score-analysis-set-up.html#cb81-69" aria-hidden="true" tabindex="-1"></a>new_phen<span class="sc">$</span>obesity[new_phen<span class="sc">$</span>bmi <span class="sc">&gt;</span> <span class="dv">30</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb81-70"><a href="score-analysis-set-up.html#cb81-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-71"><a href="score-analysis-set-up.html#cb81-71" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################################################</span></span>
<span id="cb81-72"><a href="score-analysis-set-up.html#cb81-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-73"><a href="score-analysis-set-up.html#cb81-73" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(new_phen, <span class="st">&quot;covar_data/single_col_covars&quot;</span>, <span class="at">row.names =</span> F, <span class="at">col.names =</span> T, <span class="at">quote =</span> F, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span></code></pre></div>
<p>The second group of the other covariates come from the ICD (and self-reported disease) records. For each of the disease traits that are considered covariates for any of the diseaes under the main analysis we need to get an ICD definition. This process was simply carried out through table and internet look-ups. The defintions used are as follows:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="score-analysis-set-up.html#cb82-1" aria-hidden="true" tabindex="-1"></a>covar_names <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;../analyze_score/descript_defs/covar_defs&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">header =</span> T)</span>
<span id="cb82-2"><a href="score-analysis-set-up.html#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(covar_names)</span></code></pre></div>
<pre><code>##                              name        single_col   ICD10     ICD9
## 1                             age            34-0.0    &lt;NA&gt;     &lt;NA&gt;
## 2                             sex            31-0.0    &lt;NA&gt;     &lt;NA&gt;
## 3                    hypertension              &lt;NA&gt;     I10      401
## 4        congenital_heart_disease              &lt;NA&gt;     Q24      746
## 5                  cardiac_arrest              &lt;NA&gt; I21,I46 410,4275
## 6         coronary_artery_disease              &lt;NA&gt;     I25      414
## 7                         alcohol          1558-0.0    &lt;NA&gt;     &lt;NA&gt;
## 8                     sleep_apnea              &lt;NA&gt;    G473     &lt;NA&gt;
## 9               allergic_rhinitis              &lt;NA&gt;     J30      477
## 10                        smoking         20116-0.0    &lt;NA&gt;     &lt;NA&gt;
## 11                            bmi         21001-0.0    &lt;NA&gt;     &lt;NA&gt;
## 12                type_1_diabetes              &lt;NA&gt;     E10      250
## 13                       exercise           884-0.0    &lt;NA&gt;     &lt;NA&gt;
## 14             hypocholesteroemia              &lt;NA&gt;    E780     &lt;NA&gt;
## 15 age_started_oral_contraceptive          2784-0.0    &lt;NA&gt;     &lt;NA&gt;
## 16                   age_menarche          2714-0.0    &lt;NA&gt;     &lt;NA&gt;
## 17                  age_menopause          3581-0.0    &lt;NA&gt;     &lt;NA&gt;
## 18                       pregnant 2754-0.0,3140-0.0    &lt;NA&gt;     &lt;NA&gt;
## 19    hormone_replacement_therapy          2814-0.0    &lt;NA&gt;     &lt;NA&gt;
## 20                  breast_cancer              &lt;NA&gt;     C50     2330
## 21             epstein_barr_virus         23053-0.0    &lt;NA&gt;     &lt;NA&gt;
## 22          use_of_sun_protection          2267-0.0    &lt;NA&gt;     &lt;NA&gt;
## 23                       diabetes              &lt;NA&gt; E10,E11      250
## 24                     arrhythmia              &lt;NA&gt; I47,I48      427
## 25                            sle              &lt;NA&gt;     M32     7100
## 26                       melanoma              &lt;NA&gt;     C43      172
## 27          non-hodgkins_lymphoma              &lt;NA&gt; C82,C83     &lt;NA&gt;
##         self_diag self_diag_cancer
## 1            &lt;NA&gt;               NA
## 2            &lt;NA&gt;               NA
## 3       1065,1072               NA
## 4            &lt;NA&gt;               NA
## 5            &lt;NA&gt;               NA
## 6            &lt;NA&gt;               NA
## 7            &lt;NA&gt;               NA
## 8            1123               NA
## 9            1387               NA
## 10           &lt;NA&gt;               NA
## 11           &lt;NA&gt;               NA
## 12           1222               NA
## 13           &lt;NA&gt;               NA
## 14           1473               NA
## 15           &lt;NA&gt;               NA
## 16           &lt;NA&gt;               NA
## 17           &lt;NA&gt;               NA
## 18           &lt;NA&gt;               NA
## 19           &lt;NA&gt;               NA
## 20           &lt;NA&gt;             1002
## 21           &lt;NA&gt;               NA
## 22           &lt;NA&gt;               NA
## 23 1220,1222,1223               NA
## 24           1077               NA
## 25           1381               NA
## 26           &lt;NA&gt;             1059
## 27           &lt;NA&gt;             1053</code></pre>
<p>While it could be possible to get the ICD covariates for all individuals for all diseases, this process is actually quite time intensive and therefore I have decided to only get the relavent disease covariates for each main disease under analysis. The specific covariates matched to each disease under analyis is:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="score-analysis-set-up.html#cb84-1" aria-hidden="true" tabindex="-1"></a>covar_names <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;../analyze_score/descript_defs/author_to_covar_hesin&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">header =</span> F)</span>
<span id="cb84-2"><a href="score-analysis-set-up.html#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(covar_names)</span></code></pre></div>
<pre><code>##                V1
## 1         Bentham
## 2  Christophersen
## 3        Demenais
## 4        Demontis
## 5          Dubois
## 6         Gormley
## 7           IMSGC
## 8             Jin
## 9         Kottgen
## 10           Liu1
## 11           Liu2
## 12        Mahajan
## 13          Malik
## 14    Michailidou
## 15         Namjou
## 16         Nikpay
## 17          Okada
## 18        Onengut
## 19         Phelan
## 20        Rheenen
## 21     Schumacher
## 22           Shah
## 23          Sklar
## 24           Tsoi
## 25           Wray
## 26            Xie
##                                                                                          V2
## 1                                                                                      &lt;NA&gt;
## 2  hypertension,congenital_heart_disease,cardiac_arrest,coronary_artery_disease,sleep_apnea
## 3                                                                         allergic_rhinitis
## 4                                                                                      &lt;NA&gt;
## 5                                                                           type_1_diabetes
## 6                                                                                      &lt;NA&gt;
## 7                                                                                      &lt;NA&gt;
## 8                                                            melanona,non-hodgkins_lymphoma
## 9                                                                     hypertension,diabetes
## 10                                                                                     &lt;NA&gt;
## 11                                                                                     &lt;NA&gt;
## 12                                                          hypertension,hypocholesteroemia
## 13                                                 hypertension,hypocholesteroemia,diabetes
## 14                                                                                     &lt;NA&gt;
## 15                                                 hypertension,hypocholesteroemia,diabetes
## 16                                                 hypocholesteroemia,hypertension,diabetes
## 17                                                                                     &lt;NA&gt;
## 18                                                                                     &lt;NA&gt;
## 19                                                                            breast_cancer
## 20                                                                                 diabetes
## 21                                                                                     &lt;NA&gt;
## 22                   cardiac_arrest,hypertension,congenital_heart_disese,diabetes,arrythmia
## 23                                                                                     &lt;NA&gt;
## 24                                                                                     &lt;NA&gt;
## 25                                                                                     &lt;NA&gt;
## 26                                                                                     &lt;NA&gt;</code></pre>
<p>Now that we know exactly what we are getting, let’s actually get the values. As I am lopping though alot of data I have opted to use a Python script rather than R. The script itself is highly similar to the phenotype extraction shown in the previous section, so I won’t go in too much detail on how it operates. I will instead just highlight a few things. First, I want to make sure that all of the disease covariates take place before the possible date of the primary disease. Therefore I read in the dates of the primary disease and use it to limit the number of disease diagnoses that I can look at for the covariates. Secondly, in this instance I am possible looking at more than one disease defintion (whereas before I only needed to know one defition). I then create a for loop within the loop for each indvidial to iterate over all posible covariates definitions. Third, wheras in making the phenotype defintion I kept 6 columns, one for each possible diagnosis source, in this instance I am assuming that if the individual has any positive covariate within either the ICD or self-reported sources I will assume that they do have the disease. Other than these changes everything is the same, as I attempt to intelligently iterate through all individuals, pulling out the meaningful ICD codes and subsetting by the date. The exact code is shown below:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="score-analysis-set-up.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb86-2"><a href="score-analysis-set-up.html#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb86-3"><a href="score-analysis-set-up.html#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb86-4"><a href="score-analysis-set-up.html#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb86-5"><a href="score-analysis-set-up.html#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pdb</span>
<span id="cb86-6"><a href="score-analysis-set-up.html#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gzip</span>
<span id="cb86-7"><a href="score-analysis-set-up.html#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb86-8"><a href="score-analysis-set-up.html#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb86-9"><a href="score-analysis-set-up.html#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb86-10"><a href="score-analysis-set-up.html#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gzip</span>
<span id="cb86-11"><a href="score-analysis-set-up.html#cb86-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-12"><a href="score-analysis-set-up.html#cb86-12" aria-hidden="true" tabindex="-1"></a>author <span class="op">=</span> <span class="st">&quot;Bentham&quot;</span></span>
<span id="cb86-13"><a href="score-analysis-set-up.html#cb86-13" aria-hidden="true" tabindex="-1"></a>phen_method <span class="op">=</span> <span class="st">&quot;all&quot;</span>          </span>
<span id="cb86-14"><a href="score-analysis-set-up.html#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Still need to sort everything so that the extEid process works</span></span>
<span id="cb86-15"><a href="score-analysis-set-up.html#cb86-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-16"><a href="score-analysis-set-up.html#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normRead(fileName, withHeader <span class="op">=</span> <span class="va">True</span>, delim <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>, removeQuote <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb86-17"><a href="score-analysis-set-up.html#cb86-17" aria-hidden="true" tabindex="-1"></a>    totalData <span class="op">=</span> []</span>
<span id="cb86-18"><a href="score-analysis-set-up.html#cb86-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> fileName[<span class="op">-</span><span class="dv">2</span>:] <span class="op">==</span> <span class="st">&quot;gz&quot;</span>:</span>
<span id="cb86-19"><a href="score-analysis-set-up.html#cb86-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> gzip.<span class="bu">open</span>(fileName,<span class="st">&quot;r&quot;</span>) <span class="im">as</span> f:</span>
<span id="cb86-20"><a href="score-analysis-set-up.html#cb86-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> line <span class="kw">in</span> f:</span>
<span id="cb86-21"><a href="score-analysis-set-up.html#cb86-21" aria-hidden="true" tabindex="-1"></a>                totalData.append(line.decode().strip().split(delim))</span>
<span id="cb86-22"><a href="score-analysis-set-up.html#cb86-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-23"><a href="score-analysis-set-up.html#cb86-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb86-24"><a href="score-analysis-set-up.html#cb86-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(fileName,<span class="st">&quot;r&quot;</span>,encoding <span class="op">=</span> <span class="st">&quot;latin-1&quot;</span>) <span class="im">as</span> f:</span>
<span id="cb86-25"><a href="score-analysis-set-up.html#cb86-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> line <span class="kw">in</span> f.read().splitlines():</span>
<span id="cb86-26"><a href="score-analysis-set-up.html#cb86-26" aria-hidden="true" tabindex="-1"></a>                <span class="co">#for line in f:</span></span>
<span id="cb86-27"><a href="score-analysis-set-up.html#cb86-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> removeQuote:</span>
<span id="cb86-28"><a href="score-analysis-set-up.html#cb86-28" aria-hidden="true" tabindex="-1"></a>                    line <span class="op">=</span> line.replace(<span class="st">&#39;&quot;&#39;</span>, <span class="st">&#39;&#39;</span>).strip()</span>
<span id="cb86-29"><a href="score-analysis-set-up.html#cb86-29" aria-hidden="true" tabindex="-1"></a>                totalData.append(line.split(delim))</span>
<span id="cb86-30"><a href="score-analysis-set-up.html#cb86-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> withHeader:</span>
<span id="cb86-31"><a href="score-analysis-set-up.html#cb86-31" aria-hidden="true" tabindex="-1"></a>        header<span class="op">=</span>totalData[<span class="dv">0</span>]</span>
<span id="cb86-32"><a href="score-analysis-set-up.html#cb86-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> totalData[<span class="dv">0</span>]</span>
<span id="cb86-33"><a href="score-analysis-set-up.html#cb86-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb86-34"><a href="score-analysis-set-up.html#cb86-34" aria-hidden="true" tabindex="-1"></a>        header <span class="op">=</span> <span class="va">None</span></span>
<span id="cb86-35"><a href="score-analysis-set-up.html#cb86-35" aria-hidden="true" tabindex="-1"></a>    totalData<span class="op">=</span>np.array(totalData)</span>
<span id="cb86-36"><a href="score-analysis-set-up.html#cb86-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(totalData,header)</span>
<span id="cb86-37"><a href="score-analysis-set-up.html#cb86-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-38"><a href="score-analysis-set-up.html#cb86-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-39"><a href="score-analysis-set-up.html#cb86-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-40"><a href="score-analysis-set-up.html#cb86-40" aria-hidden="true" tabindex="-1"></a>covar_defs, covar_header <span class="op">=</span> normRead(<span class="st">&quot;../descript_defs/covar_defs_hesin&quot;</span>, <span class="va">False</span>)</span>
<span id="cb86-41"><a href="score-analysis-set-up.html#cb86-41" aria-hidden="true" tabindex="-1"></a>use_defs <span class="op">=</span> []</span>
<span id="cb86-42"><a href="score-analysis-set-up.html#cb86-42" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(covar_defs.shape[<span class="dv">0</span>]):</span>
<span id="cb86-43"><a href="score-analysis-set-up.html#cb86-43" aria-hidden="true" tabindex="-1"></a>    split_defs <span class="op">=</span> [j.split(<span class="st">&quot;,&quot;</span>) <span class="cf">for</span> j <span class="kw">in</span> covar_defs[i,<span class="dv">2</span>:]]</span>
<span id="cb86-44"><a href="score-analysis-set-up.html#cb86-44" aria-hidden="true" tabindex="-1"></a>    use_defs.append(<span class="bu">dict</span>(<span class="bu">zip</span>([<span class="st">&quot;ICD10&quot;</span>, <span class="st">&quot;ICD9&quot;</span>, <span class="st">&quot;selfrep&quot;</span>, <span class="st">&quot;cancer&quot;</span>], split_defs)))</span>
<span id="cb86-45"><a href="score-analysis-set-up.html#cb86-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-46"><a href="score-analysis-set-up.html#cb86-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-47"><a href="score-analysis-set-up.html#cb86-47" aria-hidden="true" tabindex="-1"></a>date_ass,ass_header <span class="op">=</span> normRead(<span class="st">&quot;../construct_defs/date_assessed.csv&quot;</span>, <span class="va">True</span>, <span class="st">&quot;,&quot;</span>, <span class="va">True</span>)</span>
<span id="cb86-48"><a href="score-analysis-set-up.html#cb86-48" aria-hidden="true" tabindex="-1"></a>self_rep, self_rep_header <span class="op">=</span> normRead(<span class="st">&quot;../construct_defs/self_report_diag.csv&quot;</span>, <span class="va">True</span>, <span class="st">&quot;,&quot;</span>, <span class="va">True</span>)</span>
<span id="cb86-49"><a href="score-analysis-set-up.html#cb86-49" aria-hidden="true" tabindex="-1"></a>cancer_rep, cancer_rep_header <span class="op">=</span> normRead(<span class="st">&quot;../construct_defs/self_report_cancer.csv&quot;</span>, <span class="va">True</span>, <span class="st">&quot;,&quot;</span>, <span class="va">True</span>)</span>
<span id="cb86-50"><a href="score-analysis-set-up.html#cb86-50" aria-hidden="true" tabindex="-1"></a>big_eid, eid_head <span class="op">=</span> normRead(<span class="st">&quot;../construct_defs/eid.csv&quot;</span>, <span class="va">True</span>, <span class="st">&quot;,&quot;</span>, <span class="va">True</span>)</span>
<span id="cb86-51"><a href="score-analysis-set-up.html#cb86-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-52"><a href="score-analysis-set-up.html#cb86-52" aria-hidden="true" tabindex="-1"></a>date_ass <span class="op">=</span> date_ass[big_eid[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb86-53"><a href="score-analysis-set-up.html#cb86-53" aria-hidden="true" tabindex="-1"></a>self_rep <span class="op">=</span> self_rep[big_eid[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb86-54"><a href="score-analysis-set-up.html#cb86-54" aria-hidden="true" tabindex="-1"></a>cancer_rep <span class="op">=</span> cancer_rep[big_eid[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb86-55"><a href="score-analysis-set-up.html#cb86-55" aria-hidden="true" tabindex="-1"></a>big_eid <span class="op">=</span> big_eid[big_eid[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb86-56"><a href="score-analysis-set-up.html#cb86-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-57"><a href="score-analysis-set-up.html#cb86-57" aria-hidden="true" tabindex="-1"></a>cancer_phase <span class="op">=</span> [x.split(<span class="st">&quot;-&quot;</span>)[<span class="dv">1</span>].split(<span class="st">&quot;.&quot;</span>)[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> cancer_rep_header]</span>
<span id="cb86-58"><a href="score-analysis-set-up.html#cb86-58" aria-hidden="true" tabindex="-1"></a>self_phase <span class="op">=</span> [x.split(<span class="st">&quot;-&quot;</span>)[<span class="dv">1</span>].split(<span class="st">&quot;.&quot;</span>)[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> self_rep_header]</span>
<span id="cb86-59"><a href="score-analysis-set-up.html#cb86-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-60"><a href="score-analysis-set-up.html#cb86-60" aria-hidden="true" tabindex="-1"></a>diag, head_diag <span class="op">=</span> normRead(<span class="st">&quot;/home/kulmsc/athena/ukbiobank/hesin/hesin_diag.txt&quot;</span>)</span>
<span id="cb86-61"><a href="score-analysis-set-up.html#cb86-61" aria-hidden="true" tabindex="-1"></a>hesin, head_hesin <span class="op">=</span> normRead(<span class="st">&quot;/home/kulmsc/athena/ukbiobank/hesin/hesin.txt&quot;</span>)</span>
<span id="cb86-62"><a href="score-analysis-set-up.html#cb86-62" aria-hidden="true" tabindex="-1"></a>diag <span class="op">=</span> diag[diag[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb86-63"><a href="score-analysis-set-up.html#cb86-63" aria-hidden="true" tabindex="-1"></a>hesin <span class="op">=</span> hesin[hesin[:,<span class="dv">0</span>].argsort(),:]</span>
<span id="cb86-64"><a href="score-analysis-set-up.html#cb86-64" aria-hidden="true" tabindex="-1"></a>diag_eid <span class="op">=</span> np.unique(diag[:,<span class="dv">0</span>])</span>
<span id="cb86-65"><a href="score-analysis-set-up.html#cb86-65" aria-hidden="true" tabindex="-1"></a>diag_max <span class="op">=</span> diag.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb86-66"><a href="score-analysis-set-up.html#cb86-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-67"><a href="score-analysis-set-up.html#cb86-67" aria-hidden="true" tabindex="-1"></a>diag_eid_list <span class="op">=</span> diag[:,<span class="dv">0</span>].tolist()</span>
<span id="cb86-68"><a href="score-analysis-set-up.html#cb86-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-69"><a href="score-analysis-set-up.html#cb86-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-70"><a href="score-analysis-set-up.html#cb86-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;reading&quot;</span>)</span>
<span id="cb86-71"><a href="score-analysis-set-up.html#cb86-71" aria-hidden="true" tabindex="-1"></a>known_diag, known_head <span class="op">=</span> normRead(<span class="st">&quot;../construct_defs/pheno_defs/diag.&quot;</span> <span class="op">+</span> author.lower() <span class="op">+</span> <span class="st">&quot;.txt.gz&quot;</span>, <span class="va">False</span>, <span class="st">&quot; &quot;</span>)</span>
<span id="cb86-72"><a href="score-analysis-set-up.html#cb86-72" aria-hidden="true" tabindex="-1"></a>known_time, known_head <span class="op">=</span> normRead(<span class="st">&quot;../construct_defs/pheno_defs/time.&quot;</span> <span class="op">+</span> author.lower() <span class="op">+</span> <span class="st">&quot;.txt.gz&quot;</span>, <span class="va">False</span>, <span class="st">&quot; &quot;</span>)</span>
<span id="cb86-73"><a href="score-analysis-set-up.html#cb86-73" aria-hidden="true" tabindex="-1"></a>new_time <span class="op">=</span> np.tile(datetime.datetime.strptime(<span class="st">&quot;31/12/2020&quot;</span>, <span class="st">&#39;</span><span class="sc">%d</span><span class="st">/%m/%Y&#39;</span>), (known_time.shape[<span class="dv">0</span>], known_time.shape[<span class="dv">1</span>]))</span>
<span id="cb86-74"><a href="score-analysis-set-up.html#cb86-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;read in&quot;</span>)</span>
<span id="cb86-75"><a href="score-analysis-set-up.html#cb86-75" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(known_time.shape[<span class="dv">0</span>]):</span>
<span id="cb86-76"><a href="score-analysis-set-up.html#cb86-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(known_time.shape[<span class="dv">1</span>]):</span>
<span id="cb86-77"><a href="score-analysis-set-up.html#cb86-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> known_time[i,j] <span class="op">!=</span> <span class="st">&#39;__________&#39;</span>:</span>
<span id="cb86-78"><a href="score-analysis-set-up.html#cb86-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> j <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> j <span class="op">==</span> <span class="dv">1</span> <span class="kw">or</span> j <span class="op">==</span> <span class="dv">5</span>:</span>
<span id="cb86-79"><a href="score-analysis-set-up.html#cb86-79" aria-hidden="true" tabindex="-1"></a>                new_time[i,j] <span class="op">=</span> datetime.datetime.strptime(known_time[i,j], <span class="st">&quot;%Y-%m-</span><span class="sc">%d</span><span class="st">&quot;</span>)</span>
<span id="cb86-80"><a href="score-analysis-set-up.html#cb86-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb86-81"><a href="score-analysis-set-up.html#cb86-81" aria-hidden="true" tabindex="-1"></a>                new_time[i,j] <span class="op">=</span> datetime.datetime.strptime(known_time[i,j], <span class="st">&quot;</span><span class="sc">%d</span><span class="st">/%m/%Y&quot;</span>)</span>
<span id="cb86-82"><a href="score-analysis-set-up.html#cb86-82" aria-hidden="true" tabindex="-1"></a>known_time <span class="op">=</span> new_time</span>
<span id="cb86-83"><a href="score-analysis-set-up.html#cb86-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-84"><a href="score-analysis-set-up.html#cb86-84" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> phen_method <span class="op">==</span> <span class="st">&quot;icd&quot;</span>:</span>
<span id="cb86-85"><a href="score-analysis-set-up.html#cb86-85" aria-hidden="true" tabindex="-1"></a>    known_diag <span class="op">=</span> know_diag[:,<span class="dv">2</span>:<span class="dv">4</span>]</span>
<span id="cb86-86"><a href="score-analysis-set-up.html#cb86-86" aria-hidden="true" tabindex="-1"></a>    known_time <span class="op">=</span> known_time[:,<span class="dv">2</span>:<span class="dv">4</span>]</span>
<span id="cb86-87"><a href="score-analysis-set-up.html#cb86-87" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> phen_method <span class="op">==</span> <span class="st">&quot;selfrep&quot;</span>:</span>
<span id="cb86-88"><a href="score-analysis-set-up.html#cb86-88" aria-hidden="true" tabindex="-1"></a>    known_diag <span class="op">=</span> known_diag[:,<span class="dv">0</span>:<span class="dv">2</span>]</span>
<span id="cb86-89"><a href="score-analysis-set-up.html#cb86-89" aria-hidden="true" tabindex="-1"></a>    known_time <span class="op">=</span> known_time[:,<span class="dv">0</span>:<span class="dv">2</span>]</span>
<span id="cb86-90"><a href="score-analysis-set-up.html#cb86-90" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> phen_method <span class="op">==</span> <span class="st">&quot;icd_selfrep&quot;</span>:</span>
<span id="cb86-91"><a href="score-analysis-set-up.html#cb86-91" aria-hidden="true" tabindex="-1"></a>    known_diag <span class="op">=</span> known_diag[:,<span class="dv">0</span>:<span class="dv">4</span>]</span>
<span id="cb86-92"><a href="score-analysis-set-up.html#cb86-92" aria-hidden="true" tabindex="-1"></a>    known_time <span class="op">=</span> known_time[:,<span class="dv">0</span>:<span class="dv">4</span>]</span>
<span id="cb86-93"><a href="score-analysis-set-up.html#cb86-93" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> phen_method <span class="op">==</span> <span class="st">&quot;double&quot;</span>:</span>
<span id="cb86-94"><a href="score-analysis-set-up.html#cb86-94" aria-hidden="true" tabindex="-1"></a>    known_diag <span class="op">=</span> known_diag.astype(<span class="st">&quot;int&quot;</span>)</span>
<span id="cb86-95"><a href="score-analysis-set-up.html#cb86-95" aria-hidden="true" tabindex="-1"></a>    for_double <span class="op">=</span> np.<span class="bu">sum</span>(known_diag, axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb86-96"><a href="score-analysis-set-up.html#cb86-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-97"><a href="score-analysis-set-up.html#cb86-97" aria-hidden="true" tabindex="-1"></a>final_diag <span class="op">=</span> []</span>
<span id="cb86-98"><a href="score-analysis-set-up.html#cb86-98" aria-hidden="true" tabindex="-1"></a>final_time <span class="op">=</span> []</span>
<span id="cb86-99"><a href="score-analysis-set-up.html#cb86-99" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(known_diag.shape[<span class="dv">0</span>]):</span>
<span id="cb86-100"><a href="score-analysis-set-up.html#cb86-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> phen_method <span class="op">==</span> <span class="st">&quot;double&quot;</span>:</span>
<span id="cb86-101"><a href="score-analysis-set-up.html#cb86-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> for_double[i] <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb86-102"><a href="score-analysis-set-up.html#cb86-102" aria-hidden="true" tabindex="-1"></a>            final_diag.append(<span class="dv">1</span>)</span>
<span id="cb86-103"><a href="score-analysis-set-up.html#cb86-103" aria-hidden="true" tabindex="-1"></a>            final_time.append(<span class="bu">min</span>(known_time[i,:]))</span>
<span id="cb86-104"><a href="score-analysis-set-up.html#cb86-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb86-105"><a href="score-analysis-set-up.html#cb86-105" aria-hidden="true" tabindex="-1"></a>            final_diag.append(<span class="dv">0</span>)</span>
<span id="cb86-106"><a href="score-analysis-set-up.html#cb86-106" aria-hidden="true" tabindex="-1"></a>            final_time.append(<span class="st">&quot;NA&quot;</span>)</span>
<span id="cb86-107"><a href="score-analysis-set-up.html#cb86-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb86-108"><a href="score-analysis-set-up.html#cb86-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">&quot;1&quot;</span> <span class="kw">in</span> known_diag[i,:]:</span>
<span id="cb86-109"><a href="score-analysis-set-up.html#cb86-109" aria-hidden="true" tabindex="-1"></a>            final_diag.append(<span class="dv">1</span>)</span>
<span id="cb86-110"><a href="score-analysis-set-up.html#cb86-110" aria-hidden="true" tabindex="-1"></a>            final_time.append(<span class="bu">min</span>(known_time[i,:]))</span>
<span id="cb86-111"><a href="score-analysis-set-up.html#cb86-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb86-112"><a href="score-analysis-set-up.html#cb86-112" aria-hidden="true" tabindex="-1"></a>            final_diag.append(<span class="dv">0</span>)</span>
<span id="cb86-113"><a href="score-analysis-set-up.html#cb86-113" aria-hidden="true" tabindex="-1"></a>            final_time.append(<span class="st">&quot;NA&quot;</span>)</span>
<span id="cb86-114"><a href="score-analysis-set-up.html#cb86-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-115"><a href="score-analysis-set-up.html#cb86-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-116"><a href="score-analysis-set-up.html#cb86-116" aria-hidden="true" tabindex="-1"></a><span class="co">#STILL NEED TO FIGURE OUT HOW I WANT TO SPLIT THIS - right now assume I dont</span></span>
<span id="cb86-117"><a href="score-analysis-set-up.html#cb86-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-118"><a href="score-analysis-set-up.html#cb86-118" aria-hidden="true" tabindex="-1"></a>start_eid_diag <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb86-119"><a href="score-analysis-set-up.html#cb86-119" aria-hidden="true" tabindex="-1"></a>df_occur <span class="op">=</span> np.zeros((big_eid.shape[<span class="dv">0</span>], covar_defs.shape[<span class="dv">0</span>]))</span>
<span id="cb86-120"><a href="score-analysis-set-up.html#cb86-120" aria-hidden="true" tabindex="-1"></a>df_date <span class="op">=</span> np.tile(<span class="st">&quot;_________&quot;</span>, (big_eid.shape[<span class="dv">0</span>], covar_defs.shape[<span class="dv">0</span>]))</span>
<span id="cb86-121"><a href="score-analysis-set-up.html#cb86-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-122"><a href="score-analysis-set-up.html#cb86-122" aria-hidden="true" tabindex="-1"></a><span class="co">#pdb.set_trace()</span></span>
<span id="cb86-123"><a href="score-analysis-set-up.html#cb86-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-124"><a href="score-analysis-set-up.html#cb86-124" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ind <span class="kw">in</span> <span class="bu">range</span>(big_eid.shape[<span class="dv">0</span>]):</span>
<span id="cb86-125"><a href="score-analysis-set-up.html#cb86-125" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(ind)</span>
<span id="cb86-126"><a href="score-analysis-set-up.html#cb86-126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(big_eid[ind])</span>
<span id="cb86-127"><a href="score-analysis-set-up.html#cb86-127" aria-hidden="true" tabindex="-1"></a>    <span class="co">#pdb.set_trace()</span></span>
<span id="cb86-128"><a href="score-analysis-set-up.html#cb86-128" aria-hidden="true" tabindex="-1"></a>    curr_eid <span class="op">=</span> big_eid[ind][<span class="dv">0</span>]</span>
<span id="cb86-129"><a href="score-analysis-set-up.html#cb86-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ind <span class="op">%</span> <span class="dv">10000</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb86-130"><a href="score-analysis-set-up.html#cb86-130" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(ind)</span>
<span id="cb86-131"><a href="score-analysis-set-up.html#cb86-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-132"><a href="score-analysis-set-up.html#cb86-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> trait_ind <span class="kw">in</span> <span class="bu">range</span>(covar_defs.shape[<span class="dv">0</span>]):</span>
<span id="cb86-133"><a href="score-analysis-set-up.html#cb86-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-134"><a href="score-analysis-set-up.html#cb86-134" aria-hidden="true" tabindex="-1"></a>        <span class="co">#CANCER SELF REPORT</span></span>
<span id="cb86-135"><a href="score-analysis-set-up.html#cb86-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> covar_defs[trait_ind, <span class="dv">5</span>] <span class="op">!=</span> <span class="st">&quot;NA&quot;</span>:</span>
<span id="cb86-136"><a href="score-analysis-set-up.html#cb86-136" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[trait_ind][<span class="st">&quot;cancer&quot;</span>], cancer_rep[ind,:])):</span>
<span id="cb86-137"><a href="score-analysis-set-up.html#cb86-137" aria-hidden="true" tabindex="-1"></a>                locs <span class="op">=</span> np.where(np.isin(cancer_rep[ind,:], covar_defs[trait_ind, <span class="dv">5</span>]))[<span class="dv">0</span>]</span>
<span id="cb86-138"><a href="score-analysis-set-up.html#cb86-138" aria-hidden="true" tabindex="-1"></a>                poss_date <span class="op">=</span> date_ass[ind, <span class="bu">int</span>(cancer_phase[locs[<span class="dv">0</span>]])]</span>
<span id="cb86-139"><a href="score-analysis-set-up.html#cb86-139" aria-hidden="true" tabindex="-1"></a>                poss_date <span class="op">=</span> datetime.datetime.strptime(poss_date, <span class="st">&quot;%Y-%m-</span><span class="sc">%d</span><span class="st">&quot;</span>)</span>
<span id="cb86-140"><a href="score-analysis-set-up.html#cb86-140" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> poss_date <span class="op">&lt;</span> final_time[i]:</span>
<span id="cb86-141"><a href="score-analysis-set-up.html#cb86-141" aria-hidden="true" tabindex="-1"></a>                    df_occur[ind, trait_ind] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb86-142"><a href="score-analysis-set-up.html#cb86-142" aria-hidden="true" tabindex="-1"></a>                    df_date[ind, trait_ind] <span class="op">=</span> poss_date</span>
<span id="cb86-143"><a href="score-analysis-set-up.html#cb86-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-144"><a href="score-analysis-set-up.html#cb86-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-145"><a href="score-analysis-set-up.html#cb86-145" aria-hidden="true" tabindex="-1"></a>        <span class="co">#CANCER SELF REPORT</span></span>
<span id="cb86-146"><a href="score-analysis-set-up.html#cb86-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> covar_defs[trait_ind, <span class="dv">4</span>] <span class="op">!=</span> <span class="st">&quot;NA&quot;</span>:</span>
<span id="cb86-147"><a href="score-analysis-set-up.html#cb86-147" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[trait_ind][<span class="st">&quot;selfrep&quot;</span>], self_rep[ind,:])):</span>
<span id="cb86-148"><a href="score-analysis-set-up.html#cb86-148" aria-hidden="true" tabindex="-1"></a>                locs <span class="op">=</span> np.where(np.isin(self_rep[ind,:], covar_defs[trait_ind, <span class="dv">4</span>]))[<span class="dv">0</span>]</span>
<span id="cb86-149"><a href="score-analysis-set-up.html#cb86-149" aria-hidden="true" tabindex="-1"></a>                poss_date <span class="op">=</span> date_ass[ind, <span class="bu">int</span>(self_phase[locs[<span class="dv">0</span>]])]</span>
<span id="cb86-150"><a href="score-analysis-set-up.html#cb86-150" aria-hidden="true" tabindex="-1"></a>                poss_date <span class="op">=</span> datetime.datetime.strptime(poss_date, <span class="st">&quot;%Y-%m-</span><span class="sc">%d</span><span class="st">&quot;</span>)</span>
<span id="cb86-151"><a href="score-analysis-set-up.html#cb86-151" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> poss_date <span class="op">&lt;</span> final_time[i]:</span>
<span id="cb86-152"><a href="score-analysis-set-up.html#cb86-152" aria-hidden="true" tabindex="-1"></a>                    df_occur[ind, trait_ind] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb86-153"><a href="score-analysis-set-up.html#cb86-153" aria-hidden="true" tabindex="-1"></a>                    df_date[ind, trait_ind] <span class="op">=</span> poss_date</span>
<span id="cb86-154"><a href="score-analysis-set-up.html#cb86-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-155"><a href="score-analysis-set-up.html#cb86-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-156"><a href="score-analysis-set-up.html#cb86-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-157"><a href="score-analysis-set-up.html#cb86-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-158"><a href="score-analysis-set-up.html#cb86-158" aria-hidden="true" tabindex="-1"></a>        <span class="co">#HESIN DIAG</span></span>
<span id="cb86-159"><a href="score-analysis-set-up.html#cb86-159" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> curr_eid <span class="kw">in</span> diag_eid_list:</span>
<span id="cb86-160"><a href="score-analysis-set-up.html#cb86-160" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> curr_eid <span class="op">!=</span> diag_eid_list[<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb86-161"><a href="score-analysis-set-up.html#cb86-161" aria-hidden="true" tabindex="-1"></a>                next_eid <span class="op">=</span> np.unique(diag[start_eid_diag:(start_eid_diag<span class="op">+</span><span class="dv">7000</span>),<span class="dv">0</span>])[<span class="dv">1</span>]</span>
<span id="cb86-162"><a href="score-analysis-set-up.html#cb86-162" aria-hidden="true" tabindex="-1"></a>                ext_eid <span class="op">=</span> diag_eid_list.index(next_eid)</span>
<span id="cb86-163"><a href="score-analysis-set-up.html#cb86-163" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb86-164"><a href="score-analysis-set-up.html#cb86-164" aria-hidden="true" tabindex="-1"></a>                ext_eid <span class="op">=</span> diag_max</span>
<span id="cb86-165"><a href="score-analysis-set-up.html#cb86-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-166"><a href="score-analysis-set-up.html#cb86-166" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ICD -9</span></span>
<span id="cb86-167"><a href="score-analysis-set-up.html#cb86-167" aria-hidden="true" tabindex="-1"></a>            use_short_icd9_diag <span class="op">=</span> [x[<span class="dv">0</span>:<span class="dv">3</span>] <span class="cf">for</span> x <span class="kw">in</span> diag[start_eid_diag:ext_eid,<span class="dv">4</span>]]</span>
<span id="cb86-168"><a href="score-analysis-set-up.html#cb86-168" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[trait_ind][<span class="st">&quot;ICD9&quot;</span>], use_short_icd9_diag)):</span>
<span id="cb86-169"><a href="score-analysis-set-up.html#cb86-169" aria-hidden="true" tabindex="-1"></a>                short_icd9_locs <span class="op">=</span> np.where(np.isin(use_short_icd9_diag, use_defs[trait_ind][<span class="st">&quot;ICD9&quot;</span>]))[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb86-170"><a href="score-analysis-set-up.html#cb86-170" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb86-171"><a href="score-analysis-set-up.html#cb86-171" aria-hidden="true" tabindex="-1"></a>                short_icd9_locs <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb86-172"><a href="score-analysis-set-up.html#cb86-172" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[trait_ind][<span class="st">&quot;ICD9&quot;</span>], diag[start_eid_diag:ext_eid,<span class="dv">4</span>])):</span>
<span id="cb86-173"><a href="score-analysis-set-up.html#cb86-173" aria-hidden="true" tabindex="-1"></a>                long_icd9_locs <span class="op">=</span> np.where(np.isin(diag[start_eid_diag:ext_eid,<span class="dv">4</span>], use_defs[trait_ind][<span class="st">&quot;ICD9&quot;</span>]))[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb86-174"><a href="score-analysis-set-up.html#cb86-174" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb86-175"><a href="score-analysis-set-up.html#cb86-175" aria-hidden="true" tabindex="-1"></a>                long_icd9_locs <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb86-176"><a href="score-analysis-set-up.html#cb86-176" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> long_icd9_locs <span class="op">!=</span> <span class="dv">10000</span> <span class="kw">or</span> short_icd9_locs <span class="op">!=</span> <span class="dv">10000</span>:</span>
<span id="cb86-177"><a href="score-analysis-set-up.html#cb86-177" aria-hidden="true" tabindex="-1"></a>                icd9_locs <span class="op">=</span> <span class="bu">min</span>((long_icd9_locs, short_icd9_locs))</span>
<span id="cb86-178"><a href="score-analysis-set-up.html#cb86-178" aria-hidden="true" tabindex="-1"></a>                icd9_ins_index <span class="op">=</span> diag[start_eid_diag<span class="op">+</span>icd9_locs,<span class="dv">1</span>]</span>
<span id="cb86-179"><a href="score-analysis-set-up.html#cb86-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-180"><a href="score-analysis-set-up.html#cb86-180" aria-hidden="true" tabindex="-1"></a>                raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> icd9_ins_index),<span class="dv">5</span>][<span class="dv">0</span>]</span>
<span id="cb86-181"><a href="score-analysis-set-up.html#cb86-181" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> raw_date <span class="op">==</span> <span class="st">&quot;&quot;</span>:</span>
<span id="cb86-182"><a href="score-analysis-set-up.html#cb86-182" aria-hidden="true" tabindex="-1"></a>                    raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> icd9_ins_index),<span class="dv">21</span>][<span class="dv">0</span>]</span>
<span id="cb86-183"><a href="score-analysis-set-up.html#cb86-183" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> raw_date <span class="op">==</span> <span class="st">&quot;&quot;</span>:</span>
<span id="cb86-184"><a href="score-analysis-set-up.html#cb86-184" aria-hidden="true" tabindex="-1"></a>                        raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> icd9_ins_index),<span class="dv">4</span>][<span class="dv">0</span>]</span>
<span id="cb86-185"><a href="score-analysis-set-up.html#cb86-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-186"><a href="score-analysis-set-up.html#cb86-186" aria-hidden="true" tabindex="-1"></a>                pdb.set_trace()</span>
<span id="cb86-187"><a href="score-analysis-set-up.html#cb86-187" aria-hidden="true" tabindex="-1"></a>                df_occur[ind,<span class="dv">2</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb86-188"><a href="score-analysis-set-up.html#cb86-188" aria-hidden="true" tabindex="-1"></a>                df_date[ind,<span class="dv">2</span>] <span class="op">=</span> raw_date</span>
<span id="cb86-189"><a href="score-analysis-set-up.html#cb86-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-190"><a href="score-analysis-set-up.html#cb86-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-191"><a href="score-analysis-set-up.html#cb86-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-192"><a href="score-analysis-set-up.html#cb86-192" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ICD - 10</span></span>
<span id="cb86-193"><a href="score-analysis-set-up.html#cb86-193" aria-hidden="true" tabindex="-1"></a>            use_short_icd10_diag <span class="op">=</span> [x[<span class="dv">0</span>:<span class="dv">3</span>] <span class="cf">for</span> x <span class="kw">in</span> diag[start_eid_diag:ext_eid,<span class="dv">6</span>]]</span>
<span id="cb86-194"><a href="score-analysis-set-up.html#cb86-194" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[trait_ind][<span class="st">&quot;ICD10&quot;</span>], use_short_icd10_diag)):</span>
<span id="cb86-195"><a href="score-analysis-set-up.html#cb86-195" aria-hidden="true" tabindex="-1"></a>                short_icd10_locs <span class="op">=</span> np.where(np.isin(use_short_icd10_diag, use_defs[trait_ind][<span class="st">&quot;ICD10&quot;</span>]))[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb86-196"><a href="score-analysis-set-up.html#cb86-196" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb86-197"><a href="score-analysis-set-up.html#cb86-197" aria-hidden="true" tabindex="-1"></a>                short_icd10_locs <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb86-198"><a href="score-analysis-set-up.html#cb86-198" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(np.isin(use_defs[trait_ind][<span class="st">&quot;ICD10&quot;</span>], diag[start_eid_diag:ext_eid,<span class="dv">6</span>])):</span>
<span id="cb86-199"><a href="score-analysis-set-up.html#cb86-199" aria-hidden="true" tabindex="-1"></a>                long_icd10_locs <span class="op">=</span> np.where(np.isin(diag[start_eid_diag:ext_eid,<span class="dv">6</span>], use_defs[trait_ind][<span class="st">&quot;ICD10&quot;</span>]))[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb86-200"><a href="score-analysis-set-up.html#cb86-200" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb86-201"><a href="score-analysis-set-up.html#cb86-201" aria-hidden="true" tabindex="-1"></a>                long_icd10_locs <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb86-202"><a href="score-analysis-set-up.html#cb86-202" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> long_icd10_locs <span class="op">!=</span> <span class="dv">10000</span> <span class="kw">or</span> short_icd10_locs <span class="op">!=</span> <span class="dv">10000</span>:</span>
<span id="cb86-203"><a href="score-analysis-set-up.html#cb86-203" aria-hidden="true" tabindex="-1"></a>                icd10_locs <span class="op">=</span> <span class="bu">min</span>((long_icd10_locs, short_icd10_locs))</span>
<span id="cb86-204"><a href="score-analysis-set-up.html#cb86-204" aria-hidden="true" tabindex="-1"></a>                icd10_ins_index <span class="op">=</span> diag[start_eid_diag<span class="op">+</span>icd10_locs,<span class="dv">1</span>]</span>
<span id="cb86-205"><a href="score-analysis-set-up.html#cb86-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-206"><a href="score-analysis-set-up.html#cb86-206" aria-hidden="true" tabindex="-1"></a>                raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> icd10_ins_index),<span class="dv">5</span>][<span class="dv">0</span>]</span>
<span id="cb86-207"><a href="score-analysis-set-up.html#cb86-207" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> raw_date <span class="op">==</span> <span class="st">&quot;&quot;</span>:</span>
<span id="cb86-208"><a href="score-analysis-set-up.html#cb86-208" aria-hidden="true" tabindex="-1"></a>                    raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> icd10_ins_index),<span class="dv">21</span>][<span class="dv">0</span>]</span>
<span id="cb86-209"><a href="score-analysis-set-up.html#cb86-209" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> raw_date <span class="op">==</span> <span class="st">&quot;&quot;</span>:</span>
<span id="cb86-210"><a href="score-analysis-set-up.html#cb86-210" aria-hidden="true" tabindex="-1"></a>                        raw_date <span class="op">=</span> hesin[np.logical_and(hesin[:,<span class="dv">0</span>] <span class="op">==</span> curr_eid, hesin[:,<span class="dv">1</span>] <span class="op">==</span> icd10_ins_index),<span class="dv">4</span>][<span class="dv">0</span>]</span>
<span id="cb86-211"><a href="score-analysis-set-up.html#cb86-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-212"><a href="score-analysis-set-up.html#cb86-212" aria-hidden="true" tabindex="-1"></a>                pdb.set_trace()</span>
<span id="cb86-213"><a href="score-analysis-set-up.html#cb86-213" aria-hidden="true" tabindex="-1"></a>                df_occur[ind,<span class="dv">3</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb86-214"><a href="score-analysis-set-up.html#cb86-214" aria-hidden="true" tabindex="-1"></a>                df_date[ind,<span class="dv">3</span>] <span class="op">=</span> raw_date</span>
<span id="cb86-215"><a href="score-analysis-set-up.html#cb86-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-216"><a href="score-analysis-set-up.html#cb86-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-217"><a href="score-analysis-set-up.html#cb86-217" aria-hidden="true" tabindex="-1"></a>        start_eid_diag <span class="op">=</span> ext_eid</span>
<span id="cb86-218"><a href="score-analysis-set-up.html#cb86-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-219"><a href="score-analysis-set-up.html#cb86-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-220"><a href="score-analysis-set-up.html#cb86-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-221"><a href="score-analysis-set-up.html#cb86-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-222"><a href="score-analysis-set-up.html#cb86-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-223"><a href="score-analysis-set-up.html#cb86-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-224"><a href="score-analysis-set-up.html#cb86-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-225"><a href="score-analysis-set-up.html#cb86-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-226"><a href="score-analysis-set-up.html#cb86-226" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;end&quot;</span>)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="compiling-the-scores.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="tuning.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
