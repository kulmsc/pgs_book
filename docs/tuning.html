<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 Tuning | Comparison of PGS Generative Methods</title>
  <meta name="description" content="A deep dive into all the scripts and underlying though processes that create polygenic risk scores" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="8 Tuning | Comparison of PGS Generative Methods" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A deep dive into all the scripts and underlying though processes that create polygenic risk scores" />
  <meta name="github-repo" content="pgs_book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 Tuning | Comparison of PGS Generative Methods" />
  
  <meta name="twitter:description" content="A deep dive into all the scripts and underlying though processes that create polygenic risk scores" />
  

<meta name="author" content="Scott Kulm" />


<meta name="date" content="2021-02-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="score-analysis-set-up.html"/>
<link rel="next" href="testing.html"/>
<script src="libs/header-attrs-2.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#directory-framework"><i class="fa fa-check"></i><b>1.1</b> Directory Framework</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="quality-control.html"><a href="quality-control.html"><i class="fa fa-check"></i><b>2</b> Quality Control</a>
<ul>
<li class="chapter" data-level="2.1" data-path="quality-control.html"><a href="quality-control.html#previously-applied-qc"><i class="fa fa-check"></i><b>2.1</b> Previously Applied QC</a></li>
<li class="chapter" data-level="2.2" data-path="quality-control.html"><a href="quality-control.html#initial-qc"><i class="fa fa-check"></i><b>2.2</b> Initial QC</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="summary-statistics.html"><a href="summary-statistics.html"><i class="fa fa-check"></i><b>3</b> Summary Statistics</a></li>
<li class="chapter" data-level="4" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html"><i class="fa fa-check"></i><b>4</b> Getting the Summary Statistics</a>
<ul>
<li class="chapter" data-level="4.1" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#prepare-variants"><i class="fa fa-check"></i><b>4.1</b> Prepare Variants</a></li>
<li class="chapter" data-level="4.2" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#standardize-the-summary-statistics"><i class="fa fa-check"></i><b>4.2</b> Standardize the Summary Statistics</a></li>
<li class="chapter" data-level="4.3" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#heritability-estimation"><i class="fa fa-check"></i><b>4.3</b> Heritability Estimation</a></li>
<li class="chapter" data-level="4.4" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#genetic-correlation-estimation"><i class="fa fa-check"></i><b>4.4</b> Genetic Correlation Estimation</a></li>
<li class="chapter" data-level="4.5" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#final-changes-and-remarks"><i class="fa fa-check"></i><b>4.5</b> Final Changes and Remarks</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html"><i class="fa fa-check"></i><b>5</b> Adjusting Summary Statistics</a>
<ul>
<li class="chapter" data-level="5.0.1" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#computational-framework"><i class="fa fa-check"></i><b>5.0.1</b> Computational Framework</a></li>
<li class="chapter" data-level="5.1" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#simple"><i class="fa fa-check"></i><b>5.1</b> Simple</a></li>
<li class="chapter" data-level="5.2" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#clumping"><i class="fa fa-check"></i><b>5.2</b> Clumping</a></li>
<li class="chapter" data-level="5.3" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#double-weight"><i class="fa fa-check"></i><b>5.3</b> Double Weight</a></li>
<li class="chapter" data-level="5.4" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#ldpred"><i class="fa fa-check"></i><b>5.4</b> LDpred</a></li>
<li class="chapter" data-level="5.5" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#ldpred2"><i class="fa fa-check"></i><b>5.5</b> LDpred2</a></li>
<li class="chapter" data-level="5.6" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#sblup"><i class="fa fa-check"></i><b>5.6</b> SBLUP</a></li>
<li class="chapter" data-level="5.7" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#smtpred"><i class="fa fa-check"></i><b>5.7</b> SMTpred</a></li>
<li class="chapter" data-level="5.8" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#prscs"><i class="fa fa-check"></i><b>5.8</b> prsCS</a></li>
<li class="chapter" data-level="5.9" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#lassosum"><i class="fa fa-check"></i><b>5.9</b> lassosum</a></li>
<li class="chapter" data-level="5.10" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#tweedie"><i class="fa fa-check"></i><b>5.10</b> Tweedie</a></li>
<li class="chapter" data-level="5.11" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#sbayesr"><i class="fa fa-check"></i><b>5.11</b> SBayesR</a></li>
<li class="chapter" data-level="5.12" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#jampred"><i class="fa fa-check"></i><b>5.12</b> JAMPred</a></li>
<li class="chapter" data-level="5.13" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#winners-curse-lasso"><i class="fa fa-check"></i><b>5.13</b> Winner’s Curse Lasso</a></li>
<li class="chapter" data-level="5.14" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#winners-curse-likelihood"><i class="fa fa-check"></i><b>5.14</b> Winner’s Curse Likelihood</a></li>
<li class="chapter" data-level="5.15" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#winners-curse-2d"><i class="fa fa-check"></i><b>5.15</b> Winner’s Curse 2D</a>
<ul>
<li class="chapter" data-level="5.15.1" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#additional-methods"><i class="fa fa-check"></i><b>5.15.1</b> Additional Methods</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html"><i class="fa fa-check"></i><b>6</b> Compiling the Scores</a>
<ul>
<li class="chapter" data-level="6.1" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#simple-score-approach"><i class="fa fa-check"></i><b>6.1</b> Simple Score Approach</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#what-to-worry-about"><i class="fa fa-check"></i><b>6.1.1</b> What to Worry About</a></li>
<li class="chapter" data-level="6.1.2" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#controlling-and-assembling"><i class="fa fa-check"></i><b>6.1.2</b> Controlling and Assembling</a></li>
<li class="chapter" data-level="6.1.3" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#verifying-everything-worked"><i class="fa fa-check"></i><b>6.1.3</b> Verifying Everything Worked</a></li>
<li class="chapter" data-level="6.1.4" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#other-options"><i class="fa fa-check"></i><b>6.1.4</b> Other Options</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html"><i class="fa fa-check"></i><b>7</b> Score Analysis Set-Up</a>
<ul>
<li class="chapter" data-level="7.1" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html#defining-the-phenotypes"><i class="fa fa-check"></i><b>7.1</b> Defining the Phenotypes</a></li>
<li class="chapter" data-level="7.2" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html#making-the-phenotype"><i class="fa fa-check"></i><b>7.2</b> Making the Phenotype</a></li>
<li class="chapter" data-level="7.3" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html#other-scores"><i class="fa fa-check"></i><b>7.3</b> Other Scores</a></li>
<li class="chapter" data-level="7.4" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html#other-covariates"><i class="fa fa-check"></i><b>7.4</b> Other Covariates</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="tuning.html"><a href="tuning.html"><i class="fa fa-check"></i><b>8</b> Tuning</a>
<ul>
<li class="chapter" data-level="8.1" data-path="tuning.html"><a href="tuning.html#generating-metrics"><i class="fa fa-check"></i><b>8.1</b> Generating Metrics</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="tuning.html"><a href="tuning.html#overall-set-up"><i class="fa fa-check"></i><b>8.1.1</b> Overall Set-Up</a></li>
<li class="chapter" data-level="8.1.2" data-path="tuning.html"><a href="tuning.html#survival-set-up"><i class="fa fa-check"></i><b>8.1.2</b> Survival Set-up</a></li>
<li class="chapter" data-level="8.1.3" data-path="tuning.html"><a href="tuning.html#survival-base-metrics"><i class="fa fa-check"></i><b>8.1.3</b> Survival Base Metrics</a></li>
<li class="chapter" data-level="8.1.4" data-path="tuning.html"><a href="tuning.html#survival-score-metrics"><i class="fa fa-check"></i><b>8.1.4</b> Survival Score Metrics</a></li>
<li class="chapter" data-level="8.1.5" data-path="tuning.html"><a href="tuning.html#logistic-regression-base-metrics"><i class="fa fa-check"></i><b>8.1.5</b> Logistic Regression Base Metrics</a></li>
<li class="chapter" data-level="8.1.6" data-path="tuning.html"><a href="tuning.html#logistic-regression-score-metrics"><i class="fa fa-check"></i><b>8.1.6</b> Logistic Regression Score Metrics</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="tuning.html"><a href="tuning.html#choosing-the-best-score"><i class="fa fa-check"></i><b>8.2</b> Choosing the Best Score</a></li>
<li class="chapter" data-level="8.3" data-path="tuning.html"><a href="tuning.html#plotting"><i class="fa fa-check"></i><b>8.3</b> Plotting</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="testing.html"><a href="testing.html"><i class="fa fa-check"></i><b>9</b> Testing</a>
<ul>
<li class="chapter" data-level="9.1" data-path="testing.html"><a href="testing.html#obtaining-the-statistics"><i class="fa fa-check"></i><b>9.1</b> Obtaining the Statistics</a></li>
<li class="chapter" data-level="9.2" data-path="testing.html"><a href="testing.html#plotting-1"><i class="fa fa-check"></i><b>9.2</b> Plotting</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="testing.html"><a href="testing.html#concordance"><i class="fa fa-check"></i><b>9.2.1</b> Concordance</a></li>
<li class="chapter" data-level="9.2.2" data-path="testing.html"><a href="testing.html#survival-curve-fit"><i class="fa fa-check"></i><b>9.2.2</b> Survival Curve Fit</a></li>
<li class="chapter" data-level="9.2.3" data-path="testing.html"><a href="testing.html#roc-and-auc"><i class="fa fa-check"></i><b>9.2.3</b> ROC and AUC</a></li>
<li class="chapter" data-level="9.2.4" data-path="testing.html"><a href="testing.html#odds-ratios"><i class="fa fa-check"></i><b>9.2.4</b> Odds Ratios</a></li>
<li class="chapter" data-level="9.2.5" data-path="testing.html"><a href="testing.html#pr-curves"><i class="fa fa-check"></i><b>9.2.5</b> PR Curves</a></li>
<li class="chapter" data-level="9.2.6" data-path="testing.html"><a href="testing.html#other-scores-1"><i class="fa fa-check"></i><b>9.2.6</b> Other Scores</a></li>
<li class="chapter" data-level="9.2.7" data-path="testing.html"><a href="testing.html#extra-covariates"><i class="fa fa-check"></i><b>9.2.7</b> Extra Covariates</a></li>
<li class="chapter" data-level="9.2.8" data-path="testing.html"><a href="testing.html#saving"><i class="fa fa-check"></i><b>9.2.8</b> Saving</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html"><i class="fa fa-check"></i><b>10</b> Additional Testing Statistics</a>
<ul>
<li class="chapter" data-level="10.1" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#calculating-the-statistics"><i class="fa fa-check"></i><b>10.1</b> Calculating the Statistics</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#brier-score"><i class="fa fa-check"></i><b>10.1.1</b> Brier Score</a></li>
<li class="chapter" data-level="10.1.2" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#reclassification-statistics-nri-and-idi"><i class="fa fa-check"></i><b>10.1.2</b> Reclassification Statistics (NRI and IDI)</a></li>
<li class="chapter" data-level="10.1.3" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#true-and-false-positive-rates"><i class="fa fa-check"></i><b>10.1.3</b> True and False Positive Rates</a></li>
<li class="chapter" data-level="10.1.4" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#reclassification-values"><i class="fa fa-check"></i><b>10.1.4</b> Reclassification Values</a></li>
<li class="chapter" data-level="10.1.5" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#decision-curve-analyses"><i class="fa fa-check"></i><b>10.1.5</b> Decision Curve Analyses</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="additional-testing-statistics.html"><a href="additional-testing-statistics.html#making-the-plots"><i class="fa fa-check"></i><b>10.2</b> Making the Plots</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html"><i class="fa fa-check"></i><b>11</b> Non-Predictive Evaluation</a>
<ul>
<li class="chapter" data-level="11.1" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#individual-score-evaluation"><i class="fa fa-check"></i><b>11.1</b> Individual Score Evaluation</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#set-up"><i class="fa fa-check"></i><b>11.1.1</b> Set Up</a></li>
<li class="chapter" data-level="11.1.2" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#analysis-of-score-sizes"><i class="fa fa-check"></i><b>11.1.2</b> Analysis of Score Sizes</a></li>
<li class="chapter" data-level="11.1.3" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#analysis-of-phenotype-definitions"><i class="fa fa-check"></i><b>11.1.3</b> Analysis of Phenotype Definitions</a></li>
<li class="chapter" data-level="11.1.4" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#comparison-between-the-sexes"><i class="fa fa-check"></i><b>11.1.4</b> Comparison Between the Sexes</a></li>
<li class="chapter" data-level="11.1.5" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#comparison-of-ethnic-groups"><i class="fa fa-check"></i><b>11.1.5</b> Comparison of Ethnic Groups</a></li>
<li class="chapter" data-level="11.1.6" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#comparison-of-siblings"><i class="fa fa-check"></i><b>11.1.6</b> Comparison of Siblings</a></li>
<li class="chapter" data-level="11.1.7" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#comparison-of-age"><i class="fa fa-check"></i><b>11.1.7</b> Comparison of Age</a></li>
<li class="chapter" data-level="11.1.8" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#comparison-of-many-other"><i class="fa fa-check"></i><b>11.1.8</b> Comparison of Many Other</a></li>
<li class="chapter" data-level="11.1.9" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#plotting-2"><i class="fa fa-check"></i><b>11.1.9</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="to-do.html"><a href="to-do.html"><i class="fa fa-check"></i><b>12</b> To Do</a>
<ul>
<li class="chapter" data-level="12.1" data-path="to-do.html"><a href="to-do.html#across-score-evaluations"><i class="fa fa-check"></i><b>12.1</b> Across Score Evaluations</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="to-do.html"><a href="to-do.html#set-up-1"><i class="fa fa-check"></i><b>12.1.1</b> Set-Up</a></li>
<li class="chapter" data-level="12.1.2" data-path="to-do.html"><a href="to-do.html#meta-info-regressions"><i class="fa fa-check"></i><b>12.1.2</b> Meta Info Regressions</a></li>
<li class="chapter" data-level="12.1.3" data-path="to-do.html"><a href="to-do.html#testing-and-training-comparison"><i class="fa fa-check"></i><b>12.1.3</b> Testing and Training Comparison</a></li>
<li class="chapter" data-level="12.1.4" data-path="to-do.html"><a href="to-do.html#plotting-3"><i class="fa fa-check"></i><b>12.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html"><i class="fa fa-check"></i><b>13</b> Lifestyle and Medications</a>
<ul>
<li class="chapter" data-level="13.1" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#lifestyle-modifcations"><i class="fa fa-check"></i><b>13.1</b> Lifestyle Modifcations</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#getting-the-statistics"><i class="fa fa-check"></i><b>13.1.1</b> Getting the Statistics</a></li>
<li class="chapter" data-level="13.1.2" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#plotting-4"><i class="fa fa-check"></i><b>13.1.2</b> Plotting</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#medications"><i class="fa fa-check"></i><b>13.2</b> Medications</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#set-up-2"><i class="fa fa-check"></i><b>13.2.1</b> Set Up</a></li>
<li class="chapter" data-level="13.2.2" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#meications"><i class="fa fa-check"></i><b>13.2.2</b> Meications</a></li>
<li class="chapter" data-level="13.2.3" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#analysis"><i class="fa fa-check"></i><b>13.2.3</b> Analysis</a></li>
<li class="chapter" data-level="13.2.4" data-path="lifestyle-and-medications.html"><a href="lifestyle-and-medications.html#change-in-plans"><i class="fa fa-check"></i><b>13.2.4</b> Change in Plans</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Comparison of PGS Generative Methods</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tuning" class="section level1" number="8">
<h1><span class="header-section-number">8</span> Tuning</h1>
<p>Tuning is the process of converting the large array of polygenic risk scores into a single recommendation of the best polygenic risk score. To understand the motivation behind this section we have to broaden our understanding of the purpose of this study. So far this study has focused on evaluating methods that produce polygenic risk scores. However, these scores and the underlying methods are only as good as their absolute risk stratification, not a relative performance to the other methods. If we analyzed the entire dataset with all scores to generate this absolute performance we would be overfitting the data, as the best score might have simply benefitted from the random split of data rather than actually being the best (just the same as a false positive in a t-test). Therefore we must split the data such that only one score is ever allowed to access part of the data. This way we will not get any overfitting.</p>
<p>Now that we understand the importance of tuning, or finding the best score on a subset of the data we move onto a large challenge of determining how to choose the best. While there are likely hundreds of metrics we can apply I have resolved to two forms of analyses for two different purposes. The first purpose is using the score as a covariate in downstream models that show links between the genetics of the score’s trait and some other trait or event. The second purpose is using the score to stratify a cohort of individuals such that one subset achieves high enough risk that they warrant different treatment than the remaining subset. In the first purpose we would likely want the score to be well performing for all possible individuals, in the second purpose we only really need the score to work well at the far tails. Now onto the two forms of analyses. The first form is logistic regression, as it is simple, used before, and generates metrics that can easily be interpreted by nearly everyone. The second form is cox proportional hazard models, a slightly more advanced technique that takes into account the progression of time (a very important cause of disease and consideration in treatment). For our first and second purpose in logistic regression the logical metrics are AUC and odds ratio. There are other similar things we can measure but they will ultimately be measuring nearly the same thing. For our first and second purpose in logistic regression the logical metrics are concordance and cumulative incidence. What point in time should we choose for a point cumulative incidence seems logically unclear, so I went with the last possible time point. Now that we have the metrics we want to make there is only one more key consideration.</p>
<p>There are multiple different ways (in general) to create the metrics. The most basic would be to fit the model on all data possible and use the model to make a prediction upon the same data. This is simple and fast, but does not well recreate the scenario we will have when analyzing the testing data, where we form the model on one set of data then make a prediction on another set. Therefore we should go about some form of cross validation within our training dataset. Simple cross validation is nice, as it is again simple and fast, however with such small sample sizes we will only be able to run 3 folds leaving a very high variance in our metrics. In the effort to keep bias low while also lowering the variance I have decided to use repeated cross validation. In short 3-fold cross validation is run multiple times, each time picking a different way to splice up the data. Each person will still be used the same number of times as everyone else, it is just the group that person is with will change.</p>
<p>As this code is both important and potentially confusing I will explain each part in turn. (Although before I do I want to lastly note that the code used to generate the results looks very slightly different as the base and score models are grouped together more tightly. This makes computation faster but it becomes harder to exaplin. If you want to see the other code please check out my GitHub.</p>
<div id="generating-metrics" class="section level2" number="8.1">
<h2><span class="header-section-number">8.1</span> Generating Metrics</h2>
<div id="overall-set-up" class="section level3" number="8.1.1">
<h3><span class="header-section-number">8.1.1</span> Overall Set-Up</h3>
<p>The first part of our tuning script involves reading all nescessary data and generally sorting it. Although before we even do that we set-up some basic parameters including the name of the trait we are analyzing, the train/test split we are implementing across the entire UK Biobank, and lastly the number of folds and repeats within our cross validation scheme. We start our reading with the scores. After subsetting and combining them all into one object we apply a simple normalization that for each score value makes the lowest possible value 1 and highest value 100. We then read in the dates and convert them to R date format, which is tricky because there are different formats in different columns. We then condense these six columns down to one based upon which phenotype definition we are using. After completion we read in corresponding eids so the dates and phenotypes can be sorted correctly. Nearly at the end we read in raw death data, adding a dummy date for all people who are not within the death data. This way we can sort the death object so it lines up with everything else. Lastly we read in censor data and subset then sort.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="tuning.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb87-2"><a href="tuning.html#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb87-3"><a href="tuning.html#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(epitools)</span>
<span id="cb87-4"><a href="tuning.html#cb87-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-5"><a href="tuning.html#cb87-5" aria-hidden="true" tabindex="-1"></a>author <span class="ot">&lt;-</span> <span class="st">&quot;IMSGC&quot;</span></span>
<span id="cb87-6"><a href="tuning.html#cb87-6" aria-hidden="true" tabindex="-1"></a>phen_method <span class="ot">&lt;-</span> <span class="st">&quot;all&quot;</span></span>
<span id="cb87-7"><a href="tuning.html#cb87-7" aria-hidden="true" tabindex="-1"></a>subrate_style <span class="ot">&lt;-</span> <span class="st">&quot;fast&quot;</span></span>
<span id="cb87-8"><a href="tuning.html#cb87-8" aria-hidden="true" tabindex="-1"></a>train_frac <span class="ot">&lt;-</span> <span class="fl">0.6</span></span>
<span id="cb87-9"><a href="tuning.html#cb87-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-10"><a href="tuning.html#cb87-10" aria-hidden="true" tabindex="-1"></a>input_folds <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb87-11"><a href="tuning.html#cb87-11" aria-hidden="true" tabindex="-1"></a>input_repeats <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb87-12"><a href="tuning.html#cb87-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-13"><a href="tuning.html#cb87-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-14"><a href="tuning.html#cb87-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-15"><a href="tuning.html#cb87-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-16"><a href="tuning.html#cb87-16" aria-hidden="true" tabindex="-1"></a><span class="co">#Read in the PGSs and sort down to training</span></span>
<span id="cb87-17"><a href="tuning.html#cb87-17" aria-hidden="true" tabindex="-1"></a>all_scores <span class="ot">&lt;-</span>  <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">&quot;../../do_score/final_scores/all_score.&quot;</span>, <span class="fu">tolower</span>(author), <span class="st">&quot;.RDS&quot;</span>))</span>
<span id="cb87-18"><a href="tuning.html#cb87-18" aria-hidden="true" tabindex="-1"></a>all_eid <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;~/athena/doc_score/do_score/all_specs/for_eid.fam&quot;</span>, <span class="at">stringsAsFactors=</span>F)</span>
<span id="cb87-19"><a href="tuning.html#cb87-19" aria-hidden="true" tabindex="-1"></a>train_eid <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">paste0</span>(<span class="st">&quot;~/athena/doc_score/qc/cv_files/train_eid.&quot;</span>, train_frac, <span class="st">&quot;.txt&quot;</span>), <span class="at">stringsAsFactors=</span>F)</span>
<span id="cb87-20"><a href="tuning.html#cb87-20" aria-hidden="true" tabindex="-1"></a>all_scores <span class="ot">&lt;-</span> all_scores[all_eid[,<span class="dv">1</span>] <span class="sc">%in%</span> train_eid[,<span class="dv">1</span>],]</span>
<span id="cb87-21"><a href="tuning.html#cb87-21" aria-hidden="true" tabindex="-1"></a>eid <span class="ot">&lt;-</span> all_eid[all_eid[,<span class="dv">1</span>] <span class="sc">%in%</span> train_eid[,<span class="dv">1</span>],<span class="dv">1</span>]</span>
<span id="cb87-22"><a href="tuning.html#cb87-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-23"><a href="tuning.html#cb87-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-24"><a href="tuning.html#cb87-24" aria-hidden="true" tabindex="-1"></a><span class="co">#Normalize the scores</span></span>
<span id="cb87-25"><a href="tuning.html#cb87-25" aria-hidden="true" tabindex="-1"></a>scores <span class="ot">&lt;-</span> all_scores[,<span class="fu">grepl</span>(<span class="fu">tolower</span>(author), <span class="fu">colnames</span>(all_scores))]</span>
<span id="cb87-26"><a href="tuning.html#cb87-26" aria-hidden="true" tabindex="-1"></a>scores <span class="ot">&lt;-</span> scores[,<span class="fu">apply</span>(scores, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">length</span>(<span class="fu">unique</span>(x)) <span class="sc">&gt;</span> <span class="dv">3</span>)]</span>
<span id="cb87-27"><a href="tuning.html#cb87-27" aria-hidden="true" tabindex="-1"></a>scores <span class="ot">&lt;-</span> <span class="fu">apply</span>(scores, <span class="dv">2</span>, <span class="cf">function</span>(x) (x<span class="sc">-</span><span class="fu">mean</span>(x)) <span class="sc">/</span> (<span class="fu">max</span>(<span class="fu">abs</span>((x<span class="sc">-</span><span class="fu">mean</span>(x)))) <span class="sc">*</span> <span class="fl">0.01</span>) )</span>
<span id="cb87-28"><a href="tuning.html#cb87-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-29"><a href="tuning.html#cb87-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-30"><a href="tuning.html#cb87-30" aria-hidden="true" tabindex="-1"></a><span class="co">#Read in the phenotypes, order is: cancer sr, noncancer sr, icd9, icd10, oper, meds</span></span>
<span id="cb87-31"><a href="tuning.html#cb87-31" aria-hidden="true" tabindex="-1"></a><span class="co">#selfasses date: 2018-11-22; hesin date: 21/01/2000</span></span>
<span id="cb87-32"><a href="tuning.html#cb87-32" aria-hidden="true" tabindex="-1"></a>pheno <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">paste0</span>(<span class="st">&quot;../construct_defs/pheno_defs/diag.&quot;</span>, <span class="fu">tolower</span>(author), <span class="st">&quot;.txt.gz&quot;</span>), <span class="at">stringsAsFactors=</span>F)</span>
<span id="cb87-33"><a href="tuning.html#cb87-33" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">paste0</span>(<span class="st">&quot;../construct_defs/pheno_defs/time.&quot;</span>, <span class="fu">tolower</span>(author), <span class="st">&quot;.txt.gz&quot;</span>), <span class="at">stringsAsFactors=</span>F)</span>
<span id="cb87-34"><a href="tuning.html#cb87-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(dates)){</span>
<span id="cb87-35"><a href="tuning.html#cb87-35" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(i <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">6</span>)){</span>
<span id="cb87-36"><a href="tuning.html#cb87-36" aria-hidden="true" tabindex="-1"></a>  dates[dates[,i] <span class="sc">==</span> <span class="st">&quot;__________&quot;</span>, i] <span class="ot">&lt;-</span> <span class="st">&quot;2020-12-31&quot;</span></span>
<span id="cb87-37"><a href="tuning.html#cb87-37" aria-hidden="true" tabindex="-1"></a>  dates[,i] <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(dates[,i], <span class="st">&quot;%Y-%m-%d&quot;</span>)</span>
<span id="cb87-38"><a href="tuning.html#cb87-38" aria-hidden="true" tabindex="-1"></a> } <span class="cf">else</span> {</span>
<span id="cb87-39"><a href="tuning.html#cb87-39" aria-hidden="true" tabindex="-1"></a>  dates[dates[,i] <span class="sc">==</span> <span class="st">&quot;__________&quot;</span>, i] <span class="ot">&lt;-</span> <span class="st">&quot;31/12/2020&quot;</span></span>
<span id="cb87-40"><a href="tuning.html#cb87-40" aria-hidden="true" tabindex="-1"></a>  dates[,i] <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(dates[,i], <span class="st">&quot;%d/%m/%Y&quot;</span>)</span>
<span id="cb87-41"><a href="tuning.html#cb87-41" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb87-42"><a href="tuning.html#cb87-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb87-43"><a href="tuning.html#cb87-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-44"><a href="tuning.html#cb87-44" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(phen_method <span class="sc">==</span> <span class="st">&quot;icd&quot;</span>){</span>
<span id="cb87-45"><a href="tuning.html#cb87-45" aria-hidden="true" tabindex="-1"></a> pheno <span class="ot">&lt;-</span> pheno[,<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb87-46"><a href="tuning.html#cb87-46" aria-hidden="true" tabindex="-1"></a> dates <span class="ot">&lt;-</span> dates[,<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb87-47"><a href="tuning.html#cb87-47" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(phen_method <span class="sc">==</span> <span class="st">&quot;selfrep&quot;</span>){</span>
<span id="cb87-48"><a href="tuning.html#cb87-48" aria-hidden="true" tabindex="-1"></a> pheno <span class="ot">&lt;-</span> pheno[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb87-49"><a href="tuning.html#cb87-49" aria-hidden="true" tabindex="-1"></a> dates <span class="ot">&lt;-</span> dates[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb87-50"><a href="tuning.html#cb87-50" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(phen_method <span class="sc">==</span> <span class="st">&quot;icd_selfrep&quot;</span>){</span>
<span id="cb87-51"><a href="tuning.html#cb87-51" aria-hidden="true" tabindex="-1"></a> pheno <span class="ot">&lt;-</span> pheno[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb87-52"><a href="tuning.html#cb87-52" aria-hidden="true" tabindex="-1"></a> dates <span class="ot">&lt;-</span> dates[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb87-53"><a href="tuning.html#cb87-53" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(phen_method <span class="sc">==</span> <span class="st">&quot;all&quot;</span> <span class="sc">|</span> phen_method <span class="sc">==</span> <span class="st">&quot;double&quot;</span>){</span>
<span id="cb87-54"><a href="tuning.html#cb87-54" aria-hidden="true" tabindex="-1"></a> <span class="fu">print</span>(<span class="st">&quot;doing nothing&quot;</span>)</span>
<span id="cb87-55"><a href="tuning.html#cb87-55" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb87-56"><a href="tuning.html#cb87-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-57"><a href="tuning.html#cb87-57" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> <span class="fu">apply</span>(dates, <span class="dv">1</span>, min)</span>
<span id="cb87-58"><a href="tuning.html#cb87-58" aria-hidden="true" tabindex="-1"></a>dates[dates <span class="sc">==</span> <span class="fu">as.Date</span>(<span class="st">&quot;2020-12-31&quot;</span>)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb87-59"><a href="tuning.html#cb87-59" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(phen_method <span class="sc">==</span> <span class="st">&quot;double&quot;</span>){</span>
<span id="cb87-60"><a href="tuning.html#cb87-60" aria-hidden="true" tabindex="-1"></a> pheno <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(pheno)</span>
<span id="cb87-61"><a href="tuning.html#cb87-61" aria-hidden="true" tabindex="-1"></a> pheno[pheno <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb87-62"><a href="tuning.html#cb87-62" aria-hidden="true" tabindex="-1"></a> pheno[pheno <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb87-63"><a href="tuning.html#cb87-63" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb87-64"><a href="tuning.html#cb87-64" aria-hidden="true" tabindex="-1"></a> dates[pheno <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb87-65"><a href="tuning.html#cb87-65" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb87-66"><a href="tuning.html#cb87-66" aria-hidden="true" tabindex="-1"></a> pheno <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(pheno)</span>
<span id="cb87-67"><a href="tuning.html#cb87-67" aria-hidden="true" tabindex="-1"></a> pheno[pheno <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb87-68"><a href="tuning.html#cb87-68" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb87-69"><a href="tuning.html#cb87-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-70"><a href="tuning.html#cb87-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-71"><a href="tuning.html#cb87-71" aria-hidden="true" tabindex="-1"></a><span class="co">#Read in the eids used that are the same order as the pheno and dates, then subset the pheno and dates accordingly</span></span>
<span id="cb87-72"><a href="tuning.html#cb87-72" aria-hidden="true" tabindex="-1"></a>pheno_eids <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;../construct_defs/eid.csv&quot;</span>, <span class="at">header =</span> T)</span>
<span id="cb87-73"><a href="tuning.html#cb87-73" aria-hidden="true" tabindex="-1"></a>pheno_eids <span class="ot">&lt;-</span> pheno_eids[<span class="fu">order</span>(pheno_eids[,<span class="dv">1</span>]),]</span>
<span id="cb87-74"><a href="tuning.html#cb87-74" aria-hidden="true" tabindex="-1"></a>pheno_eids <span class="ot">&lt;-</span> pheno_eids[<span class="sc">-</span><span class="fu">length</span>(pheno_eids)]</span>
<span id="cb87-75"><a href="tuning.html#cb87-75" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> dates[pheno_eids <span class="sc">%in%</span> eid]</span>
<span id="cb87-76"><a href="tuning.html#cb87-76" aria-hidden="true" tabindex="-1"></a>pheno <span class="ot">&lt;-</span> pheno[pheno_eids <span class="sc">%in%</span> eid]</span>
<span id="cb87-77"><a href="tuning.html#cb87-77" aria-hidden="true" tabindex="-1"></a>pheno_eids <span class="ot">&lt;-</span> pheno_eids[pheno_eids <span class="sc">%in%</span> eid]</span>
<span id="cb87-78"><a href="tuning.html#cb87-78" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> dates[<span class="fu">order</span>(pheno_eids)[<span class="fu">rank</span>(eid)]]</span>
<span id="cb87-79"><a href="tuning.html#cb87-79" aria-hidden="true" tabindex="-1"></a>pheno <span class="ot">&lt;-</span> pheno[<span class="fu">order</span>(pheno_eids)[<span class="fu">rank</span>(eid)]]</span>
<span id="cb87-80"><a href="tuning.html#cb87-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-81"><a href="tuning.html#cb87-81" aria-hidden="true" tabindex="-1"></a><span class="co">#Read in the base covars</span></span>
<span id="cb87-82"><a href="tuning.html#cb87-82" aria-hidden="true" tabindex="-1"></a>covars <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../get_covars/base_covars.RDS&quot;</span>)</span>
<span id="cb87-83"><a href="tuning.html#cb87-83" aria-hidden="true" tabindex="-1"></a>covars <span class="ot">&lt;-</span> covars[covars[,<span class="dv">1</span>] <span class="sc">%in%</span> eid,]</span>
<span id="cb87-84"><a href="tuning.html#cb87-84" aria-hidden="true" tabindex="-1"></a>covars <span class="ot">&lt;-</span> covars[<span class="fu">order</span>(covars[,<span class="dv">1</span>])[<span class="fu">rank</span>(eid)],]</span>
<span id="cb87-85"><a href="tuning.html#cb87-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-86"><a href="tuning.html#cb87-86" aria-hidden="true" tabindex="-1"></a><span class="co">#Set up survival analysis data frame</span></span>
<span id="cb87-87"><a href="tuning.html#cb87-87" aria-hidden="true" tabindex="-1"></a><span class="co">#Artifically decide start date is 1999, that way all are even, if date is prior then remove it</span></span>
<span id="cb87-88"><a href="tuning.html#cb87-88" aria-hidden="true" tabindex="-1"></a><span class="co">#The current maximum date possible is 31 May 2020</span></span>
<span id="cb87-89"><a href="tuning.html#cb87-89" aria-hidden="true" tabindex="-1"></a>death <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;~/athena/ukbiobank/hesin/death.txt&quot;</span>, <span class="at">stringsAsFactors=</span>F, <span class="at">header =</span> T)</span>
<span id="cb87-90"><a href="tuning.html#cb87-90" aria-hidden="true" tabindex="-1"></a>death[,<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(death[,<span class="dv">5</span>], <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="fu">strsplit</span>(x, <span class="st">&quot;/&quot;</span>)[[<span class="dv">1</span>]][<span class="dv">3</span>], <span class="st">&quot;-&quot;</span>, <span class="fu">strsplit</span>(x, <span class="st">&quot;/&quot;</span>)[[<span class="dv">1</span>]][<span class="dv">2</span>], <span class="st">&quot;-&quot;</span>, <span class="fu">strsplit</span>(x, <span class="st">&quot;/&quot;</span>)[[<span class="dv">1</span>]][<span class="dv">1</span>])))</span>
<span id="cb87-91"><a href="tuning.html#cb87-91" aria-hidden="true" tabindex="-1"></a>death <span class="ot">&lt;-</span> death[<span class="sc">!</span><span class="fu">duplicated</span>(death[,<span class="dv">1</span>]),]</span>
<span id="cb87-92"><a href="tuning.html#cb87-92" aria-hidden="true" tabindex="-1"></a>death <span class="ot">&lt;-</span> death[death[,<span class="dv">1</span>] <span class="sc">%in%</span> eid,]</span>
<span id="cb87-93"><a href="tuning.html#cb87-93" aria-hidden="true" tabindex="-1"></a>add_on <span class="ot">&lt;-</span> death[<span class="dv">1</span>,]</span>
<span id="cb87-94"><a href="tuning.html#cb87-94" aria-hidden="true" tabindex="-1"></a>add_on[<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="st">&quot;&quot;</span></span>
<span id="cb87-95"><a href="tuning.html#cb87-95" aria-hidden="true" tabindex="-1"></a>add_eid <span class="ot">&lt;-</span> eid[<span class="sc">!</span>(eid <span class="sc">%in%</span> death[,<span class="dv">1</span>])]</span>
<span id="cb87-96"><a href="tuning.html#cb87-96" aria-hidden="true" tabindex="-1"></a>add_on <span class="ot">&lt;-</span> add_on[<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(add_eid)),]</span>
<span id="cb87-97"><a href="tuning.html#cb87-97" aria-hidden="true" tabindex="-1"></a>add_on<span class="sc">$</span>eid <span class="ot">&lt;-</span> add_eid</span>
<span id="cb87-98"><a href="tuning.html#cb87-98" aria-hidden="true" tabindex="-1"></a>death <span class="ot">&lt;-</span> <span class="fu">rbind</span>(death, add_on)</span>
<span id="cb87-99"><a href="tuning.html#cb87-99" aria-hidden="true" tabindex="-1"></a>death <span class="ot">&lt;-</span> death[<span class="fu">order</span>(death[,<span class="dv">1</span>])[<span class="fu">rank</span>(eid)],]</span>
<span id="cb87-100"><a href="tuning.html#cb87-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-101"><a href="tuning.html#cb87-101" aria-hidden="true" tabindex="-1"></a>censor <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;../get_covars/covar_data/censor_covars&quot;</span>, <span class="at">stringsAsFactors=</span>F, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb87-102"><a href="tuning.html#cb87-102" aria-hidden="true" tabindex="-1"></a>censor <span class="ot">&lt;-</span> censor[censor[,<span class="dv">1</span>] <span class="sc">%in%</span> eid,]</span>
<span id="cb87-103"><a href="tuning.html#cb87-103" aria-hidden="true" tabindex="-1"></a>censor <span class="ot">&lt;-</span> censor[<span class="fu">order</span>(censor[,<span class="dv">1</span>])[<span class="fu">rank</span>(eid)],]</span></code></pre></div>
<p>At this point we have many different objects that are all lined up and the right size.</p>
</div>
<div id="survival-set-up" class="section level3" number="8.1.2">
<h3><span class="header-section-number">8.1.2</span> Survival Set-up</h3>
<p>The second part still involves set up, although now stop reading things in and move to forming a data frame for survival analysis. This process starts with establishing a start and end time for each person in our study. The start time is established within this doccumentation (<a href="http://biobank.ndph.ox.ac.uk/showcase/exinfo.cgi?src=Data_providers_and_dates" class="uri">http://biobank.ndph.ox.ac.uk/showcase/exinfo.cgi?src=Data_providers_and_dates</a>). However, I have noticed that there are very few records before 1999, so just to be safe I am removing anyone with a diagnosis before that time and establishing 1999 as the start point. The end date is established within this doccumentation (<a href="http://biobank.ndph.ox.ac.uk/showcase/exinfo.cgi?src=timelines_all" class="uri">http://biobank.ndph.ox.ac.uk/showcase/exinfo.cgi?src=timelines_all</a>) and at my time of analysis it was 5/31/2020. However not everyone made it to this date. So we shorten the end date for people who have died, asked to be censored, or experienced our phenotype of interest. We then compile the difference in start and end date, a recording of whether the person was censored and which type, and other important covariates. While this work so far should be enough for a survival analysis astute modelers may be worried about competing risks, or the idea that if someone dies even though they would have otherwise experienced our phenotype then the model is flawed. To solve this problem we use Fine-Gray models from the amazing R survival package. The finegray function changes our original survival analysis data frame so that it contains extra weights and rows so it can run within the coxph function and generate proper Fine-Gray model estimates. We then split up the fine gray data frame so it contains either all scores or no scores. The last major thing going on is setting up our repeated cross validation. We create lists of lists that contain the set of training and testing eids needing in each round of modeling.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="tuning.html#cb88-1" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&quot;1999-01-01&quot;</span>, <span class="fu">nrow</span>(scores))</span>
<span id="cb88-2"><a href="tuning.html#cb88-2" aria-hidden="true" tabindex="-1"></a>end_date <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&quot;2020-05-31&quot;</span>, <span class="fu">nrow</span>(scores))</span>
<span id="cb88-3"><a href="tuning.html#cb88-3" aria-hidden="true" tabindex="-1"></a>end_date[censor[,<span class="dv">2</span>] <span class="sc">!=</span> <span class="st">&quot;&quot;</span>] <span class="ot">&lt;-</span> censor[censor[,<span class="dv">2</span>] <span class="sc">!=</span> <span class="st">&quot;&quot;</span>, <span class="dv">2</span>]</span>
<span id="cb88-4"><a href="tuning.html#cb88-4" aria-hidden="true" tabindex="-1"></a>end_date[death[,<span class="dv">5</span>] <span class="sc">!=</span> <span class="st">&quot;&quot;</span>] <span class="ot">&lt;-</span> death[death[,<span class="dv">5</span>] <span class="sc">!=</span> <span class="st">&quot;&quot;</span>, <span class="dv">5</span>]</span>
<span id="cb88-5"><a href="tuning.html#cb88-5" aria-hidden="true" tabindex="-1"></a>end_date[<span class="sc">!</span><span class="fu">is.na</span>(dates)] <span class="ot">&lt;-</span> dates[<span class="sc">!</span><span class="fu">is.na</span>(dates)]</span>
<span id="cb88-6"><a href="tuning.html#cb88-6" aria-hidden="true" tabindex="-1"></a>remove_eids <span class="ot">&lt;-</span> pheno_eids[<span class="fu">as.Date</span>(dates) <span class="sc">&lt;</span> <span class="fu">as.Date</span>(<span class="st">&quot;1999-01-01&quot;</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(dates)]</span>
<span id="cb88-7"><a href="tuning.html#cb88-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-8"><a href="tuning.html#cb88-8" aria-hidden="true" tabindex="-1"></a>is_death_date <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(scores))</span>
<span id="cb88-9"><a href="tuning.html#cb88-9" aria-hidden="true" tabindex="-1"></a>is_death_date[death[,<span class="dv">5</span>] <span class="sc">!=</span> <span class="st">&quot;&quot;</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb88-10"><a href="tuning.html#cb88-10" aria-hidden="true" tabindex="-1"></a>surv_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(end_date) <span class="sc">-</span> <span class="fu">as.Date</span>(start_date)), pheno, is_death_date, covars)</span>
<span id="cb88-11"><a href="tuning.html#cb88-11" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(pheno, covars[,<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb88-12"><a href="tuning.html#cb88-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-13"><a href="tuning.html#cb88-13" aria-hidden="true" tabindex="-1"></a><span class="co">#need to remove people that had diagnosis before accepted start of the study</span></span>
<span id="cb88-14"><a href="tuning.html#cb88-14" aria-hidden="true" tabindex="-1"></a>scores <span class="ot">&lt;-</span> scores[surv_df<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">0</span>,]</span>
<span id="cb88-15"><a href="tuning.html#cb88-15" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[surv_df<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">0</span>,]</span>
<span id="cb88-16"><a href="tuning.html#cb88-16" aria-hidden="true" tabindex="-1"></a>covars <span class="ot">&lt;-</span> covars[surv_df<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">0</span>,]</span>
<span id="cb88-17"><a href="tuning.html#cb88-17" aria-hidden="true" tabindex="-1"></a>pheno <span class="ot">&lt;-</span> pheno[surv_df<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb88-18"><a href="tuning.html#cb88-18" aria-hidden="true" tabindex="-1"></a>surv_df <span class="ot">&lt;-</span> surv_df[surv_df<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">0</span>,]</span>
<span id="cb88-19"><a href="tuning.html#cb88-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-20"><a href="tuning.html#cb88-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-21"><a href="tuning.html#cb88-21" aria-hidden="true" tabindex="-1"></a><span class="co">#Set up Fine and Gray</span></span>
<span id="cb88-22"><a href="tuning.html#cb88-22" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&quot;finegray&quot;</span>)</span>
<span id="cb88-23"><a href="tuning.html#cb88-23" aria-hidden="true" tabindex="-1"></a>event_type <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&quot;censor&quot;</span>, <span class="fu">nrow</span>(surv_df))</span>
<span id="cb88-24"><a href="tuning.html#cb88-24" aria-hidden="true" tabindex="-1"></a>event_type[surv_df<span class="sc">$</span>pheno <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;diagnosis&quot;</span></span>
<span id="cb88-25"><a href="tuning.html#cb88-25" aria-hidden="true" tabindex="-1"></a>event_type[surv_df<span class="sc">$</span>is_death_date <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;death&quot;</span></span>
<span id="cb88-26"><a href="tuning.html#cb88-26" aria-hidden="true" tabindex="-1"></a>surv_df<span class="sc">$</span>event_type <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(event_type)</span>
<span id="cb88-27"><a href="tuning.html#cb88-27" aria-hidden="true" tabindex="-1"></a>fg_diag <span class="ot">&lt;-</span> <span class="fu">finegray</span>(<span class="fu">Surv</span>(time, event_type) <span class="sc">~</span> ., <span class="at">data =</span> <span class="fu">cbind</span>(surv_df[,<span class="sc">-</span><span class="fu">which</span>(<span class="fu">colnames</span>(surv_df) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;is_death_date&quot;</span>, <span class="st">&quot;pheno&quot;</span>))], scores), <span class="at">etype=</span><span class="st">&quot;diagnosis&quot;</span>)</span>
<span id="cb88-28"><a href="tuning.html#cb88-28" aria-hidden="true" tabindex="-1"></a>fg_death <span class="ot">&lt;-</span> <span class="fu">finegray</span>(<span class="fu">Surv</span>(time, event_type) <span class="sc">~</span> ., <span class="at">data =</span> <span class="fu">cbind</span>(surv_df[,<span class="sc">-</span><span class="fu">which</span>(<span class="fu">colnames</span>(surv_df) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;is_death_date&quot;</span>, <span class="st">&quot;pheno&quot;</span>))], scores), <span class="at">etype=</span><span class="st">&quot;death&quot;</span>)</span>
<span id="cb88-29"><a href="tuning.html#cb88-29" aria-hidden="true" tabindex="-1"></a>fg_scores_diag <span class="ot">&lt;-</span> fg_diag[,<span class="fu">grepl</span>(<span class="fu">tolower</span>(author), <span class="fu">colnames</span>(fg_diag))]</span>
<span id="cb88-30"><a href="tuning.html#cb88-30" aria-hidden="true" tabindex="-1"></a>fg_scores_death <span class="ot">&lt;-</span> fg_death[,<span class="fu">grepl</span>(<span class="fu">tolower</span>(author), <span class="fu">colnames</span>(fg_death))]</span>
<span id="cb88-31"><a href="tuning.html#cb88-31" aria-hidden="true" tabindex="-1"></a>fg_diag <span class="ot">&lt;-</span> fg_diag[,<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">&quot;ss&quot;</span>, <span class="fu">colnames</span>(fg_diag))]</span>
<span id="cb88-32"><a href="tuning.html#cb88-32" aria-hidden="true" tabindex="-1"></a>fg_death <span class="ot">&lt;-</span> fg_death[,<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">&quot;ss&quot;</span>, <span class="fu">colnames</span>(fg_death))]</span>
<span id="cb88-33"><a href="tuning.html#cb88-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-34"><a href="tuning.html#cb88-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-35"><a href="tuning.html#cb88-35" aria-hidden="true" tabindex="-1"></a><span class="co">#Need to set up repeated cross validation</span></span>
<span id="cb88-36"><a href="tuning.html#cb88-36" aria-hidden="true" tabindex="-1"></a>input_folds <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb88-37"><a href="tuning.html#cb88-37" aria-hidden="true" tabindex="-1"></a>input_repeats <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb88-38"><a href="tuning.html#cb88-38" aria-hidden="true" tabindex="-1"></a>size_group <span class="ot">&lt;-</span> <span class="fu">floor</span>(<span class="fu">nrow</span>(covars)<span class="sc">/</span>input_folds)</span>
<span id="cb88-39"><a href="tuning.html#cb88-39" aria-hidden="true" tabindex="-1"></a>start_spots <span class="ot">&lt;-</span> <span class="fu">floor</span>(<span class="fu">seq</span>(<span class="dv">1</span>, size_group, <span class="at">length.out=</span>input_repeats<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb88-40"><a href="tuning.html#cb88-40" aria-hidden="true" tabindex="-1"></a>repeat_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb88-41"><a href="tuning.html#cb88-41" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>input_repeats){</span>
<span id="cb88-42"><a href="tuning.html#cb88-42" aria-hidden="true" tabindex="-1"></a> folds_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb88-43"><a href="tuning.html#cb88-43" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>input_folds){</span>
<span id="cb88-44"><a href="tuning.html#cb88-44" aria-hidden="true" tabindex="-1"></a>  test_group <span class="ot">&lt;-</span> eid[(start_spots[i]<span class="sc">+</span>((j<span class="dv">-1</span>)<span class="sc">*</span>size_group))<span class="sc">:</span>(start_spots[i]<span class="sc">+</span>(j<span class="sc">*</span>size_group))]</span>
<span id="cb88-45"><a href="tuning.html#cb88-45" aria-hidden="true" tabindex="-1"></a>  train_group <span class="ot">&lt;-</span> eid[<span class="sc">!</span>(eid <span class="sc">%in%</span> test_group)]</span>
<span id="cb88-46"><a href="tuning.html#cb88-46" aria-hidden="true" tabindex="-1"></a>  train_group <span class="ot">&lt;-</span> train_group[<span class="sc">!</span>(train_group <span class="sc">%in%</span> remove_eids)]</span>
<span id="cb88-47"><a href="tuning.html#cb88-47" aria-hidden="true" tabindex="-1"></a>  test_group <span class="ot">&lt;-</span> test_group[<span class="sc">!</span>(test_group <span class="sc">%in%</span> remove_eids)]</span>
<span id="cb88-48"><a href="tuning.html#cb88-48" aria-hidden="true" tabindex="-1"></a>  folds_list[[j]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;train&quot;</span> <span class="ot">=</span> train_group, <span class="st">&quot;test&quot;</span> <span class="ot">=</span> test_group)</span>
<span id="cb88-49"><a href="tuning.html#cb88-49" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb88-50"><a href="tuning.html#cb88-50" aria-hidden="true" tabindex="-1"></a> repeat_list[[i]] <span class="ot">&lt;-</span> folds_list</span>
<span id="cb88-51"><a href="tuning.html#cb88-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb88-52"><a href="tuning.html#cb88-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-53"><a href="tuning.html#cb88-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-54"><a href="tuning.html#cb88-54" aria-hidden="true" tabindex="-1"></a>overall_counter <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb88-55"><a href="tuning.html#cb88-55" aria-hidden="true" tabindex="-1"></a>all_conc_holder <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb88-56"><a href="tuning.html#cb88-56" aria-hidden="true" tabindex="-1"></a>all_survfit_holder <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb88-57"><a href="tuning.html#cb88-57" aria-hidden="true" tabindex="-1"></a>all_auc_holder <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb88-58"><a href="tuning.html#cb88-58" aria-hidden="true" tabindex="-1"></a>all_or_holder <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb88-59"><a href="tuning.html#cb88-59" aria-hidden="true" tabindex="-1"></a>all_base_holder <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">4</span>, <span class="fu">list</span>())</span></code></pre></div>
<p>I am aware that there are other methods available for handling competing risks. I have found that while Fine-Gray is not perfect it is generally well understood and implemented, so I have chosen to use it here. At this point we are finally ready to get some metrics.</p>
</div>
<div id="survival-base-metrics" class="section level3" number="8.1.3">
<h3><span class="header-section-number">8.1.3</span> Survival Base Metrics</h3>
<p>We begin with the more difficult survival analyses. Before even starting we split the data into their own training and testing groups. Then we fit a coxph (which is really Fine-Gray) model without any polygenic risk score included. We then use this model upon the testing set to generate a concordance value. We use the survConcordance function to get this value, which I will stress is not the orthodox implementation of survConcordance (see <a href="https://stats.stackexchange.com/questions/234164/how-to-validate-cox-proportional-hazards-model" class="uri">https://stats.stackexchange.com/questions/234164/how-to-validate-cox-proportional-hazards-model</a>, with Dr. Harrell who inveneted many related statistics). However, at the end of the day I need a way to make a prediction and produce a global estimate of fit, and this function gets the job done without doing anything outright wrong.</p>
<p>The next step is calculating cumulative incidence. This can be relatively easily calculated with the survfit function and pulling out the cumhaz object (comment on statistic names in the next paragraph). Things get complicated when we want to see how much greater the risk is for one group of people than another group of people (group because we cannot analyze everyone at the same time). A great guide to everything survival curve related is within <a href="https://cran.r-project.org/web/packages/survival/vignettes/adjcurve.pdf" class="uri">https://cran.r-project.org/web/packages/survival/vignettes/adjcurve.pdf</a>. Starting in section 5.2 the authors relate how we can basically compare dummy individuals where all of the covariates are held constant except for the group of interest. This clearly creates many problems, which is why a better approach is to model the precise suvival curve of every individual and then average them based on the group the individual is within. The trade-off is that the better approach is very slow and takes up a great deal of memory. An alternative approach is manually extracting the base hazard from the coxph model, then multiply by each individual’s covariates against the fit coefficients. This works particularly well when trying to get the hazard for just one timepoint. When going for all time points I would guess survfit is better. Therefore we will take the slower approach when doing the final testing but when analyzing every score over every fold we will go with the faster approach.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="tuning.html#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co">#for(nrepeat in 1:input_repeats){</span></span>
<span id="cb89-2"><a href="tuning.html#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for(nfold in 1:input_folds){</span></span>
<span id="cb89-3"><a href="tuning.html#cb89-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-4"><a href="tuning.html#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;survival&quot;</span>)</span>
<span id="cb89-5"><a href="tuning.html#cb89-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set up the survival analysis data</span></span>
<span id="cb89-6"><a href="tuning.html#cb89-6" aria-hidden="true" tabindex="-1"></a>  fg_diag_train <span class="ot">&lt;-</span> fg_diag[fg_diag<span class="sc">$</span>eid <span class="sc">%in%</span> repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;train&quot;</span>]],]</span>
<span id="cb89-7"><a href="tuning.html#cb89-7" aria-hidden="true" tabindex="-1"></a>  fg_diag_test <span class="ot">&lt;-</span> fg_diag[fg_diag<span class="sc">$</span>eid <span class="sc">%in%</span> repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;test&quot;</span>]],]</span>
<span id="cb89-8"><a href="tuning.html#cb89-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-9"><a href="tuning.html#cb89-9" aria-hidden="true" tabindex="-1"></a>  surv_df_train <span class="ot">&lt;-</span> surv_df[surv_df<span class="sc">$</span>eid <span class="sc">%in%</span> repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;train&quot;</span>]],]</span>
<span id="cb89-10"><a href="tuning.html#cb89-10" aria-hidden="true" tabindex="-1"></a>  surv_df_test <span class="ot">&lt;-</span> surv_df[surv_df<span class="sc">$</span>eid <span class="sc">%in%</span> repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;test&quot;</span>]],]</span>
<span id="cb89-11"><a href="tuning.html#cb89-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-12"><a href="tuning.html#cb89-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-13"><a href="tuning.html#cb89-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">###########################################################</span></span>
<span id="cb89-14"><a href="tuning.html#cb89-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                    SURVIVAL ANALYSES                    #</span></span>
<span id="cb89-15"><a href="tuning.html#cb89-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">###########################################################</span></span>
<span id="cb89-16"><a href="tuning.html#cb89-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-17"><a href="tuning.html#cb89-17" aria-hidden="true" tabindex="-1"></a>  base_mod <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(fgstart, fgstop, fgstatus) <span class="sc">~</span>  age <span class="sc">+</span> sex <span class="sc">+</span> PC1 <span class="sc">+</span> PC2 <span class="sc">+</span> PC3 <span class="sc">+</span> PC4 <span class="sc">+</span> PC5 <span class="sc">+</span></span>
<span id="cb89-18"><a href="tuning.html#cb89-18" aria-hidden="true" tabindex="-1"></a>                     PC6 <span class="sc">+</span> PC7 <span class="sc">+</span> PC8 <span class="sc">+</span> PC9 <span class="sc">+</span> PC10, <span class="at">data =</span> fg_diag_train, <span class="at">weight =</span> fgwt)</span>
<span id="cb89-19"><a href="tuning.html#cb89-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-20"><a href="tuning.html#cb89-20" aria-hidden="true" tabindex="-1"></a>  base_conc <span class="ot">&lt;-</span> <span class="fu">survConcordance</span>(<span class="fu">Surv</span>(fgstart, fgstop, fgstatus) <span class="sc">~</span> <span class="fu">predict</span>(base_mod, fg_diag_test), <span class="at">data =</span> fg_diag_test, <span class="at">weight =</span> fgwt)</span>
<span id="cb89-21"><a href="tuning.html#cb89-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-22"><a href="tuning.html#cb89-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-23"><a href="tuning.html#cb89-23" aria-hidden="true" tabindex="-1"></a>  base_survfit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(base_mod, fg_diag_test, <span class="at">se.fit =</span> F)</span>
<span id="cb89-24"><a href="tuning.html#cb89-24" aria-hidden="true" tabindex="-1"></a>  final_cumhaz <span class="ot">&lt;-</span> base_survfit<span class="sc">$</span>cumhaz[<span class="fu">nrow</span>(base_survfit<span class="sc">$</span>cumhaz),]</span>
<span id="cb89-25"><a href="tuning.html#cb89-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-26"><a href="tuning.html#cb89-26" aria-hidden="true" tabindex="-1"></a>  group_factor <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(final_cumhaz))</span>
<span id="cb89-27"><a href="tuning.html#cb89-27" aria-hidden="true" tabindex="-1"></a>  group_factor[final_cumhaz <span class="sc">&lt;</span> <span class="fu">quantile</span>(final_cumhaz, <span class="fl">0.2</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb89-28"><a href="tuning.html#cb89-28" aria-hidden="true" tabindex="-1"></a>  group_factor[final_cumhaz <span class="sc">&gt;</span> <span class="fu">quantile</span>(final_cumhaz, <span class="fl">0.8</span>)] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb89-29"><a href="tuning.html#cb89-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-30"><a href="tuning.html#cb89-30" aria-hidden="true" tabindex="-1"></a>  base_cumhaz <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> base_survfit<span class="sc">$</span>time,</span>
<span id="cb89-31"><a href="tuning.html#cb89-31" aria-hidden="true" tabindex="-1"></a>                            <span class="at">mean_lo =</span> <span class="fu">apply</span>(base_survfit<span class="sc">$</span>cumhaz[,group_factor<span class="sc">==</span><span class="dv">0</span>], <span class="dv">1</span>, mean),</span>
<span id="cb89-32"><a href="tuning.html#cb89-32" aria-hidden="true" tabindex="-1"></a>                            <span class="at">mean_mid =</span> <span class="fu">apply</span>(base_survfit<span class="sc">$</span>cumhaz[,group_factor<span class="sc">==</span><span class="dv">1</span>], <span class="dv">1</span>, mean),</span>
<span id="cb89-33"><a href="tuning.html#cb89-33" aria-hidden="true" tabindex="-1"></a>                            <span class="at">mean_hi =</span> <span class="fu">apply</span>(base_survfit<span class="sc">$</span>cumhaz[,group_factor<span class="sc">==</span><span class="dv">2</span>], <span class="dv">1</span>, mean),</span>
<span id="cb89-34"><a href="tuning.html#cb89-34" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sd_lo =</span> <span class="fu">apply</span>(base_survfit<span class="sc">$</span>cumhaz[,group_factor<span class="sc">==</span><span class="dv">0</span>], <span class="dv">1</span>, sd),</span>
<span id="cb89-35"><a href="tuning.html#cb89-35" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sd_mid =</span> <span class="fu">apply</span>(base_survfit<span class="sc">$</span>cumhaz[,group_factor<span class="sc">==</span><span class="dv">1</span>], <span class="dv">1</span>, sd),</span>
<span id="cb89-36"><a href="tuning.html#cb89-36" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sd_hi =</span> <span class="fu">apply</span>(base_survfit<span class="sc">$</span>cumhaz[,group_factor<span class="sc">==</span><span class="dv">2</span>], <span class="dv">1</span>, sd))</span></code></pre></div>
<p>An additional note on grouping. I initially planned to evaluate this non-global metric just based on how well the polygenic risk score does in bringing about risk stratification. But following the logic from the AUC metrics, where we find far greater value in comparing the baseline AUC to an AUC that also considers the polygenic risk score, this non-global metric should likely do the same. Therefore we have a baseline cumualtive incidence based on all possible covariates and then a score enhanced cumulative incidence as well.</p>
<p>And a final note on survival statistic names. I am far from an exper on this topic although I believe incidence and hazard can be used interchangeably (following the discussion <a href="https://cran.r-project.org/web/packages/survival/vignettes/compete.pdf" class="uri">https://cran.r-project.org/web/packages/survival/vignettes/compete.pdf</a>). The idea is that by properly adjusting for the competing risk the hazard at any timepoint should be free from other effects and therefore is the ideal incidence that you are looking for.</p>
</div>
<div id="survival-score-metrics" class="section level3" number="8.1.4">
<h3><span class="header-section-number">8.1.4</span> Survival Score Metrics</h3>
<p>This code is nearly identical to the previous, except now we specify the fast and slow options that I explained in the previous section and iterate over each score, adding the score into the model before evaluating.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="tuning.html#cb90-1" aria-hidden="true" tabindex="-1"></a>all_conc <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">ncol</span>(scores), <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb90-2"><a href="tuning.html#cb90-2" aria-hidden="true" tabindex="-1"></a>all_subrates <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb90-3"><a href="tuning.html#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="tuning.html#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(all_conc)){</span>
<span id="cb90-5"><a href="tuning.html#cb90-5" aria-hidden="true" tabindex="-1"></a> fg_diag_train<span class="sc">$</span>score <span class="ot">&lt;-</span> fg_scores_diag[fg_diag<span class="sc">$</span>eid <span class="sc">%in%</span> repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;train&quot;</span>]],i]</span>
<span id="cb90-6"><a href="tuning.html#cb90-6" aria-hidden="true" tabindex="-1"></a> fg_diag_test<span class="sc">$</span>score <span class="ot">&lt;-</span> fg_scores_diag[fg_diag<span class="sc">$</span>eid <span class="sc">%in%</span> repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;test&quot;</span>]],i]</span>
<span id="cb90-7"><a href="tuning.html#cb90-7" aria-hidden="true" tabindex="-1"></a> surv_df_train<span class="sc">$</span>score <span class="ot">&lt;-</span> scores[surv_df<span class="sc">$</span>eid <span class="sc">%in%</span> repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;train&quot;</span>]],i]</span>
<span id="cb90-8"><a href="tuning.html#cb90-8" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb90-9"><a href="tuning.html#cb90-9" aria-hidden="true" tabindex="-1"></a> <span class="co">#Make the model</span></span>
<span id="cb90-10"><a href="tuning.html#cb90-10" aria-hidden="true" tabindex="-1"></a> score_mod <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(fgstart, fgstop, fgstatus) <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> PC1 <span class="sc">+</span> PC2 <span class="sc">+</span> PC3 <span class="sc">+</span> PC4 <span class="sc">+</span> PC5 <span class="sc">+</span></span>
<span id="cb90-11"><a href="tuning.html#cb90-11" aria-hidden="true" tabindex="-1"></a>                     PC6 <span class="sc">+</span> PC7 <span class="sc">+</span> PC8 <span class="sc">+</span> PC9 <span class="sc">+</span> PC10 <span class="sc">+</span> score, <span class="at">data =</span> fg_diag_train, <span class="at">weight =</span> fgwt)</span>
<span id="cb90-12"><a href="tuning.html#cb90-12" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb90-13"><a href="tuning.html#cb90-13" aria-hidden="true" tabindex="-1"></a> <span class="co">#CONCORDANCE ###################################</span></span>
<span id="cb90-14"><a href="tuning.html#cb90-14" aria-hidden="true" tabindex="-1"></a> score_conc_obj <span class="ot">&lt;-</span> <span class="fu">survConcordance</span>(<span class="fu">Surv</span>(fgstart, fgstop, fgstatus) <span class="sc">~</span> <span class="fu">predict</span>(score_mod, fg_diag_test), <span class="at">data =</span> fg_diag_test, <span class="at">weight =</span> fgwt)</span>
<span id="cb90-15"><a href="tuning.html#cb90-15" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb90-16"><a href="tuning.html#cb90-16" aria-hidden="true" tabindex="-1"></a> all_conc[i,<span class="dv">1</span>] <span class="ot">&lt;-</span> score_conc_obj<span class="sc">$</span>conc</span>
<span id="cb90-17"><a href="tuning.html#cb90-17" aria-hidden="true" tabindex="-1"></a> all_conc[i,<span class="dv">2</span>] <span class="ot">&lt;-</span> score_conc_obj<span class="sc">$</span>std.err</span>
<span id="cb90-18"><a href="tuning.html#cb90-18" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb90-19"><a href="tuning.html#cb90-19" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb90-20"><a href="tuning.html#cb90-20" aria-hidden="true" tabindex="-1"></a> <span class="co">#SURVFIT ##########################################</span></span>
<span id="cb90-21"><a href="tuning.html#cb90-21" aria-hidden="true" tabindex="-1"></a> <span class="co">#SLOW</span></span>
<span id="cb90-22"><a href="tuning.html#cb90-22" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(subrate_style <span class="sc">==</span> <span class="st">&quot;slow&quot;</span>){</span>
<span id="cb90-23"><a href="tuning.html#cb90-23" aria-hidden="true" tabindex="-1"></a>  score_survfit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(score_mod, fg_diag_test, <span class="at">se.fit =</span> F)</span>
<span id="cb90-24"><a href="tuning.html#cb90-24" aria-hidden="true" tabindex="-1"></a>  final_cumhaz <span class="ot">&lt;-</span> score_survfit<span class="sc">$</span>cumhaz[<span class="fu">nrow</span>(score_survfit<span class="sc">$</span>cumhaz),]</span>
<span id="cb90-25"><a href="tuning.html#cb90-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-26"><a href="tuning.html#cb90-26" aria-hidden="true" tabindex="-1"></a>  group_factor <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(final_cumhaz))</span>
<span id="cb90-27"><a href="tuning.html#cb90-27" aria-hidden="true" tabindex="-1"></a>  group_factor[final_cumhaz <span class="sc">&lt;</span> <span class="fu">quantile</span>(final_cumhaz, <span class="fl">0.2</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb90-28"><a href="tuning.html#cb90-28" aria-hidden="true" tabindex="-1"></a>  group_factor[final_cumhaz <span class="sc">&gt;</span> <span class="fu">quantile</span>(final_cumhaz, <span class="fl">0.8</span>)] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb90-29"><a href="tuning.html#cb90-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-30"><a href="tuning.html#cb90-30" aria-hidden="true" tabindex="-1"></a>  pred_cumhaz_score <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> score_survfit<span class="sc">$</span>time,</span>
<span id="cb90-31"><a href="tuning.html#cb90-31" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean_lo =</span> <span class="fu">apply</span>(score_survfit<span class="sc">$</span>cumhaz[,group_factor<span class="sc">==</span><span class="dv">0</span>], <span class="dv">1</span>, mean),</span>
<span id="cb90-32"><a href="tuning.html#cb90-32" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean_mid =</span> <span class="fu">apply</span>(score_survfit<span class="sc">$</span>cumhaz[,group_factor<span class="sc">==</span><span class="dv">1</span>], <span class="dv">1</span>, mean),</span>
<span id="cb90-33"><a href="tuning.html#cb90-33" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean_hi =</span> <span class="fu">apply</span>(score_survfit<span class="sc">$</span>cumhaz[,group_factor<span class="sc">==</span><span class="dv">2</span>], <span class="dv">1</span>, mean),</span>
<span id="cb90-34"><a href="tuning.html#cb90-34" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd_lo =</span> <span class="fu">apply</span>(score_survfit<span class="sc">$</span>cumhaz[,group_factor<span class="sc">==</span><span class="dv">0</span>], <span class="dv">1</span>, sd),</span>
<span id="cb90-35"><a href="tuning.html#cb90-35" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd_mid =</span> <span class="fu">apply</span>(score_survfit<span class="sc">$</span>cumhaz[,group_factor<span class="sc">==</span><span class="dv">1</span>], <span class="dv">1</span>, sd),</span>
<span id="cb90-36"><a href="tuning.html#cb90-36" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd_hi =</span> <span class="fu">apply</span>(score_survfit<span class="sc">$</span>cumhaz[,group_factor<span class="sc">==</span><span class="dv">2</span>], <span class="dv">1</span>, sd))</span>
<span id="cb90-37"><a href="tuning.html#cb90-37" aria-hidden="true" tabindex="-1"></a>  pred_cumhaz_score <span class="ot">&lt;-</span> pred_cumhaz_score[<span class="sc">!</span><span class="fu">duplicated</span>(pred_cumhaz_score<span class="sc">$</span>mean_mid),]</span>
<span id="cb90-38"><a href="tuning.html#cb90-38" aria-hidden="true" tabindex="-1"></a> } <span class="cf">else</span> <span class="cf">if</span>(subrate_style <span class="sc">==</span> <span class="st">&quot;fast&quot;</span>){ </span>
<span id="cb90-39"><a href="tuning.html#cb90-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">#FAST</span></span>
<span id="cb90-40"><a href="tuning.html#cb90-40" aria-hidden="true" tabindex="-1"></a>  group_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb90-41"><a href="tuning.html#cb90-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">names</span>(score_mod<span class="sc">$</span>coef))){</span>
<span id="cb90-42"><a href="tuning.html#cb90-42" aria-hidden="true" tabindex="-1"></a>   group_list[[k]] <span class="ot">&lt;-</span>  <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(surv_df_train[[<span class="fu">names</span>(score_mod<span class="sc">$</span>coef)[k]]], <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>)))</span>
<span id="cb90-43"><a href="tuning.html#cb90-43" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span>(<span class="fu">sign</span>(score_mod<span class="sc">$</span>coef[k] <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>)){</span>
<span id="cb90-44"><a href="tuning.html#cb90-44" aria-hidden="true" tabindex="-1"></a>    group_list[[k]] <span class="ot">&lt;-</span> <span class="fu">rev</span>(group_list[[k]])</span>
<span id="cb90-45"><a href="tuning.html#cb90-45" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb90-46"><a href="tuning.html#cb90-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb90-47"><a href="tuning.html#cb90-47" aria-hidden="true" tabindex="-1"></a>  mean_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">do.call</span>(<span class="st">&quot;cbind&quot;</span>, group_list))</span>
<span id="cb90-48"><a href="tuning.html#cb90-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(mean_df) <span class="ot">&lt;-</span> <span class="fu">names</span>(score_mod<span class="sc">$</span>coef)</span>
<span id="cb90-49"><a href="tuning.html#cb90-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">sign</span>(score_mod<span class="sc">$</span>coef[<span class="dv">2</span>]) <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>){</span>
<span id="cb90-50"><a href="tuning.html#cb90-50" aria-hidden="true" tabindex="-1"></a>   mean_df<span class="sc">$</span>sex <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.9</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span>)</span>
<span id="cb90-51"><a href="tuning.html#cb90-51" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb90-52"><a href="tuning.html#cb90-52" aria-hidden="true" tabindex="-1"></a>   mean_df<span class="sc">$</span>sex <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>)</span>
<span id="cb90-53"><a href="tuning.html#cb90-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb90-54"><a href="tuning.html#cb90-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-55"><a href="tuning.html#cb90-55" aria-hidden="true" tabindex="-1"></a>  score_pred <span class="ot">&lt;-</span> <span class="fu">survfit</span>(score_mod, <span class="at">newdata =</span> mean_df)</span>
<span id="cb90-56"><a href="tuning.html#cb90-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-57"><a href="tuning.html#cb90-57" aria-hidden="true" tabindex="-1"></a>  pred_cumhaz_score <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(score_pred<span class="sc">$</span>time, score_pred<span class="sc">$</span>cumhaz, score_pred<span class="sc">$</span>std.err)</span>
<span id="cb90-58"><a href="tuning.html#cb90-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(pred_cumhaz_score) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;mean_lo&quot;</span>, <span class="st">&quot;mean_mid&quot;</span>, <span class="st">&quot;mean_hi&quot;</span>, <span class="st">&quot;sd_lo&quot;</span>, <span class="st">&quot;sd_mid&quot;</span>, <span class="st">&quot;sd_hi&quot;</span>)</span>
<span id="cb90-59"><a href="tuning.html#cb90-59" aria-hidden="true" tabindex="-1"></a>  pred_cumhaz_score <span class="ot">&lt;-</span> pred_cumhaz_score[<span class="sc">!</span><span class="fu">duplicated</span>(pred_cumhaz_score<span class="sc">$</span>mean_mid),]</span>
<span id="cb90-60"><a href="tuning.html#cb90-60" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb90-61"><a href="tuning.html#cb90-61" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb90-62"><a href="tuning.html#cb90-62" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb90-63"><a href="tuning.html#cb90-63" aria-hidden="true" tabindex="-1"></a> all_subrates[[i]] <span class="ot">&lt;-</span> pred_cumhaz_score</span>
<span id="cb90-64"><a href="tuning.html#cb90-64" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb90-65"><a href="tuning.html#cb90-65" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="logistic-regression-base-metrics" class="section level3" number="8.1.5">
<h3><span class="header-section-number">8.1.5</span> Logistic Regression Base Metrics</h3>
<p>Now we may move onto the relatively easier logistic regression metrics. The overall format of this code is similar to the survival base metrics, as in we first fit a base model and then calculate the AUC by making a prediction on the withheld dataset. Next we move onto the odds ratios, as explained previously the groups (or the exposed/non-exposed individuals) are determined by all the covariates in order to see how much the inclusion of the score improves the odds ratio. After producing the 2x2 contingency table through the full model prediction we get the odds ratio and the confidence intervals through the nice oddsratio.wald function.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="tuning.html#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the normal model data</span></span>
<span id="cb91-2"><a href="tuning.html#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&quot;normal&quot;</span>)</span>
<span id="cb91-3"><a href="tuning.html#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="tuning.html#cb91-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(pheno, covars[,<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb91-5"><a href="tuning.html#cb91-5" aria-hidden="true" tabindex="-1"></a>df_train <span class="ot">&lt;-</span> df[covars[,<span class="dv">1</span>] <span class="sc">%in%</span> repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;train&quot;</span>]],]</span>
<span id="cb91-6"><a href="tuning.html#cb91-6" aria-hidden="true" tabindex="-1"></a>df_test <span class="ot">&lt;-</span> df[covars[,<span class="dv">1</span>] <span class="sc">%in%</span> repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;test&quot;</span>]],]</span>
<span id="cb91-7"><a href="tuning.html#cb91-7" aria-hidden="true" tabindex="-1"></a>scores_train <span class="ot">&lt;-</span> scores[covars[,<span class="dv">1</span>] <span class="sc">%in%</span> repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;train&quot;</span>]],]</span>
<span id="cb91-8"><a href="tuning.html#cb91-8" aria-hidden="true" tabindex="-1"></a>scores_test <span class="ot">&lt;-</span> scores[covars[,<span class="dv">1</span>] <span class="sc">%in%</span> repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;test&quot;</span>]],]</span>
<span id="cb91-9"><a href="tuning.html#cb91-9" aria-hidden="true" tabindex="-1"></a>pheno_test <span class="ot">&lt;-</span> pheno[covars[,<span class="dv">1</span>] <span class="sc">%in%</span> repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;test&quot;</span>]]]</span>
<span id="cb91-10"><a href="tuning.html#cb91-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-11"><a href="tuning.html#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="do">###########################################################</span></span>
<span id="cb91-12"><a href="tuning.html#cb91-12" aria-hidden="true" tabindex="-1"></a><span class="co">#                    NORMAL MODELS                        #</span></span>
<span id="cb91-13"><a href="tuning.html#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="do">###########################################################</span></span>
<span id="cb91-14"><a href="tuning.html#cb91-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-15"><a href="tuning.html#cb91-15" aria-hidden="true" tabindex="-1"></a>base_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(pheno <span class="sc">~</span> ., <span class="at">data =</span> df_train, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb91-16"><a href="tuning.html#cb91-16" aria-hidden="true" tabindex="-1"></a>base_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(base_mod, df_test)</span>
<span id="cb91-17"><a href="tuning.html#cb91-17" aria-hidden="true" tabindex="-1"></a>base_roc <span class="ot">&lt;-</span> <span class="fu">roc</span>(pheno_test <span class="sc">~</span> base_pred)</span>
<span id="cb91-18"><a href="tuning.html#cb91-18" aria-hidden="true" tabindex="-1"></a>base_auc <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">ci.auc</span>(base_roc))</span>
<span id="cb91-19"><a href="tuning.html#cb91-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-20"><a href="tuning.html#cb91-20" aria-hidden="true" tabindex="-1"></a>base_group <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(base_pred))</span>
<span id="cb91-21"><a href="tuning.html#cb91-21" aria-hidden="true" tabindex="-1"></a>base_group[base_pred <span class="sc">&lt;</span> <span class="fu">quantile</span>(base_pred, <span class="fl">0.2</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb91-22"><a href="tuning.html#cb91-22" aria-hidden="true" tabindex="-1"></a>base_group[base_pred <span class="sc">&gt;</span> <span class="fu">quantile</span>(base_pred, <span class="fl">0.8</span>)] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb91-23"><a href="tuning.html#cb91-23" aria-hidden="true" tabindex="-1"></a>base_odds_table <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fu">sum</span>(df_test<span class="sc">$</span>pheno <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> base_group <span class="sc">==</span> <span class="dv">2</span>), <span class="fu">sum</span>(df_test<span class="sc">$</span>pheno <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> base_group <span class="sc">==</span> <span class="dv">2</span>),</span>
<span id="cb91-24"><a href="tuning.html#cb91-24" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">sum</span>(df_test<span class="sc">$</span>pheno <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> base_group <span class="sc">==</span> <span class="dv">0</span>), <span class="fu">sum</span>(df_test<span class="sc">$</span>pheno <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> base_group <span class="sc">==</span> <span class="dv">0</span>)), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb91-25"><a href="tuning.html#cb91-25" aria-hidden="true" tabindex="-1"></a>base_odds_ratio <span class="ot">&lt;-</span> <span class="fu">oddsratio.wald</span>(base_odds_table)</span>
<span id="cb91-26"><a href="tuning.html#cb91-26" aria-hidden="true" tabindex="-1"></a>base_odds_ratio <span class="ot">&lt;-</span> base_odds_ratio<span class="sc">$</span>measure[<span class="dv">2</span>,<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">3</span>)]</span></code></pre></div>
</div>
<div id="logistic-regression-score-metrics" class="section level3" number="8.1.6">
<h3><span class="header-section-number">8.1.6</span> Logistic Regression Score Metrics</h3>
<p>Again, this process is very similar to what was previously explained except now the models include the polygenic risk score. At the end of all the loops we also see how all of the metrics are collected together then saved.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="tuning.html#cb92-1" aria-hidden="true" tabindex="-1"></a>all_auc <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">ncol</span>(scores), <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb92-2"><a href="tuning.html#cb92-2" aria-hidden="true" tabindex="-1"></a>all_odds_ratio <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">ncol</span>(scores), <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb92-3"><a href="tuning.html#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(scores)){</span>
<span id="cb92-4"><a href="tuning.html#cb92-4" aria-hidden="true" tabindex="-1"></a> df_train<span class="sc">$</span>score <span class="ot">&lt;-</span> scores_train[,i]</span>
<span id="cb92-5"><a href="tuning.html#cb92-5" aria-hidden="true" tabindex="-1"></a> df_test<span class="sc">$</span>score <span class="ot">&lt;-</span> scores_test[,i]</span>
<span id="cb92-6"><a href="tuning.html#cb92-6" aria-hidden="true" tabindex="-1"></a> <span class="co">#Make the model</span></span>
<span id="cb92-7"><a href="tuning.html#cb92-7" aria-hidden="true" tabindex="-1"></a> score_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(pheno <span class="sc">~</span> ., <span class="at">data =</span> df_train, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb92-8"><a href="tuning.html#cb92-8" aria-hidden="true" tabindex="-1"></a> score_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(score_mod, df_test)</span>
<span id="cb92-9"><a href="tuning.html#cb92-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb92-10"><a href="tuning.html#cb92-10" aria-hidden="true" tabindex="-1"></a> <span class="co"># AUC #####################################</span></span>
<span id="cb92-11"><a href="tuning.html#cb92-11" aria-hidden="true" tabindex="-1"></a> score_roc <span class="ot">&lt;-</span> <span class="fu">roc</span>(pheno_test <span class="sc">~</span> score_pred)</span>
<span id="cb92-12"><a href="tuning.html#cb92-12" aria-hidden="true" tabindex="-1"></a> all_auc[i,] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">ci.auc</span>(score_roc))</span>
<span id="cb92-13"><a href="tuning.html#cb92-13" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb92-14"><a href="tuning.html#cb92-14" aria-hidden="true" tabindex="-1"></a> <span class="co"># ODDS RATIO #############################</span></span>
<span id="cb92-15"><a href="tuning.html#cb92-15" aria-hidden="true" tabindex="-1"></a> score_group <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(score_pred))</span>
<span id="cb92-16"><a href="tuning.html#cb92-16" aria-hidden="true" tabindex="-1"></a> score_group[score_pred <span class="sc">&lt;</span> <span class="fu">quantile</span>(score_pred, <span class="fl">0.2</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb92-17"><a href="tuning.html#cb92-17" aria-hidden="true" tabindex="-1"></a> score_group[score_pred <span class="sc">&gt;</span> <span class="fu">quantile</span>(score_pred, <span class="fl">0.8</span>)] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb92-18"><a href="tuning.html#cb92-18" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb92-19"><a href="tuning.html#cb92-19" aria-hidden="true" tabindex="-1"></a> score_odds_table <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fu">sum</span>(df_test<span class="sc">$</span>pheno <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> score_group <span class="sc">==</span> <span class="dv">2</span>), <span class="fu">sum</span>(df_test<span class="sc">$</span>pheno <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> score_group <span class="sc">==</span> <span class="dv">2</span>),</span>
<span id="cb92-20"><a href="tuning.html#cb92-20" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">sum</span>(df_test<span class="sc">$</span>pheno <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> score_group <span class="sc">==</span> <span class="dv">0</span>), <span class="fu">sum</span>(df_test<span class="sc">$</span>pheno <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> score_group <span class="sc">==</span> <span class="dv">0</span>)), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb92-21"><a href="tuning.html#cb92-21" aria-hidden="true" tabindex="-1"></a> score_odds_ratio <span class="ot">&lt;-</span> <span class="fu">oddsratio.wald</span>(score_odds_table)</span>
<span id="cb92-22"><a href="tuning.html#cb92-22" aria-hidden="true" tabindex="-1"></a> all_odds_ratio[i,] <span class="ot">&lt;-</span> score_odds_ratio<span class="sc">$</span>measure[<span class="dv">2</span>,<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">3</span>)]</span>
<span id="cb92-23"><a href="tuning.html#cb92-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-24"><a href="tuning.html#cb92-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-25"><a href="tuning.html#cb92-25" aria-hidden="true" tabindex="-1"></a>all_conc_holder[[overall_counter]] <span class="ot">&lt;-</span> all_conc</span>
<span id="cb92-26"><a href="tuning.html#cb92-26" aria-hidden="true" tabindex="-1"></a>all_survfit_holder[[overall_counter]] <span class="ot">&lt;-</span> all_subrates</span>
<span id="cb92-27"><a href="tuning.html#cb92-27" aria-hidden="true" tabindex="-1"></a>all_auc_holder[[overall_counter]] <span class="ot">&lt;-</span> all_auc</span>
<span id="cb92-28"><a href="tuning.html#cb92-28" aria-hidden="true" tabindex="-1"></a>all_or_holder[[overall_counter]] <span class="ot">&lt;-</span> all_odds_ratio</span>
<span id="cb92-29"><a href="tuning.html#cb92-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-30"><a href="tuning.html#cb92-30" aria-hidden="true" tabindex="-1"></a>all_base_holder[[<span class="dv">1</span>]][[overall_counter]] <span class="ot">&lt;-</span> base_conc</span>
<span id="cb92-31"><a href="tuning.html#cb92-31" aria-hidden="true" tabindex="-1"></a>all_base_holder[[<span class="dv">2</span>]][[overall_counter]] <span class="ot">&lt;-</span> base_cumhaz</span>
<span id="cb92-32"><a href="tuning.html#cb92-32" aria-hidden="true" tabindex="-1"></a>all_base_holder[[<span class="dv">3</span>]][[overall_counter]] <span class="ot">&lt;-</span> base_auc</span>
<span id="cb92-33"><a href="tuning.html#cb92-33" aria-hidden="true" tabindex="-1"></a>all_base_holder[[<span class="dv">4</span>]][[overall_counter]] <span class="ot">&lt;-</span> base_odds_ratio</span>
<span id="cb92-34"><a href="tuning.html#cb92-34" aria-hidden="true" tabindex="-1"></a>overall_counter <span class="ot">&lt;-</span> overall_counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb92-35"><a href="tuning.html#cb92-35" aria-hidden="true" tabindex="-1"></a><span class="co">#}</span></span>
<span id="cb92-36"><a href="tuning.html#cb92-36" aria-hidden="true" tabindex="-1"></a><span class="co">#}</span></span>
<span id="cb92-37"><a href="tuning.html#cb92-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-38"><a href="tuning.html#cb92-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-39"><a href="tuning.html#cb92-39" aria-hidden="true" tabindex="-1"></a>final_obj <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;conc&quot;</span> <span class="ot">=</span> all_conc_holder, <span class="st">&quot;survfit&quot;</span> <span class="ot">=</span> all_survfit_holder, <span class="st">&quot;auc&quot;</span> <span class="ot">=</span> all_auc_holder, <span class="st">&quot;or&quot;</span> <span class="ot">=</span> all_or_holder)</span>
<span id="cb92-40"><a href="tuning.html#cb92-40" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(final_obj, <span class="fu">paste0</span>(<span class="st">&quot;tune_results/&quot;</span>, author, <span class="st">&quot;_res.RDS&quot;</span>))</span></code></pre></div>
</div>
</div>
<div id="choosing-the-best-score" class="section level2" number="8.2">
<h2><span class="header-section-number">8.2</span> Choosing the Best Score</h2>
<p>Now that we have all of the performance metrics all we need to do to pick the best score is average over all of the repats and folds, then find the maximum. All of these are accomplished in a rather straightforward manner in the following script.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="tuning.html#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Read in the starting information</span></span>
<span id="cb93-2"><a href="tuning.html#cb93-2" aria-hidden="true" tabindex="-1"></a>all_author <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">strsplit</span>(<span class="fu">list.files</span>(<span class="st">&quot;tune_results/&quot;</span>, <span class="st">&quot;res&quot;</span>), <span class="st">&quot;_&quot;</span>), <span class="cf">function</span>(x) x[<span class="dv">1</span>]))</span>
<span id="cb93-3"><a href="tuning.html#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(author <span class="cf">in</span> all_author){</span>
<span id="cb93-4"><a href="tuning.html#cb93-4" aria-hidden="true" tabindex="-1"></a>  all_res <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">&quot;tune_results/&quot;</span>, author, <span class="st">&quot;_res.RDS&quot;</span>))</span>
<span id="cb93-5"><a href="tuning.html#cb93-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-6"><a href="tuning.html#cb93-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Average all of the results</span></span>
<span id="cb93-7"><a href="tuning.html#cb93-7" aria-hidden="true" tabindex="-1"></a>  mean_conc <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, all_res[[<span class="st">&quot;conc&quot;</span>]])<span class="sc">/</span><span class="fu">length</span>(all_res[[<span class="st">&quot;conc&quot;</span>]])</span>
<span id="cb93-8"><a href="tuning.html#cb93-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-9"><a href="tuning.html#cb93-9" aria-hidden="true" tabindex="-1"></a>  mean_survfit <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">length</span>(all_res[[<span class="st">&quot;survfit&quot;</span>]][[<span class="dv">1</span>]]), <span class="at">ncol =</span> <span class="dv">6</span>)</span>
<span id="cb93-10"><a href="tuning.html#cb93-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(all_res[[<span class="st">&quot;survfit&quot;</span>]])){</span>
<span id="cb93-11"><a href="tuning.html#cb93-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(all_res[[<span class="st">&quot;score_names&quot;</span>]])){</span>
<span id="cb93-12"><a href="tuning.html#cb93-12" aria-hidden="true" tabindex="-1"></a>      mean_survfit[j,] <span class="ot">&lt;-</span> mean_survfit[j,] <span class="sc">+</span> <span class="fu">as.numeric</span>(<span class="fu">tail</span>(all_res[[<span class="st">&quot;survfit&quot;</span>]][[i]][[j]],<span class="dv">1</span>)[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb93-13"><a href="tuning.html#cb93-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb93-14"><a href="tuning.html#cb93-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb93-15"><a href="tuning.html#cb93-15" aria-hidden="true" tabindex="-1"></a>  mean_survfit <span class="ot">&lt;-</span> mean_survfit<span class="sc">/</span><span class="fu">length</span>(all_res[[<span class="st">&quot;survfit&quot;</span>]])</span>
<span id="cb93-16"><a href="tuning.html#cb93-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-17"><a href="tuning.html#cb93-17" aria-hidden="true" tabindex="-1"></a>  mean_auc <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, all_res[[<span class="st">&quot;auc&quot;</span>]])<span class="sc">/</span><span class="fu">length</span>(all_res[[<span class="st">&quot;auc&quot;</span>]])</span>
<span id="cb93-18"><a href="tuning.html#cb93-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-19"><a href="tuning.html#cb93-19" aria-hidden="true" tabindex="-1"></a>  mean_or <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, all_res[[<span class="st">&quot;or&quot;</span>]])<span class="sc">/</span><span class="fu">length</span>(all_res[[<span class="st">&quot;or&quot;</span>]])</span>
<span id="cb93-20"><a href="tuning.html#cb93-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-21"><a href="tuning.html#cb93-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-22"><a href="tuning.html#cb93-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Get the corresponding best score name</span></span>
<span id="cb93-23"><a href="tuning.html#cb93-23" aria-hidden="true" tabindex="-1"></a>  conc_best_name <span class="ot">&lt;-</span> all_res[[<span class="st">&quot;score_names&quot;</span>]][<span class="fu">which.max</span>(mean_conc[,<span class="dv">2</span>])]</span>
<span id="cb93-24"><a href="tuning.html#cb93-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-25"><a href="tuning.html#cb93-25" aria-hidden="true" tabindex="-1"></a>  survfit_best_name <span class="ot">&lt;-</span> all_res[[<span class="st">&quot;score_names&quot;</span>]][<span class="fu">which.max</span>(mean_survfit[,<span class="dv">3</span>]<span class="sc">/</span>mean_survfit[,<span class="dv">1</span>])]</span>
<span id="cb93-26"><a href="tuning.html#cb93-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-27"><a href="tuning.html#cb93-27" aria-hidden="true" tabindex="-1"></a>  auc_best_name <span class="ot">&lt;-</span> all_res[[<span class="st">&quot;score_names&quot;</span>]][<span class="fu">which.max</span>(mean_auc[,<span class="dv">2</span>])]</span>
<span id="cb93-28"><a href="tuning.html#cb93-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-29"><a href="tuning.html#cb93-29" aria-hidden="true" tabindex="-1"></a>  or_best_name <span class="ot">&lt;-</span> all_res[[<span class="st">&quot;score_names&quot;</span>]][<span class="fu">which.max</span>(mean_or[,<span class="dv">2</span>])]</span>
<span id="cb93-30"><a href="tuning.html#cb93-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-31"><a href="tuning.html#cb93-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-32"><a href="tuning.html#cb93-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Write the result</span></span>
<span id="cb93-33"><a href="tuning.html#cb93-33" aria-hidden="true" tabindex="-1"></a>  to_write <span class="ot">&lt;-</span> <span class="fu">rbind</span>(conc_best_name, survfit_best_name, auc_best_name, or_best_name)</span>
<span id="cb93-34"><a href="tuning.html#cb93-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(to_write, <span class="fu">paste0</span>(<span class="st">&quot;tune_results/&quot;</span>, <span class="fu">tolower</span>(author), <span class="st">&quot;.best.ss&quot;</span>), <span class="at">row.names =</span> T, <span class="at">col.names =</span> F, <span class="at">quote =</span> F, <span class="at">sep =</span> <span class="st">&#39;</span><span class="sc">\t</span><span class="st">&#39;</span>)</span>
<span id="cb93-35"><a href="tuning.html#cb93-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-36"><a href="tuning.html#cb93-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Get name for each method</span></span>
<span id="cb93-37"><a href="tuning.html#cb93-37" aria-hidden="true" tabindex="-1"></a>  method_name <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">strsplit</span>(all_res[[<span class="st">&quot;score_names&quot;</span>]], <span class="st">&quot;.&quot;</span>, <span class="at">fixed =</span> T), <span class="cf">function</span>(x) x[<span class="dv">3</span>]))</span>
<span id="cb93-38"><a href="tuning.html#cb93-38" aria-hidden="true" tabindex="-1"></a>  umethod_name <span class="ot">&lt;-</span> <span class="fu">unique</span>(method_name)</span>
<span id="cb93-39"><a href="tuning.html#cb93-39" aria-hidden="true" tabindex="-1"></a>  best_method_name <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&quot;&quot;</span>, <span class="fu">length</span>(umethod_name))</span>
<span id="cb93-40"><a href="tuning.html#cb93-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(umethod_name)){</span>
<span id="cb93-41"><a href="tuning.html#cb93-41" aria-hidden="true" tabindex="-1"></a>    best_method_name[i] <span class="ot">&lt;-</span> all_res[[<span class="st">&quot;score_names&quot;</span>]][method_name <span class="sc">==</span> umethod_name[i]][<span class="fu">which.max</span>(mean_conc[method_name <span class="sc">==</span> umethod_name[i], <span class="dv">1</span>])]</span>
<span id="cb93-42"><a href="tuning.html#cb93-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb93-43"><a href="tuning.html#cb93-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(best_method_name, <span class="fu">paste0</span>(<span class="st">&quot;tune_results/&quot;</span>, <span class="fu">tolower</span>(author), <span class="st">&quot;.methods.ss&quot;</span>), <span class="at">row.names =</span> F, <span class="at">col.names =</span> F, <span class="at">quote =</span> F)</span>
<span id="cb93-44"><a href="tuning.html#cb93-44" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We can now go onto the testing phase, quickly and easily picking out the score name that corresponds to our preferred metric.</p>
</div>
<div id="plotting" class="section level2" number="8.3">
<h2><span class="header-section-number">8.3</span> Plotting</h2>
<p>Plotting is the final step in this process, converting all of the raw statistics into nice graphs that can be easily interpreted and checked for indications there are underlying errors in the code. I oddly have to break plotting into this final chunk as I am unable to make plots of my academic computing system, and instead do it locally on my laptop. The plotting script that I have written locally is really just one large function that allows for easy selection of which scores and stats to include in the output plots. However, no matter what plots are ultimately made there are 3 basic steps that are carried out.</p>
<p>First we read in the results for a specific disease and extract all of the score and method names that are evaluated. Then the function begins. We start by averaging over all the cross validation iterations to get one statistic value for each score. We similarly do this for the base statistics (predictions that did not include any score). For the survfit predictions we are only looking at the last row, or the cumulative incidence of the last recorded time. The code is:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="tuning.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb94-2"><a href="tuning.html#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb94-3"><a href="tuning.html#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb94-4"><a href="tuning.html#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_cowplot</span>())</span>
<span id="cb94-5"><a href="tuning.html#cb94-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-6"><a href="tuning.html#cb94-6" aria-hidden="true" tabindex="-1"></a>author <span class="ot">&lt;-</span> <span class="st">&quot;Kottgen&quot;</span></span>
<span id="cb94-7"><a href="tuning.html#cb94-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-8"><a href="tuning.html#cb94-8" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">&quot;tune_results/&quot;</span>, author, <span class="st">&quot;_res.RDS&quot;</span>))</span>
<span id="cb94-9"><a href="tuning.html#cb94-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-10"><a href="tuning.html#cb94-10" aria-hidden="true" tabindex="-1"></a>split_score_names <span class="ot">&lt;-</span> <span class="fu">str_split</span>(res[[<span class="st">&quot;score_names&quot;</span>]], <span class="fu">fixed</span>(<span class="st">&quot;.&quot;</span>), <span class="at">simplify =</span> T)</span>
<span id="cb94-11"><a href="tuning.html#cb94-11" aria-hidden="true" tabindex="-1"></a>simple_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(split_score_names[,<span class="dv">3</span>], <span class="st">&quot;-&quot;</span>, split_score_names[,<span class="dv">2</span>])</span>
<span id="cb94-12"><a href="tuning.html#cb94-12" aria-hidden="true" tabindex="-1"></a>method_name <span class="ot">&lt;-</span> split_score_names[,<span class="dv">3</span>]</span>
<span id="cb94-13"><a href="tuning.html#cb94-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-14"><a href="tuning.html#cb94-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-15"><a href="tuning.html#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="co">#do_plot_series &lt;- function(subset_inds, draw_plot_option = &quot;none&quot;, save_option = FALSE, best_stat = &quot;auc&quot;){</span></span>
<span id="cb94-16"><a href="tuning.html#cb94-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-17"><a href="tuning.html#cb94-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">unique</span>(method_name[subset_inds])) <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb94-18"><a href="tuning.html#cb94-18" aria-hidden="true" tabindex="-1"></a>    plot_ext <span class="ot">&lt;-</span> <span class="fu">unique</span>(method_name[subset_inds])</span>
<span id="cb94-19"><a href="tuning.html#cb94-19" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-20"><a href="tuning.html#cb94-20" aria-hidden="true" tabindex="-1"></a>    plot_ext <span class="ot">&lt;-</span> <span class="st">&quot;best&quot;</span></span>
<span id="cb94-21"><a href="tuning.html#cb94-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-22"><a href="tuning.html#cb94-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-23"><a href="tuning.html#cb94-23" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb94-24"><a href="tuning.html#cb94-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Average all of the results</span></span>
<span id="cb94-25"><a href="tuning.html#cb94-25" aria-hidden="true" tabindex="-1"></a>  mean_conc <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, res[[<span class="st">&quot;conc&quot;</span>]])<span class="sc">/</span><span class="fu">length</span>(res[[<span class="st">&quot;conc&quot;</span>]])</span>
<span id="cb94-26"><a href="tuning.html#cb94-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-27"><a href="tuning.html#cb94-27" aria-hidden="true" tabindex="-1"></a>  mean_survfit <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">length</span>(res[[<span class="st">&quot;survfit&quot;</span>]][[<span class="dv">1</span>]]), <span class="at">ncol =</span> <span class="dv">6</span>)</span>
<span id="cb94-28"><a href="tuning.html#cb94-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res[[<span class="st">&quot;survfit&quot;</span>]])){</span>
<span id="cb94-29"><a href="tuning.html#cb94-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res[[<span class="st">&quot;score_names&quot;</span>]])){</span>
<span id="cb94-30"><a href="tuning.html#cb94-30" aria-hidden="true" tabindex="-1"></a>      mean_survfit[j,] <span class="ot">&lt;-</span> mean_survfit[j,] <span class="sc">+</span> <span class="fu">as.numeric</span>(<span class="fu">tail</span>(res[[<span class="st">&quot;survfit&quot;</span>]][[i]][[j]],<span class="dv">1</span>)[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb94-31"><a href="tuning.html#cb94-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-32"><a href="tuning.html#cb94-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-33"><a href="tuning.html#cb94-33" aria-hidden="true" tabindex="-1"></a>  mean_survfit <span class="ot">&lt;-</span> mean_survfit<span class="sc">/</span><span class="fu">length</span>(res[[<span class="st">&quot;survfit&quot;</span>]])</span>
<span id="cb94-34"><a href="tuning.html#cb94-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-35"><a href="tuning.html#cb94-35" aria-hidden="true" tabindex="-1"></a>  mean_auc <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, res[[<span class="st">&quot;auc&quot;</span>]])<span class="sc">/</span><span class="fu">length</span>(res[[<span class="st">&quot;auc&quot;</span>]])</span>
<span id="cb94-36"><a href="tuning.html#cb94-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-37"><a href="tuning.html#cb94-37" aria-hidden="true" tabindex="-1"></a>  mean_or <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, res[[<span class="st">&quot;or&quot;</span>]])<span class="sc">/</span><span class="fu">length</span>(res[[<span class="st">&quot;or&quot;</span>]])</span>
<span id="cb94-38"><a href="tuning.html#cb94-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-39"><a href="tuning.html#cb94-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-40"><a href="tuning.html#cb94-40" aria-hidden="true" tabindex="-1"></a>  <span class="do">###########################################################################</span></span>
<span id="cb94-41"><a href="tuning.html#cb94-41" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Average for the base items</span></span>
<span id="cb94-42"><a href="tuning.html#cb94-42" aria-hidden="true" tabindex="-1"></a>  base_conc <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">3</span>)</span>
<span id="cb94-43"><a href="tuning.html#cb94-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res[[<span class="st">&quot;base&quot;</span>]][[<span class="dv">1</span>]])){</span>
<span id="cb94-44"><a href="tuning.html#cb94-44" aria-hidden="true" tabindex="-1"></a>    base_conc <span class="ot">&lt;-</span> base_conc <span class="sc">+</span> <span class="fu">as.numeric</span>(<span class="fu">c</span>(res[[<span class="st">&quot;base&quot;</span>]][[<span class="dv">1</span>]][[i]]<span class="sc">$</span>concordance,</span>
<span id="cb94-45"><a href="tuning.html#cb94-45" aria-hidden="true" tabindex="-1"></a>                                          res[[<span class="st">&quot;base&quot;</span>]][[<span class="dv">1</span>]][[i]]<span class="sc">$</span>std.err,</span>
<span id="cb94-46"><a href="tuning.html#cb94-46" aria-hidden="true" tabindex="-1"></a>                                          res[[<span class="st">&quot;base&quot;</span>]][[<span class="dv">1</span>]][[i]]<span class="sc">$</span>std.err <span class="sc">*</span> <span class="fl">1.96</span>))</span>
<span id="cb94-47"><a href="tuning.html#cb94-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-48"><a href="tuning.html#cb94-48" aria-hidden="true" tabindex="-1"></a>  base_conc <span class="ot">&lt;-</span> base_conc<span class="sc">/</span><span class="fu">length</span>(res[[<span class="st">&quot;base&quot;</span>]][[<span class="dv">1</span>]])</span>
<span id="cb94-49"><a href="tuning.html#cb94-49" aria-hidden="true" tabindex="-1"></a>  base_conc_mat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;base&quot;</span>, <span class="st">&quot;base&quot;</span>, <span class="fu">t</span>(base_conc), <span class="at">stringsAsFactors =</span> F)</span>
<span id="cb94-50"><a href="tuning.html#cb94-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(base_conc_mat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;score_name&quot;</span>, <span class="st">&quot;method&quot;</span>, <span class="st">&quot;conc&quot;</span>, <span class="st">&quot;se&quot;</span>, <span class="st">&quot;ci&quot;</span>)</span>
<span id="cb94-51"><a href="tuning.html#cb94-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-52"><a href="tuning.html#cb94-52" aria-hidden="true" tabindex="-1"></a>  base_survfit <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> <span class="dv">6</span>)</span>
<span id="cb94-53"><a href="tuning.html#cb94-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res[[<span class="st">&quot;base&quot;</span>]][[<span class="dv">2</span>]])){</span>
<span id="cb94-54"><a href="tuning.html#cb94-54" aria-hidden="true" tabindex="-1"></a>    base_survfit <span class="ot">&lt;-</span> base_survfit <span class="sc">+</span> <span class="fu">as.numeric</span>(<span class="fu">tail</span>(res[[<span class="st">&quot;base&quot;</span>]][[<span class="dv">2</span>]][[i]],<span class="dv">1</span>)[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb94-55"><a href="tuning.html#cb94-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-56"><a href="tuning.html#cb94-56" aria-hidden="true" tabindex="-1"></a>  base_survfit <span class="ot">&lt;-</span> base_survfit<span class="sc">/</span><span class="dv">9</span></span>
<span id="cb94-57"><a href="tuning.html#cb94-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-58"><a href="tuning.html#cb94-58" aria-hidden="true" tabindex="-1"></a>  base_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb94-59"><a href="tuning.html#cb94-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res[[<span class="st">&quot;base&quot;</span>]][[<span class="dv">3</span>]])){</span>
<span id="cb94-60"><a href="tuning.html#cb94-60" aria-hidden="true" tabindex="-1"></a>    base_auc <span class="ot">&lt;-</span> res[[<span class="st">&quot;base&quot;</span>]][[<span class="dv">3</span>]][[i]] <span class="sc">+</span> base_auc</span>
<span id="cb94-61"><a href="tuning.html#cb94-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-62"><a href="tuning.html#cb94-62" aria-hidden="true" tabindex="-1"></a>  base_auc <span class="ot">&lt;-</span> base_auc<span class="sc">/</span><span class="fu">length</span>(res[[<span class="st">&quot;base&quot;</span>]][[<span class="dv">3</span>]])</span>
<span id="cb94-63"><a href="tuning.html#cb94-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-64"><a href="tuning.html#cb94-64" aria-hidden="true" tabindex="-1"></a>  base_or <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb94-65"><a href="tuning.html#cb94-65" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res[[<span class="st">&quot;base&quot;</span>]][[<span class="dv">4</span>]])){</span>
<span id="cb94-66"><a href="tuning.html#cb94-66" aria-hidden="true" tabindex="-1"></a>    base_or <span class="ot">&lt;-</span> res[[<span class="st">&quot;base&quot;</span>]][[<span class="dv">4</span>]][[i]] <span class="sc">+</span> base_or</span>
<span id="cb94-67"><a href="tuning.html#cb94-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-68"><a href="tuning.html#cb94-68" aria-hidden="true" tabindex="-1"></a>  base_or <span class="ot">&lt;-</span> base_or<span class="sc">/</span><span class="fu">length</span>(res[[<span class="st">&quot;base&quot;</span>]][[<span class="dv">4</span>]])</span></code></pre></div>
<p>Second we actually construct the plots. The main plotting philosophy I try to follow is show the plain data without abstraction, keep it visually appealing while also detailed. For example, plotting points instead of bars and error bars wherever available. Specific to this investigation is the added requirement to include the base performance while differentiating it from the score performance. The code used is below, and the related plots are at the bottom of this section.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="tuning.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################################</span></span>
<span id="cb95-2"><a href="tuning.html#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="co">#CONC PLOT</span></span>
<span id="cb95-3"><a href="tuning.html#cb95-3" aria-hidden="true" tabindex="-1"></a>conc <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(simple_name, method_name, mean_conc)</span>
<span id="cb95-4"><a href="tuning.html#cb95-4" aria-hidden="true" tabindex="-1"></a>conc <span class="ot">&lt;-</span> conc[subset_inds,]</span>
<span id="cb95-5"><a href="tuning.html#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(conc) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;score_name&quot;</span>, <span class="st">&quot;method&quot;</span>, <span class="st">&quot;conc&quot;</span>, <span class="st">&quot;se&quot;</span>)</span>
<span id="cb95-6"><a href="tuning.html#cb95-6" aria-hidden="true" tabindex="-1"></a>conc<span class="sc">$</span>ci <span class="ot">&lt;-</span> conc<span class="sc">$</span>se <span class="sc">*</span> <span class="fl">1.96</span></span>
<span id="cb95-7"><a href="tuning.html#cb95-7" aria-hidden="true" tabindex="-1"></a>conc<span class="sc">$</span>score_name <span class="ot">&lt;-</span> <span class="fu">factor</span>(conc<span class="sc">$</span>score_name, <span class="at">levels =</span> conc<span class="sc">$</span>score_name[<span class="fu">order</span>(conc<span class="sc">$</span>conc)])</span>
<span id="cb95-8"><a href="tuning.html#cb95-8" aria-hidden="true" tabindex="-1"></a>the_conc_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(conc, <span class="fu">aes</span>(conc, score_name)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb95-9"><a href="tuning.html#cb95-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> conc<span class="sc">-</span>ci, <span class="at">xmax =</span> conc<span class="sc">+</span>ci, <span class="at">height =</span> <span class="fl">0.4</span>)) <span class="sc">+</span></span>
<span id="cb95-10"><a href="tuning.html#cb95-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Concordance&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Score Name&quot;</span>) <span class="sc">+</span></span>
<span id="cb95-11"><a href="tuning.html#cb95-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> base_conc[<span class="dv">1</span>], <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>)</span>
<span id="cb95-12"><a href="tuning.html#cb95-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-13"><a href="tuning.html#cb95-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-14"><a href="tuning.html#cb95-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-15"><a href="tuning.html#cb95-15" aria-hidden="true" tabindex="-1"></a><span class="co">#AUC PLOT</span></span>
<span id="cb95-16"><a href="tuning.html#cb95-16" aria-hidden="true" tabindex="-1"></a>auc <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(simple_name, method_name, mean_auc)</span>
<span id="cb95-17"><a href="tuning.html#cb95-17" aria-hidden="true" tabindex="-1"></a>auc <span class="ot">&lt;-</span> auc[subset_inds,]</span>
<span id="cb95-18"><a href="tuning.html#cb95-18" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(auc) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;score_name&quot;</span>, <span class="st">&quot;method&quot;</span>, <span class="st">&quot;ci_lo&quot;</span>, <span class="st">&quot;auc&quot;</span>, <span class="st">&quot;ci_hi&quot;</span>)</span>
<span id="cb95-19"><a href="tuning.html#cb95-19" aria-hidden="true" tabindex="-1"></a>auc<span class="sc">$</span>score_name <span class="ot">&lt;-</span> <span class="fu">factor</span>(auc<span class="sc">$</span>score_name, <span class="at">levels =</span> auc<span class="sc">$</span>score_name[<span class="fu">order</span>(auc<span class="sc">$</span>auc)])</span>
<span id="cb95-20"><a href="tuning.html#cb95-20" aria-hidden="true" tabindex="-1"></a>the_auc_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(auc, <span class="fu">aes</span>(auc, score_name)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb95-21"><a href="tuning.html#cb95-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> ci_lo, <span class="at">xmax =</span> ci_hi, <span class="at">height =</span> <span class="fl">0.4</span>)) <span class="sc">+</span></span>
<span id="cb95-22"><a href="tuning.html#cb95-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;AUC&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Score Name&quot;</span>) <span class="sc">+</span></span>
<span id="cb95-23"><a href="tuning.html#cb95-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> base_auc[<span class="dv">2</span>], <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>)</span>
<span id="cb95-24"><a href="tuning.html#cb95-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-25"><a href="tuning.html#cb95-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-26"><a href="tuning.html#cb95-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-27"><a href="tuning.html#cb95-27" aria-hidden="true" tabindex="-1"></a><span class="co">#EVENT RATE</span></span>
<span id="cb95-28"><a href="tuning.html#cb95-28" aria-hidden="true" tabindex="-1"></a>km_df <span class="ot">&lt;-</span> mean_survfit[subset_inds,]</span>
<span id="cb95-29"><a href="tuning.html#cb95-29" aria-hidden="true" tabindex="-1"></a>km_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mean_vals =</span> <span class="fu">as.numeric</span>(<span class="fu">t</span>(km_df[,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])), <span class="at">sd_vals =</span> <span class="fu">as.numeric</span>(<span class="fu">t</span>(km_df[,<span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>])))</span>
<span id="cb95-30"><a href="tuning.html#cb95-30" aria-hidden="true" tabindex="-1"></a>km_df<span class="sc">$</span>group <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">nrow</span>(km_df)<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb95-31"><a href="tuning.html#cb95-31" aria-hidden="true" tabindex="-1"></a>km_df<span class="sc">$</span>simple_name <span class="ot">&lt;-</span> <span class="fu">rep</span>(simple_name[subset_inds], <span class="at">each =</span> <span class="dv">3</span>)</span>
<span id="cb95-32"><a href="tuning.html#cb95-32" aria-hidden="true" tabindex="-1"></a>km_df<span class="sc">$</span>method_name <span class="ot">&lt;-</span> <span class="fu">rep</span>(method_name[subset_inds], <span class="at">each =</span> <span class="dv">3</span>)</span>
<span id="cb95-33"><a href="tuning.html#cb95-33" aria-hidden="true" tabindex="-1"></a>km_df<span class="sc">$</span>simple_name <span class="ot">&lt;-</span> <span class="fu">factor</span>(km_df<span class="sc">$</span>simple_name, <span class="at">levels =</span> km_df<span class="sc">$</span>simple_name[km_df<span class="sc">$</span>group <span class="sc">==</span> <span class="dv">3</span>][</span>
<span id="cb95-34"><a href="tuning.html#cb95-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">order</span>(km_df<span class="sc">$</span>mean_vals[km_df<span class="sc">$</span>group <span class="sc">==</span> <span class="dv">3</span>])])</span>
<span id="cb95-35"><a href="tuning.html#cb95-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-36"><a href="tuning.html#cb95-36" aria-hidden="true" tabindex="-1"></a>the_km_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(km_df, <span class="fu">aes</span>(simple_name, mean_vals, <span class="at">color =</span> group,</span>
<span id="cb95-37"><a href="tuning.html#cb95-37" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">ymin =</span> mean_vals <span class="sc">-</span> sd_vals, <span class="at">ymax =</span> mean_vals <span class="sc">+</span> sd_vals)) <span class="sc">+</span></span>
<span id="cb95-38"><a href="tuning.html#cb95-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb95-39"><a href="tuning.html#cb95-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.1</span>), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb95-40"><a href="tuning.html#cb95-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;Cumulative Hazard&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Score Name&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Risk</span><span class="sc">\n</span><span class="st">Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb95-41"><a href="tuning.html#cb95-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust=</span><span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb95-42"><a href="tuning.html#cb95-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> base_survfit[<span class="dv">1</span>], <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb95-43"><a href="tuning.html#cb95-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> base_survfit[<span class="dv">2</span>], <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb95-44"><a href="tuning.html#cb95-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> base_survfit[<span class="dv">3</span>], <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>)</span>
<span id="cb95-45"><a href="tuning.html#cb95-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-46"><a href="tuning.html#cb95-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-47"><a href="tuning.html#cb95-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-48"><a href="tuning.html#cb95-48" aria-hidden="true" tabindex="-1"></a><span class="co">#ODDS RATIO</span></span>
<span id="cb95-49"><a href="tuning.html#cb95-49" aria-hidden="true" tabindex="-1"></a>odds_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(mean_or, simple_name, method_name)</span>
<span id="cb95-50"><a href="tuning.html#cb95-50" aria-hidden="true" tabindex="-1"></a>odds_df <span class="ot">&lt;-</span> odds_df[subset_inds,]</span>
<span id="cb95-51"><a href="tuning.html#cb95-51" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(odds_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;lo&quot;</span>, <span class="st">&quot;or&quot;</span>, <span class="st">&quot;hi&quot;</span>, <span class="st">&quot;simple_name&quot;</span>, <span class="st">&quot;method_name&quot;</span>)</span>
<span id="cb95-52"><a href="tuning.html#cb95-52" aria-hidden="true" tabindex="-1"></a>odds_df<span class="sc">$</span>simple_name <span class="ot">&lt;-</span> <span class="fu">factor</span>(simple_name[subset_inds], simple_name[subset_inds][<span class="fu">order</span>(odds_df<span class="sc">$</span>or)])</span>
<span id="cb95-53"><a href="tuning.html#cb95-53" aria-hidden="true" tabindex="-1"></a>the_or_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(odds_df, <span class="fu">aes</span>(or, simple_name)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb95-54"><a href="tuning.html#cb95-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lo, <span class="at">xmax =</span> hi), <span class="at">height =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb95-55"><a href="tuning.html#cb95-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Odds Ratio&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Score Name&quot;</span>) <span class="sc">+</span></span>
<span id="cb95-56"><a href="tuning.html#cb95-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> base_or[<span class="dv">2</span>], <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>)</span></code></pre></div>
<p>Third we create rules to determine precisely which plots should be made. In theory we could create a plot for each statistic by score by disease. This would be thousands of plots and therefore not very helpful at all. We can combine all scores together but this would be over 100 scores on a single plot, making it very hard to read. The compromise I am currently going for is to plot the best score for each method for each statistic and all scores for each method for AUC only, thereby meaning we only need 4 + 12 plots per disease are made. The function I have written allows for more customization. We can set save option to TRUE and plot everything, or choose a best stat only. Additionaly, the input to the plotting function selects which scores I am looking at, they can be only the indices for a given method or the best methods. The code is below:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="tuning.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Get best name among the subsetinds</span></span>
<span id="cb96-2"><a href="tuning.html#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################################</span></span>
<span id="cb96-3"><a href="tuning.html#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(best_stat <span class="sc">==</span> <span class="st">&quot;conc&quot;</span>){</span>
<span id="cb96-4"><a href="tuning.html#cb96-4" aria-hidden="true" tabindex="-1"></a>  best_name <span class="ot">&lt;-</span> <span class="fu">as.character</span>(conc<span class="sc">$</span>score_name[<span class="fu">which.max</span>(conc<span class="sc">$</span>conc)])</span>
<span id="cb96-5"><a href="tuning.html#cb96-5" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span>(best_stat <span class="sc">==</span> <span class="st">&quot;auc&quot;</span>){</span>
<span id="cb96-6"><a href="tuning.html#cb96-6" aria-hidden="true" tabindex="-1"></a>  best_name <span class="ot">&lt;-</span> <span class="fu">as.character</span>(auc<span class="sc">$</span>score_name[<span class="fu">which.max</span>(auc<span class="sc">$</span>auc)])</span>
<span id="cb96-7"><a href="tuning.html#cb96-7" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span>(best_stat <span class="sc">==</span> <span class="st">&quot;km&quot;</span>){</span>
<span id="cb96-8"><a href="tuning.html#cb96-8" aria-hidden="true" tabindex="-1"></a>  comp_km <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">name =</span> km_df<span class="sc">$</span>simple_name[km_df<span class="sc">$</span>group <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb96-9"><a href="tuning.html#cb96-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">ratio =</span> km_df<span class="sc">$</span>mean_vals[km_df<span class="sc">$</span>group <span class="sc">==</span> <span class="dv">3</span>]<span class="sc">/</span>km_df<span class="sc">$</span>mean_vals[km_df<span class="sc">$</span>group <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb96-10"><a href="tuning.html#cb96-10" aria-hidden="true" tabindex="-1"></a>  comp_km<span class="sc">$</span>ratio[<span class="fu">is.na</span>(comp_km<span class="sc">$</span>ratio)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb96-11"><a href="tuning.html#cb96-11" aria-hidden="true" tabindex="-1"></a>  best_name <span class="ot">&lt;-</span> <span class="fu">as.character</span>(comp_km<span class="sc">$</span>name[<span class="fu">which.max</span>(comp_km<span class="sc">$</span>ratio)])</span>
<span id="cb96-12"><a href="tuning.html#cb96-12" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span>(best_stat <span class="sc">==</span> <span class="st">&quot;or&quot;</span>){</span>
<span id="cb96-13"><a href="tuning.html#cb96-13" aria-hidden="true" tabindex="-1"></a>  best_name <span class="ot">&lt;-</span> <span class="fu">as.character</span>(odds_df<span class="sc">$</span>simple_name[<span class="fu">which.max</span>(odds_df<span class="sc">$</span>or)])</span>
<span id="cb96-14"><a href="tuning.html#cb96-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-15"><a href="tuning.html#cb96-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-16"><a href="tuning.html#cb96-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-17"><a href="tuning.html#cb96-17" aria-hidden="true" tabindex="-1"></a><span class="co">#make the plots</span></span>
<span id="cb96-18"><a href="tuning.html#cb96-18" aria-hidden="true" tabindex="-1"></a><span class="do">#################################################################</span></span>
<span id="cb96-19"><a href="tuning.html#cb96-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(draw_plot_option <span class="sc">==</span> <span class="st">&quot;all&quot;</span>){</span>
<span id="cb96-20"><a href="tuning.html#cb96-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(the_auc_plot)</span>
<span id="cb96-21"><a href="tuning.html#cb96-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(the_conc_plot)</span>
<span id="cb96-22"><a href="tuning.html#cb96-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(the_or_plot)</span>
<span id="cb96-23"><a href="tuning.html#cb96-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(the_km_plot)</span>
<span id="cb96-24"><a href="tuning.html#cb96-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-25"><a href="tuning.html#cb96-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(save_option){</span>
<span id="cb96-26"><a href="tuning.html#cb96-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;output_plots/&quot;</span>, <span class="fu">tolower</span>(author), <span class="st">&quot;.&quot;</span>, plot_ext, <span class="st">&quot;.conc.tune.png&quot;</span>),</span>
<span id="cb96-27"><a href="tuning.html#cb96-27" aria-hidden="true" tabindex="-1"></a>           the_conc_plot <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="st">&quot;cm&quot;</span>)), <span class="st">&quot;png&quot;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">5</span>)</span>
<span id="cb96-28"><a href="tuning.html#cb96-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;output_plots/&quot;</span>, <span class="fu">tolower</span>(author), <span class="st">&quot;.&quot;</span>, plot_ext, <span class="st">&quot;.auc.tune.png&quot;</span>),</span>
<span id="cb96-29"><a href="tuning.html#cb96-29" aria-hidden="true" tabindex="-1"></a>           the_auc_plot <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="st">&quot;cm&quot;</span>)), <span class="st">&quot;png&quot;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">5</span>)</span>
<span id="cb96-30"><a href="tuning.html#cb96-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;output_plots/&quot;</span>, <span class="fu">tolower</span>(author), <span class="st">&quot;.&quot;</span>, plot_ext, <span class="st">&quot;.or.tune.png&quot;</span>),</span>
<span id="cb96-31"><a href="tuning.html#cb96-31" aria-hidden="true" tabindex="-1"></a>           the_or_plot <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="st">&quot;cm&quot;</span>)), <span class="st">&quot;png&quot;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">5</span>)</span>
<span id="cb96-32"><a href="tuning.html#cb96-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;output_plots/&quot;</span>, <span class="fu">tolower</span>(author), <span class="st">&quot;.&quot;</span>, plot_ext, <span class="st">&quot;.km.tune.png&quot;</span>),</span>
<span id="cb96-33"><a href="tuning.html#cb96-33" aria-hidden="true" tabindex="-1"></a>           the_km_plot <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="st">&quot;cm&quot;</span>)), <span class="st">&quot;png&quot;</span>, <span class="at">width =</span> <span class="dv">7</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb96-34"><a href="tuning.html#cb96-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-35"><a href="tuning.html#cb96-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-36"><a href="tuning.html#cb96-36" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(draw_plot_option <span class="sc">==</span> <span class="st">&quot;choose_stat&quot;</span>){</span>
<span id="cb96-37"><a href="tuning.html#cb96-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(best_stat <span class="sc">==</span> <span class="st">&quot;conc&quot;</span>){</span>
<span id="cb96-38"><a href="tuning.html#cb96-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(the_conc_plot)</span>
<span id="cb96-39"><a href="tuning.html#cb96-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(save_option){</span>
<span id="cb96-40"><a href="tuning.html#cb96-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;output_plots/&quot;</span>, <span class="fu">tolower</span>(author), <span class="st">&quot;.&quot;</span>, plot_ext, <span class="st">&quot;.conc.tune.png&quot;</span>),</span>
<span id="cb96-41"><a href="tuning.html#cb96-41" aria-hidden="true" tabindex="-1"></a>             the_conc_plot <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="st">&quot;cm&quot;</span>)), <span class="st">&quot;png&quot;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">5</span>)</span>
<span id="cb96-42"><a href="tuning.html#cb96-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-43"><a href="tuning.html#cb96-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-44"><a href="tuning.html#cb96-44" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(best_stat <span class="sc">==</span> <span class="st">&quot;auc&quot;</span>){</span>
<span id="cb96-45"><a href="tuning.html#cb96-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(the_auc_plot)</span>
<span id="cb96-46"><a href="tuning.html#cb96-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(save_option){</span>
<span id="cb96-47"><a href="tuning.html#cb96-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;output_plots/&quot;</span>, <span class="fu">tolower</span>(author), <span class="st">&quot;.&quot;</span>, plot_ext, <span class="st">&quot;.auc.tune.png&quot;</span>),</span>
<span id="cb96-48"><a href="tuning.html#cb96-48" aria-hidden="true" tabindex="-1"></a>             the_auc_plot <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="st">&quot;cm&quot;</span>)), <span class="st">&quot;png&quot;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">5</span>)</span>
<span id="cb96-49"><a href="tuning.html#cb96-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-50"><a href="tuning.html#cb96-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-51"><a href="tuning.html#cb96-51" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(best_stat <span class="sc">==</span> <span class="st">&quot;km&quot;</span>){</span>
<span id="cb96-52"><a href="tuning.html#cb96-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(the_km_plot)</span>
<span id="cb96-53"><a href="tuning.html#cb96-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(save_option){</span>
<span id="cb96-54"><a href="tuning.html#cb96-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;output_plots/&quot;</span>, <span class="fu">tolower</span>(author), <span class="st">&quot;.&quot;</span>, plot_ext, <span class="st">&quot;.km.tune.png&quot;</span>),</span>
<span id="cb96-55"><a href="tuning.html#cb96-55" aria-hidden="true" tabindex="-1"></a>             the_km_plot <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="st">&quot;cm&quot;</span>)), <span class="st">&quot;png&quot;</span>, <span class="at">width =</span> <span class="dv">7</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb96-56"><a href="tuning.html#cb96-56" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-57"><a href="tuning.html#cb96-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-58"><a href="tuning.html#cb96-58" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(best_stat <span class="sc">==</span> <span class="st">&quot;or&quot;</span>){</span>
<span id="cb96-59"><a href="tuning.html#cb96-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(the_or_plot)</span>
<span id="cb96-60"><a href="tuning.html#cb96-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(save_option){</span>
<span id="cb96-61"><a href="tuning.html#cb96-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;output_plots/&quot;</span>, <span class="fu">tolower</span>(author), <span class="st">&quot;.&quot;</span>, plot_ext, <span class="st">&quot;.or.tune.png&quot;</span>),</span>
<span id="cb96-62"><a href="tuning.html#cb96-62" aria-hidden="true" tabindex="-1"></a>             the_or_plot <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="st">&quot;cm&quot;</span>)), <span class="st">&quot;png&quot;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">5</span>)</span>
<span id="cb96-63"><a href="tuning.html#cb96-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-64"><a href="tuning.html#cb96-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-65"><a href="tuning.html#cb96-65" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-66"><a href="tuning.html#cb96-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-67"><a href="tuning.html#cb96-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-68"><a href="tuning.html#cb96-68" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(best_name)</span>
<span id="cb96-69"><a href="tuning.html#cb96-69" aria-hidden="true" tabindex="-1"></a><span class="co">#}</span></span>
<span id="cb96-70"><a href="tuning.html#cb96-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-71"><a href="tuning.html#cb96-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-72"><a href="tuning.html#cb96-72" aria-hidden="true" tabindex="-1"></a>best_names <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&quot;&quot;</span>, <span class="fu">length</span>(<span class="fu">unique</span>(method_name)))</span>
<span id="cb96-73"><a href="tuning.html#cb96-73" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(method_name))){</span>
<span id="cb96-74"><a href="tuning.html#cb96-74" aria-hidden="true" tabindex="-1"></a>  method_inds <span class="ot">&lt;-</span> <span class="fu">which</span>(method_name <span class="sc">%in%</span> <span class="fu">unique</span>(method_name)[i])</span>
<span id="cb96-75"><a href="tuning.html#cb96-75" aria-hidden="true" tabindex="-1"></a>  best_names[i] <span class="ot">&lt;-</span> <span class="fu">do_plot_series</span>(method_inds)</span>
<span id="cb96-76"><a href="tuning.html#cb96-76" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-77"><a href="tuning.html#cb96-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-78"><a href="tuning.html#cb96-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-79"><a href="tuning.html#cb96-79" aria-hidden="true" tabindex="-1"></a>final_best_name <span class="ot">&lt;-</span> <span class="fu">do_plot_series</span>(<span class="fu">which</span>(simple_name <span class="sc">%in%</span> best_names), <span class="st">&quot;all&quot;</span>, <span class="cn">TRUE</span>)</span></code></pre></div>
<p>Now the plots. There are 4 plots for each type of statistic, they appear as:</p>
<div class="figure"><span id="fig:unnamed-chunk-81"></span>
<img src="images/christophersen.best.auc.tune.png" alt="Tuning AUC Plot" width="100%" />
<p class="caption">
Figure 8.1: Tuning AUC Plot
</p>
</div>
<div class="figure"><span id="fig:unnamed-chunk-82"></span>
<img src="images/christophersen.best.or.tune.png" alt="Tuning OR Plot" width="100%" />
<p class="caption">
Figure 8.2: Tuning OR Plot
</p>
</div>
<div class="figure"><span id="fig:unnamed-chunk-83"></span>
<img src="images/christophersen.best.conc.tune.png" alt="Tuning Concordance Plot" width="100%" />
<p class="caption">
Figure 8.3: Tuning Concordance Plot
</p>
</div>
<div class="figure"><span id="fig:unnamed-chunk-84"></span>
<img src="images/christophersen.best.km.tune.png" alt="Tuning Kaplan-Meir Analysis Plot" width="100%" />
<p class="caption">
Figure 8.4: Tuning Kaplan-Meir Analysis Plot
</p>
</div>
<p>For all plots please see: <a href="https://wcm.box.com/s/h4xrik195rdp57a0hyhjdkgf55kcju0j" class="uri">https://wcm.box.com/s/h4xrik195rdp57a0hyhjdkgf55kcju0j</a> .</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="score-analysis-set-up.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="testing.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
