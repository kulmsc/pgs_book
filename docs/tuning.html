<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 Tuning | index.split</title>
  <meta name="description" content="" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="8 Tuning | index.split" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 Tuning | index.split" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="score-analysis-set-up.html"/>
<link rel="next" href="non-predictive-evaluation.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#directory-framework"><i class="fa fa-check"></i><b>1.1</b> Directory Framework</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="quality-control.html"><a href="quality-control.html"><i class="fa fa-check"></i><b>2</b> Quality Control</a><ul>
<li class="chapter" data-level="2.1" data-path="quality-control.html"><a href="quality-control.html#previously-applied-qc"><i class="fa fa-check"></i><b>2.1</b> Previously Applied QC</a></li>
<li class="chapter" data-level="2.2" data-path="quality-control.html"><a href="quality-control.html#initial-qc"><i class="fa fa-check"></i><b>2.2</b> Initial QC</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="summary-statistics.html"><a href="summary-statistics.html"><i class="fa fa-check"></i><b>3</b> Summary Statistics</a></li>
<li class="chapter" data-level="4" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html"><i class="fa fa-check"></i><b>4</b> Getting the Summary Statistics</a><ul>
<li class="chapter" data-level="4.1" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#prepare-variants"><i class="fa fa-check"></i><b>4.1</b> Prepare Variants</a></li>
<li class="chapter" data-level="4.2" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#standardize-the-summary-statistics"><i class="fa fa-check"></i><b>4.2</b> Standardize the Summary Statistics</a></li>
<li class="chapter" data-level="4.3" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#heritability-estimation"><i class="fa fa-check"></i><b>4.3</b> Heritability Estimation</a></li>
<li class="chapter" data-level="4.4" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#genetic-correlation-estimation"><i class="fa fa-check"></i><b>4.4</b> Genetic Correlation Estimation</a></li>
<li class="chapter" data-level="4.5" data-path="getting-the-summary-statistics.html"><a href="getting-the-summary-statistics.html#final-changes-and-remarks"><i class="fa fa-check"></i><b>4.5</b> Final Changes and Remarks</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html"><i class="fa fa-check"></i><b>5</b> Adjusting Summary Statistics</a><ul>
<li class="chapter" data-level="5.0.1" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#computational-framework"><i class="fa fa-check"></i><b>5.0.1</b> Computational Framework</a></li>
<li class="chapter" data-level="5.1" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#simple"><i class="fa fa-check"></i><b>5.1</b> Simple</a></li>
<li class="chapter" data-level="5.2" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#clumping"><i class="fa fa-check"></i><b>5.2</b> Clumping</a></li>
<li class="chapter" data-level="5.3" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#double-weight"><i class="fa fa-check"></i><b>5.3</b> Double Weight</a></li>
<li class="chapter" data-level="5.4" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#ldpred"><i class="fa fa-check"></i><b>5.4</b> LDpred</a></li>
<li class="chapter" data-level="5.5" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#ldpred2"><i class="fa fa-check"></i><b>5.5</b> LDpred2</a></li>
<li class="chapter" data-level="5.6" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#sblup"><i class="fa fa-check"></i><b>5.6</b> SBLUP</a></li>
<li class="chapter" data-level="5.7" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#smtpred"><i class="fa fa-check"></i><b>5.7</b> SMTpred</a></li>
<li class="chapter" data-level="5.8" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#prscs"><i class="fa fa-check"></i><b>5.8</b> prsCS</a></li>
<li class="chapter" data-level="5.9" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#lassosum"><i class="fa fa-check"></i><b>5.9</b> lassosum</a></li>
<li class="chapter" data-level="5.10" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#tweedie"><i class="fa fa-check"></i><b>5.10</b> Tweedie</a></li>
<li class="chapter" data-level="5.11" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#sbayesr"><i class="fa fa-check"></i><b>5.11</b> SBayesR</a></li>
<li class="chapter" data-level="5.12" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#jampred"><i class="fa fa-check"></i><b>5.12</b> JAMPred</a></li>
<li class="chapter" data-level="5.13" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#winners-curse-lasso"><i class="fa fa-check"></i><b>5.13</b> Winnerâ€™s Curse Lasso</a></li>
<li class="chapter" data-level="5.14" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#winners-curse-likelihood"><i class="fa fa-check"></i><b>5.14</b> Winnerâ€™s Curse Likelihood</a></li>
<li class="chapter" data-level="5.15" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#winners-curse-2d"><i class="fa fa-check"></i><b>5.15</b> Winnerâ€™s Curse 2D</a><ul>
<li class="chapter" data-level="5.15.1" data-path="adjusting-summary-statistics.html"><a href="adjusting-summary-statistics.html#additional-methods"><i class="fa fa-check"></i><b>5.15.1</b> Additional Methods</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html"><i class="fa fa-check"></i><b>6</b> Compiling the Scores</a><ul>
<li class="chapter" data-level="6.1" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#simple-score-approach"><i class="fa fa-check"></i><b>6.1</b> Simple Score Approach</a><ul>
<li class="chapter" data-level="6.1.1" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#what-to-worry-about"><i class="fa fa-check"></i><b>6.1.1</b> What to Worry About</a></li>
<li class="chapter" data-level="6.1.2" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#controlling-and-assembling"><i class="fa fa-check"></i><b>6.1.2</b> Controlling and Assembling</a></li>
<li class="chapter" data-level="6.1.3" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#verifying-everything-worked"><i class="fa fa-check"></i><b>6.1.3</b> Verifying Everything Worked</a></li>
<li class="chapter" data-level="6.1.4" data-path="compiling-the-scores.html"><a href="compiling-the-scores.html#other-options"><i class="fa fa-check"></i><b>6.1.4</b> Other Options</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html"><i class="fa fa-check"></i><b>7</b> Score Analysis Set-Up</a><ul>
<li class="chapter" data-level="7.1" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html#defining-the-phenotypes"><i class="fa fa-check"></i><b>7.1</b> Defining the Phenotypes</a></li>
<li class="chapter" data-level="7.2" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html#making-the-phenotype"><i class="fa fa-check"></i><b>7.2</b> Making the Phenotype</a></li>
<li class="chapter" data-level="7.3" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html#other-scores"><i class="fa fa-check"></i><b>7.3</b> Other Scores</a></li>
<li class="chapter" data-level="7.4" data-path="score-analysis-set-up.html"><a href="score-analysis-set-up.html#other-covariates"><i class="fa fa-check"></i><b>7.4</b> Other Covariates</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="tuning.html"><a href="tuning.html"><i class="fa fa-check"></i><b>8</b> Tuning</a><ul>
<li class="chapter" data-level="8.1" data-path="tuning.html"><a href="tuning.html#generating-metrics"><i class="fa fa-check"></i><b>8.1</b> Generating Metrics</a><ul>
<li class="chapter" data-level="8.1.1" data-path="tuning.html"><a href="tuning.html#overall-set-up"><i class="fa fa-check"></i><b>8.1.1</b> Overall Set-Up</a></li>
<li class="chapter" data-level="8.1.2" data-path="tuning.html"><a href="tuning.html#survival-set-up"><i class="fa fa-check"></i><b>8.1.2</b> Survival Set-up</a></li>
<li class="chapter" data-level="8.1.3" data-path="tuning.html"><a href="tuning.html#survival-base-metrics"><i class="fa fa-check"></i><b>8.1.3</b> Survival Base Metrics</a></li>
<li class="chapter" data-level="8.1.4" data-path="tuning.html"><a href="tuning.html#survival-score-metrics"><i class="fa fa-check"></i><b>8.1.4</b> Survival Score Metrics</a></li>
<li class="chapter" data-level="8.1.5" data-path="tuning.html"><a href="tuning.html#logistic-regression-base-metrics"><i class="fa fa-check"></i><b>8.1.5</b> Logistic Regression Base Metrics</a></li>
<li class="chapter" data-level="8.1.6" data-path="tuning.html"><a href="tuning.html#logistic-regression-score-metrics"><i class="fa fa-check"></i><b>8.1.6</b> Logistic Regression Score Metrics</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="tuning.html"><a href="tuning.html#choosing-the-best-score"><i class="fa fa-check"></i><b>8.2</b> Choosing the Best Score</a></li>
<li class="chapter" data-level="8.3" data-path="tuning.html"><a href="tuning.html#plotting"><i class="fa fa-check"></i><b>8.3</b> Plotting</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html"><i class="fa fa-check"></i><b>9</b> Non-Predictive Evaluation</a><ul>
<li class="chapter" data-level="9.1" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#analysis-of-score-sizes"><i class="fa fa-check"></i><b>9.1</b> Analysis of Score Sizes</a></li>
<li class="chapter" data-level="9.2" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#analysis-of-phenotype-definitions"><i class="fa fa-check"></i><b>9.2</b> Analysis of Phenotype Definitions</a></li>
<li class="chapter" data-level="9.3" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#comparison-of-racial-groups"><i class="fa fa-check"></i><b>9.3</b> Comparison of Racial Groups</a></li>
<li class="chapter" data-level="9.4" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#comparison-of-siblings"><i class="fa fa-check"></i><b>9.4</b> Comparison of Siblings</a></li>
<li class="chapter" data-level="9.5" data-path="non-predictive-evaluation.html"><a href="non-predictive-evaluation.html#mathematical-comparison-of-score-methods"><i class="fa fa-check"></i><b>9.5</b> Mathematical Comparison of Score Methods</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="testing.html"><a href="testing.html"><i class="fa fa-check"></i><b>10</b> Testing</a></li>
<li class="chapter" data-level="11" data-path="predictive-evaluations.html"><a href="predictive-evaluations.html"><i class="fa fa-check"></i><b>11</b> Predictive Evaluations</a><ul>
<li class="chapter" data-level="11.1" data-path="predictive-evaluations.html"><a href="predictive-evaluations.html#expanded-covariates"><i class="fa fa-check"></i><b>11.1</b> Expanded Covariates</a></li>
<li class="chapter" data-level="11.2" data-path="predictive-evaluations.html"><a href="predictive-evaluations.html#other-polygenic-risk-scores"><i class="fa fa-check"></i><b>11.2</b> Other Polygenic Risk Scores</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tuning" class="section level1">
<h1><span class="header-section-number">8</span> Tuning</h1>
<p>Tuning is the process of converting the large array of polygenic risk scores into a single recommendation of the best polygenic risk score. To understand the motivation behind this section we have to broaden our understanding of the purpose of this study. So far this study has focused on evaluating methods that produce polygenic risk scores. However, these scores and the underlying methods are only as good as their absolute risk stratification, not a relative performance to the other methods. If we analyzed the entire dataset with all scores to generate this absolute performance we would be overfitting the data, as the best score might have simply benefitted from the random split of data rather than actually being the best (just the same as a false positive in a t-test). Therefore we must split the data such that only one score is ever allowed to access part of the data. This way we will not get any overfitting.</p>
<p>Now that we understand the importance of tuning, or finding the best score on a subset of the data we move onto a large challenge of determining how to choose the best. While there are likely hundreds of metrics we can apply I have resolved to two forms of analyses for two different purposes. The first purpose is using the score as a covariate in downstream models that show links between the genetics of the scoreâ€™s trait and some other trait or event. The second purpose is using the score to stratify a cohort of individuals such that one subset achieves high enough risk that they warrant different treatment than the remaining subset. In the first purpose we would likely want the score to be well performing for all possible individuals, in the second purpose we only really need the score to work well at the far tails. Now onto the two forms of analyses. The first form is logistic regression, as it is simple, used before, and generates metrics that can easily be interpreted by nearly everyone. The second form is cox proportional hazard models, a slightly more advanced technique that takes into account the progression of time (a very important cause of disease and consideration in treatment). For our first and second purpose in logistic regression the logical metrics are AUC and odds ratio. There are other similar things we can measure but they will ultimately be measuring nearly the same thing. For our first and second purpose in logistic regression the logical metrics are concordance and cumulative incidence. What point in time should we choose for a point cumulative incidence seems logically unclear, so I went with the last possible time point. Now that we have the metrics we want to make there is only one more key consideration.</p>
<p>There are multiple different ways (in general) to create the metrics. The most basic would be to fit the model on all data possible and use the model to make a prediction upon the same data. This is simple and fast, but does not well recreate the scenario we will have when analyzing the testing data, where we form the model on one set of data then make a prediction on another set. Therefore we should go about some form of cross validation within our training dataset. Simple cross validation is nice, as it is again simple and fast, however with such small sample sizes we will only be able to run 3 folds leaving a very high variance in our metrics. In the effort to keep bias low while also lowering the variance I have decided to use repeated cross validation. In short 3-fold cross validation is run multiple times, each time picking a different way to splice up the data. Each person will still be used the same number of times as everyone else, it is just the group that person is with will change.</p>
<p>As this code is both important and potentially confusing I will explain each part in turn.</p>
<div id="generating-metrics" class="section level2">
<h2><span class="header-section-number">8.1</span> Generating Metrics</h2>
<div id="overall-set-up" class="section level3">
<h3><span class="header-section-number">8.1.1</span> Overall Set-Up</h3>
<p>The first part of our tuning script involves reading all nescessary data and generally sorting it. Although before we even do that we set-up some basic parameters including the name of the trait we are analyzing, the train/test split we are implementing across the entire UK Biobank, and lastly the number of folds and repeats within our cross validation scheme. We start our reading with the scores. After subsetting and combining them all into one object we apply a simple normalization that for each score value makes the lowest possible value 1 and highest value 100. We then read in the dates and convert them to R date format, which is tricky because there are different formats in different columns. We then condense these six columns down to one based upon which phenotype definition we are using. After completion we read in corresponding eids so the dates and phenotypes can be sorted correctly. Nearly at the end we read in raw death data, adding a dummy date for all people who are not within the death data. This way we can sort the death object so it lines up with everything else. Lastly we read in censor data and subset then sort.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" data-line-number="1"><span class="kw">library</span>(survival)</a>
<a class="sourceLine" id="cb81-2" data-line-number="2"><span class="kw">library</span>(pROC)</a>
<a class="sourceLine" id="cb81-3" data-line-number="3"><span class="kw">library</span>(epitools)</a>
<a class="sourceLine" id="cb81-4" data-line-number="4"></a>
<a class="sourceLine" id="cb81-5" data-line-number="5">author &lt;-<span class="st"> &quot;IMSGC&quot;</span></a>
<a class="sourceLine" id="cb81-6" data-line-number="6">phen_method &lt;-<span class="st"> &quot;all&quot;</span></a>
<a class="sourceLine" id="cb81-7" data-line-number="7">subrate_style &lt;-<span class="st"> &quot;fast&quot;</span></a>
<a class="sourceLine" id="cb81-8" data-line-number="8">train_frac &lt;-<span class="st"> </span><span class="fl">0.6</span></a>
<a class="sourceLine" id="cb81-9" data-line-number="9"></a>
<a class="sourceLine" id="cb81-10" data-line-number="10">input_folds &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb81-11" data-line-number="11">input_repeats &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb81-12" data-line-number="12"></a>
<a class="sourceLine" id="cb81-13" data-line-number="13"></a>
<a class="sourceLine" id="cb81-14" data-line-number="14"></a>
<a class="sourceLine" id="cb81-15" data-line-number="15"><span class="co">#THERE MAY BE PROBLEMS WITH SURV_DF</span></a>
<a class="sourceLine" id="cb81-16" data-line-number="16"></a>
<a class="sourceLine" id="cb81-17" data-line-number="17"><span class="co">#Read in the PGSs and sort down to training</span></a>
<a class="sourceLine" id="cb81-18" data-line-number="18"><span class="co">#all_scores &lt;- read.table(&quot;~/athena/doc_score/do_score/final_scores/all_scores.txt.gz&quot;, stringsAsFactors=F, header = T)</span></a>
<a class="sourceLine" id="cb81-19" data-line-number="19">all_scores &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb81-20" data-line-number="20">all_files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="st">&quot;~/athena/doc_score/do_score/final_scores&quot;</span>, <span class="st">&quot;RDS&quot;</span>)</a>
<a class="sourceLine" id="cb81-21" data-line-number="21"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(all_files)){</a>
<a class="sourceLine" id="cb81-22" data-line-number="22"> all_scores[[i]] &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="kw">paste0</span>(<span class="st">&quot;~/athena/doc_score/do_score/final_scores/&quot;</span>, all_files[i]))</a>
<a class="sourceLine" id="cb81-23" data-line-number="23">}</a>
<a class="sourceLine" id="cb81-24" data-line-number="24">all_scores &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;cbind&quot;</span>, all_scores)</a>
<a class="sourceLine" id="cb81-25" data-line-number="25">all_eid &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;~/athena/doc_score/do_score/all_specs/for_eid.fam&quot;</span>, <span class="dt">stringsAsFactors=</span>F)</a>
<a class="sourceLine" id="cb81-26" data-line-number="26">train_eid &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="kw">paste0</span>(<span class="st">&quot;~/athena/doc_score/qc/cv_files/train_eid.&quot;</span>, train_frac, <span class="st">&quot;.txt&quot;</span>), <span class="dt">stringsAsFactors=</span>F)</a>
<a class="sourceLine" id="cb81-27" data-line-number="27">all_scores &lt;-<span class="st"> </span>all_scores[all_eid[,<span class="dv">1</span>] <span class="op">%in%</span><span class="st"> </span>train_eid[,<span class="dv">1</span>],]</a>
<a class="sourceLine" id="cb81-28" data-line-number="28">eid &lt;-<span class="st"> </span>all_eid[all_eid[,<span class="dv">1</span>] <span class="op">%in%</span><span class="st"> </span>train_eid[,<span class="dv">1</span>],<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb81-29" data-line-number="29"></a>
<a class="sourceLine" id="cb81-30" data-line-number="30"><span class="co">#Normalize the scores</span></a>
<a class="sourceLine" id="cb81-31" data-line-number="31">scores &lt;-<span class="st"> </span>all_scores[,<span class="kw">grepl</span>(<span class="kw">tolower</span>(author), <span class="kw">colnames</span>(all_scores))]</a>
<a class="sourceLine" id="cb81-32" data-line-number="32">scores &lt;-<span class="st"> </span>scores[,<span class="kw">apply</span>(scores, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">length</span>(<span class="kw">unique</span>(x)) <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span>)]</a>
<a class="sourceLine" id="cb81-33" data-line-number="33">scores &lt;-<span class="st"> </span><span class="kw">apply</span>(scores, <span class="dv">2</span>, <span class="cf">function</span>(x) (x<span class="op">-</span><span class="kw">mean</span>(x)) <span class="op">/</span><span class="st"> </span>(<span class="kw">max</span>(<span class="kw">abs</span>((x<span class="op">-</span><span class="kw">mean</span>(x)))) <span class="op">*</span><span class="st"> </span><span class="fl">0.01</span>) )</a>
<a class="sourceLine" id="cb81-34" data-line-number="34"></a>
<a class="sourceLine" id="cb81-35" data-line-number="35"></a>
<a class="sourceLine" id="cb81-36" data-line-number="36"><span class="co">#Read in the phenotypes, order is: cancer sr, noncancer sr, icd9, icd10, oper, meds</span></a>
<a class="sourceLine" id="cb81-37" data-line-number="37"><span class="co">#selfasses date: 2018-11-22; hesin date: 21/01/2000</span></a>
<a class="sourceLine" id="cb81-38" data-line-number="38">pheno &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="kw">paste0</span>(<span class="st">&quot;../construct_defs/pheno_defs/diag.&quot;</span>, <span class="kw">tolower</span>(author), <span class="st">&quot;.txt.gz&quot;</span>), <span class="dt">stringsAsFactors=</span>F)</a>
<a class="sourceLine" id="cb81-39" data-line-number="39">dates &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="kw">paste0</span>(<span class="st">&quot;../construct_defs/pheno_defs/time.&quot;</span>, <span class="kw">tolower</span>(author), <span class="st">&quot;.txt.gz&quot;</span>), <span class="dt">stringsAsFactors=</span>F)</a>
<a class="sourceLine" id="cb81-40" data-line-number="40"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(dates)){</a>
<a class="sourceLine" id="cb81-41" data-line-number="41"> <span class="cf">if</span>(i <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">6</span>)){</a>
<a class="sourceLine" id="cb81-42" data-line-number="42">  dates[dates[,i] <span class="op">==</span><span class="st"> &quot;__________&quot;</span>, i] &lt;-<span class="st"> &quot;2020-12-31&quot;</span></a>
<a class="sourceLine" id="cb81-43" data-line-number="43">  dates[,i] &lt;-<span class="st"> </span><span class="kw">as.Date</span>(dates[,i], <span class="st">&quot;%Y-%m-%d&quot;</span>)</a>
<a class="sourceLine" id="cb81-44" data-line-number="44"> } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb81-45" data-line-number="45">  dates[dates[,i] <span class="op">==</span><span class="st"> &quot;__________&quot;</span>, i] &lt;-<span class="st"> &quot;31/12/2020&quot;</span></a>
<a class="sourceLine" id="cb81-46" data-line-number="46">  dates[,i] &lt;-<span class="st"> </span><span class="kw">as.Date</span>(dates[,i], <span class="st">&quot;%d/%m/%Y&quot;</span>)</a>
<a class="sourceLine" id="cb81-47" data-line-number="47"> }</a>
<a class="sourceLine" id="cb81-48" data-line-number="48">}</a>
<a class="sourceLine" id="cb81-49" data-line-number="49"></a>
<a class="sourceLine" id="cb81-50" data-line-number="50"><span class="cf">if</span>(phen_method <span class="op">==</span><span class="st"> &quot;icd&quot;</span>){</a>
<a class="sourceLine" id="cb81-51" data-line-number="51"> pheno &lt;-<span class="st"> </span>pheno[,<span class="dv">3</span><span class="op">:</span><span class="dv">4</span>]</a>
<a class="sourceLine" id="cb81-52" data-line-number="52"> dates &lt;-<span class="st"> </span>dates[,<span class="dv">3</span><span class="op">:</span><span class="dv">4</span>]</a>
<a class="sourceLine" id="cb81-53" data-line-number="53">} <span class="cf">else</span> <span class="cf">if</span>(phen_method <span class="op">==</span><span class="st"> &quot;selfrep&quot;</span>){</a>
<a class="sourceLine" id="cb81-54" data-line-number="54"> pheno &lt;-<span class="st"> </span>pheno[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="cb81-55" data-line-number="55"> dates &lt;-<span class="st"> </span>dates[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="cb81-56" data-line-number="56">} <span class="cf">else</span> <span class="cf">if</span>(phen_method <span class="op">==</span><span class="st"> &quot;icd_selfrep&quot;</span>){</a>
<a class="sourceLine" id="cb81-57" data-line-number="57"> pheno &lt;-<span class="st"> </span>pheno[,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</a>
<a class="sourceLine" id="cb81-58" data-line-number="58"> dates &lt;-<span class="st"> </span>dates[,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</a>
<a class="sourceLine" id="cb81-59" data-line-number="59">} <span class="cf">else</span> <span class="cf">if</span>(phen_method <span class="op">==</span><span class="st"> &quot;all&quot;</span> <span class="op">|</span><span class="st"> </span>phen_method <span class="op">==</span><span class="st"> &quot;double&quot;</span>){</a>
<a class="sourceLine" id="cb81-60" data-line-number="60"> <span class="kw">print</span>(<span class="st">&quot;doing nothing&quot;</span>)</a>
<a class="sourceLine" id="cb81-61" data-line-number="61">}</a>
<a class="sourceLine" id="cb81-62" data-line-number="62"></a>
<a class="sourceLine" id="cb81-63" data-line-number="63">dates &lt;-<span class="st"> </span><span class="kw">apply</span>(dates, <span class="dv">1</span>, min)</a>
<a class="sourceLine" id="cb81-64" data-line-number="64">dates[dates <span class="op">==</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&quot;2020-12-31&quot;</span>)] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb81-65" data-line-number="65"><span class="cf">if</span>(phen_method <span class="op">==</span><span class="st"> &quot;double&quot;</span>){</a>
<a class="sourceLine" id="cb81-66" data-line-number="66"> pheno &lt;-<span class="st"> </span><span class="kw">rowSums</span>(pheno)</a>
<a class="sourceLine" id="cb81-67" data-line-number="67"> pheno[pheno <span class="op">==</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb81-68" data-line-number="68"> pheno[pheno <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb81-69" data-line-number="69"> </a>
<a class="sourceLine" id="cb81-70" data-line-number="70"> dates[pheno <span class="op">==</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb81-71" data-line-number="71">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb81-72" data-line-number="72"> pheno &lt;-<span class="st"> </span><span class="kw">rowSums</span>(pheno)</a>
<a class="sourceLine" id="cb81-73" data-line-number="73"> pheno[pheno <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb81-74" data-line-number="74">}</a>
<a class="sourceLine" id="cb81-75" data-line-number="75"></a>
<a class="sourceLine" id="cb81-76" data-line-number="76"></a>
<a class="sourceLine" id="cb81-77" data-line-number="77"><span class="co">#Read in the eids used that are the same order as the pheno and dates, then subset the pheno and dates accordingly</span></a>
<a class="sourceLine" id="cb81-78" data-line-number="78">pheno_eids &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;../construct_defs/eid.csv&quot;</span>, <span class="dt">header =</span> T)</a>
<a class="sourceLine" id="cb81-79" data-line-number="79">pheno_eids &lt;-<span class="st"> </span>pheno_eids[<span class="kw">order</span>(pheno_eids[,<span class="dv">1</span>]),]</a>
<a class="sourceLine" id="cb81-80" data-line-number="80">pheno_eids &lt;-<span class="st"> </span>pheno_eids[<span class="op">-</span><span class="kw">length</span>(pheno_eids)]</a>
<a class="sourceLine" id="cb81-81" data-line-number="81">dates &lt;-<span class="st"> </span>dates[pheno_eids <span class="op">%in%</span><span class="st"> </span>eid]</a>
<a class="sourceLine" id="cb81-82" data-line-number="82">pheno &lt;-<span class="st"> </span>pheno[pheno_eids <span class="op">%in%</span><span class="st"> </span>eid]</a>
<a class="sourceLine" id="cb81-83" data-line-number="83">pheno_eids &lt;-<span class="st"> </span>pheno_eids[pheno_eids <span class="op">%in%</span><span class="st"> </span>eid]</a>
<a class="sourceLine" id="cb81-84" data-line-number="84">dates &lt;-<span class="st"> </span>dates[<span class="kw">order</span>(pheno_eids)[<span class="kw">rank</span>(eid)]]</a>
<a class="sourceLine" id="cb81-85" data-line-number="85">pheno &lt;-<span class="st"> </span>pheno[<span class="kw">order</span>(pheno_eids)[<span class="kw">rank</span>(eid)]]</a>
<a class="sourceLine" id="cb81-86" data-line-number="86"></a>
<a class="sourceLine" id="cb81-87" data-line-number="87"><span class="co">#Read in the base covars</span></a>
<a class="sourceLine" id="cb81-88" data-line-number="88">covars &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;../get_covars/base_covars.RDS&quot;</span>)</a>
<a class="sourceLine" id="cb81-89" data-line-number="89">covars &lt;-<span class="st"> </span>covars[covars[,<span class="dv">1</span>] <span class="op">%in%</span><span class="st"> </span>eid,]</a>
<a class="sourceLine" id="cb81-90" data-line-number="90">covars &lt;-<span class="st"> </span>covars[<span class="kw">order</span>(covars[,<span class="dv">1</span>])[<span class="kw">rank</span>(eid)],]</a>
<a class="sourceLine" id="cb81-91" data-line-number="91"></a>
<a class="sourceLine" id="cb81-92" data-line-number="92"><span class="co">#Set up survival analysis data frame</span></a>
<a class="sourceLine" id="cb81-93" data-line-number="93"><span class="co">#Artifically decide start date is 1999, that way all are even, if date is prior then remove it</span></a>
<a class="sourceLine" id="cb81-94" data-line-number="94"><span class="co">#The current maximum date possible is 31 May 2020</span></a>
<a class="sourceLine" id="cb81-95" data-line-number="95">death &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;~/athena/ukbiobank/hesin/death.txt&quot;</span>, <span class="dt">stringsAsFactors=</span>F, <span class="dt">header =</span> T)</a>
<a class="sourceLine" id="cb81-96" data-line-number="96">death[,<span class="dv">5</span>] &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">lapply</span>(death[,<span class="dv">5</span>], <span class="cf">function</span>(x) <span class="kw">paste0</span>(<span class="kw">strsplit</span>(x, <span class="st">&quot;/&quot;</span>)[[<span class="dv">1</span>]][<span class="dv">3</span>], <span class="st">&quot;-&quot;</span>, <span class="kw">strsplit</span>(x, <span class="st">&quot;/&quot;</span>)[[<span class="dv">1</span>]][<span class="dv">2</span>], <span class="st">&quot;-&quot;</span>, <span class="kw">strsplit</span>(x, <span class="st">&quot;/&quot;</span>)[[<span class="dv">1</span>]][<span class="dv">1</span>])))</a>
<a class="sourceLine" id="cb81-97" data-line-number="97">death &lt;-<span class="st"> </span>death[<span class="op">!</span><span class="kw">duplicated</span>(death[,<span class="dv">1</span>]),]</a>
<a class="sourceLine" id="cb81-98" data-line-number="98">death &lt;-<span class="st"> </span>death[death[,<span class="dv">1</span>] <span class="op">%in%</span><span class="st"> </span>eid,]</a>
<a class="sourceLine" id="cb81-99" data-line-number="99">add_on &lt;-<span class="st"> </span>death[<span class="dv">1</span>,]</a>
<a class="sourceLine" id="cb81-100" data-line-number="100">add_on[<span class="dv">5</span>] &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb81-101" data-line-number="101">add_eid &lt;-<span class="st"> </span>eid[<span class="op">!</span>(eid <span class="op">%in%</span><span class="st"> </span>death[,<span class="dv">1</span>])]</a>
<a class="sourceLine" id="cb81-102" data-line-number="102">add_on &lt;-<span class="st"> </span>add_on[<span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">length</span>(add_eid)),]</a>
<a class="sourceLine" id="cb81-103" data-line-number="103">add_on<span class="op">$</span>eid &lt;-<span class="st"> </span>add_eid</a>
<a class="sourceLine" id="cb81-104" data-line-number="104">death &lt;-<span class="st"> </span><span class="kw">rbind</span>(death, add_on)</a>
<a class="sourceLine" id="cb81-105" data-line-number="105">death &lt;-<span class="st"> </span>death[<span class="kw">order</span>(death[,<span class="dv">1</span>])[<span class="kw">rank</span>(eid)],]</a>
<a class="sourceLine" id="cb81-106" data-line-number="106"></a>
<a class="sourceLine" id="cb81-107" data-line-number="107">censor &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;../get_covars/covar_data/censor_covars&quot;</span>, <span class="dt">stringsAsFactors=</span>F, <span class="dt">header =</span> T, <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>)</a>
<a class="sourceLine" id="cb81-108" data-line-number="108">censor &lt;-<span class="st"> </span>censor[censor[,<span class="dv">1</span>] <span class="op">%in%</span><span class="st"> </span>eid,]</a>
<a class="sourceLine" id="cb81-109" data-line-number="109">censor &lt;-<span class="st"> </span>censor[<span class="kw">order</span>(censor[,<span class="dv">1</span>])[<span class="kw">rank</span>(eid)],]</a></code></pre></div>
<p>At this point we have many different objects that are all lined up and the right size.</p>
</div>
<div id="survival-set-up" class="section level3">
<h3><span class="header-section-number">8.1.2</span> Survival Set-up</h3>
<p>The second part still involves set up, although now stop reading things in and move to forming a data frame for survival analysis. This process starts with establishing a start and end time for each person in our study. The start time is established within this doccumentation (<a href="http://biobank.ndph.ox.ac.uk/showcase/exinfo.cgi?src=Data_providers_and_dates" class="uri">http://biobank.ndph.ox.ac.uk/showcase/exinfo.cgi?src=Data_providers_and_dates</a>). However, I have noticed that there are very few records before 1999, so just to be safe I am removing anyone with a diagnosis before that time and establishing 1999 as the start point. The end date is established within this doccumentation (<a href="http://biobank.ndph.ox.ac.uk/showcase/exinfo.cgi?src=timelines_all" class="uri">http://biobank.ndph.ox.ac.uk/showcase/exinfo.cgi?src=timelines_all</a>) and at my time of analysis it was 5/31/2020. However not everyone made it to this date. So we shorten the end date for people who have died, asked to be censored, or experienced our phenotype of interest. We then compile the difference in start and end date, a recording of whether the person was censored and which type, and other important covariates. While this work so far should be enough for a survival analysis astute modelers may be worried about competing risks, or the idea that if someone dies even though they would have otherwise experienced our phenotype then the model is flawed. To solve this problem we use Fine-Gray models from the amazing R survival package. The finegray function changes our original survival analysis data frame so that it contains extra weights and rows so it can run within the coxph function and generate proper Fine-Gray model estimates. We then split up the fine gray data frame so it contains either all scores or no scores. The last major thing going on is setting up our repeated cross validation. We create lists of lists that contain the set of training and testing eids needing in each round of modeling.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" data-line-number="1">start_date &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;1999-01-01&quot;</span>, <span class="kw">nrow</span>(scores))</a>
<a class="sourceLine" id="cb82-2" data-line-number="2">end_date &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;2020-05-31&quot;</span>, <span class="kw">nrow</span>(scores))</a>
<a class="sourceLine" id="cb82-3" data-line-number="3">end_date[censor[,<span class="dv">2</span>] <span class="op">!=</span><span class="st"> &quot;&quot;</span>] &lt;-<span class="st"> </span>censor[censor[,<span class="dv">2</span>] <span class="op">!=</span><span class="st"> &quot;&quot;</span>, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb82-4" data-line-number="4">end_date[death[,<span class="dv">5</span>] <span class="op">!=</span><span class="st"> &quot;&quot;</span>] &lt;-<span class="st"> </span>death[death[,<span class="dv">5</span>] <span class="op">!=</span><span class="st"> &quot;&quot;</span>, <span class="dv">5</span>]</a>
<a class="sourceLine" id="cb82-5" data-line-number="5">end_date[<span class="op">!</span><span class="kw">is.na</span>(dates)] &lt;-<span class="st"> </span>dates[<span class="op">!</span><span class="kw">is.na</span>(dates)]</a>
<a class="sourceLine" id="cb82-6" data-line-number="6">remove_eids &lt;-<span class="st"> </span>pheno_eids[<span class="kw">as.Date</span>(dates) <span class="op">&lt;</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&quot;1999-01-01&quot;</span>) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(dates)]</a>
<a class="sourceLine" id="cb82-7" data-line-number="7"></a>
<a class="sourceLine" id="cb82-8" data-line-number="8">is_death_date &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, <span class="kw">nrow</span>(scores))</a>
<a class="sourceLine" id="cb82-9" data-line-number="9">is_death_date[death[,<span class="dv">5</span>] <span class="op">!=</span><span class="st"> &quot;&quot;</span>] &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb82-10" data-line-number="10">surv_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">time =</span> <span class="kw">as.numeric</span>(<span class="kw">as.Date</span>(end_date) <span class="op">-</span><span class="st"> </span><span class="kw">as.Date</span>(start_date)), pheno, is_death_date, covars)</a>
<a class="sourceLine" id="cb82-11" data-line-number="11"></a>
<a class="sourceLine" id="cb82-12" data-line-number="12"></a>
<a class="sourceLine" id="cb82-13" data-line-number="13"><span class="co">#Set up Fine and Gray</span></a>
<a class="sourceLine" id="cb82-14" data-line-number="14"><span class="kw">print</span>(<span class="st">&quot;finegray&quot;</span>)</a>
<a class="sourceLine" id="cb82-15" data-line-number="15">event_type &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;censor&quot;</span>, <span class="kw">nrow</span>(surv_df))</a>
<a class="sourceLine" id="cb82-16" data-line-number="16">event_type[surv_df<span class="op">$</span>pheno <span class="op">==</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> &quot;diagnosis&quot;</span></a>
<a class="sourceLine" id="cb82-17" data-line-number="17">event_type[surv_df<span class="op">$</span>is_death_date <span class="op">==</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> &quot;death&quot;</span></a>
<a class="sourceLine" id="cb82-18" data-line-number="18">surv_df<span class="op">$</span>event_type &lt;-<span class="st"> </span><span class="kw">as.factor</span>(event_type)</a>
<a class="sourceLine" id="cb82-19" data-line-number="19">fg_diag &lt;-<span class="st"> </span><span class="kw">finegray</span>(<span class="kw">Surv</span>(time, event_type) <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> <span class="kw">cbind</span>(surv_df[,<span class="op">-</span><span class="kw">which</span>(<span class="kw">colnames</span>(surv_df) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;is_death_date&quot;</span>, <span class="st">&quot;pheno&quot;</span>))], scores), <span class="dt">etype=</span><span class="st">&quot;diagnosis&quot;</span>)</a>
<a class="sourceLine" id="cb82-20" data-line-number="20">fg_death &lt;-<span class="st"> </span><span class="kw">finegray</span>(<span class="kw">Surv</span>(time, event_type) <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> <span class="kw">cbind</span>(surv_df[,<span class="op">-</span><span class="kw">which</span>(<span class="kw">colnames</span>(surv_df) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;is_death_date&quot;</span>, <span class="st">&quot;pheno&quot;</span>))], scores), <span class="dt">etype=</span><span class="st">&quot;death&quot;</span>)</a>
<a class="sourceLine" id="cb82-21" data-line-number="21">fg_scores_diag &lt;-<span class="st"> </span>fg_diag[,<span class="kw">grepl</span>(<span class="kw">tolower</span>(author), <span class="kw">colnames</span>(fg_diag))]</a>
<a class="sourceLine" id="cb82-22" data-line-number="22">fg_scores_death &lt;-<span class="st"> </span>fg_death[,<span class="kw">grepl</span>(<span class="kw">tolower</span>(author), <span class="kw">colnames</span>(fg_death))]</a>
<a class="sourceLine" id="cb82-23" data-line-number="23">fg_diag &lt;-<span class="st"> </span>fg_diag[,<span class="op">!</span><span class="kw">grepl</span>(<span class="st">&quot;ss&quot;</span>, <span class="kw">colnames</span>(fg_diag))]</a>
<a class="sourceLine" id="cb82-24" data-line-number="24">fg_death &lt;-<span class="st"> </span>fg_death[,<span class="op">!</span><span class="kw">grepl</span>(<span class="st">&quot;ss&quot;</span>, <span class="kw">colnames</span>(fg_death))]</a>
<a class="sourceLine" id="cb82-25" data-line-number="25"></a>
<a class="sourceLine" id="cb82-26" data-line-number="26"></a>
<a class="sourceLine" id="cb82-27" data-line-number="27"><span class="co">#Need to set up repeated cross validation</span></a>
<a class="sourceLine" id="cb82-28" data-line-number="28">input_folds &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb82-29" data-line-number="29">input_repeats &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb82-30" data-line-number="30">size_group &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">nrow</span>(covars)<span class="op">/</span>input_folds)</a>
<a class="sourceLine" id="cb82-31" data-line-number="31">start_spots &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">seq</span>(<span class="dv">1</span>, size_group, <span class="dt">length.out=</span>input_repeats<span class="op">+</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb82-32" data-line-number="32">repeat_list &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb82-33" data-line-number="33"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>input_repeats){</a>
<a class="sourceLine" id="cb82-34" data-line-number="34"> folds_list &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb82-35" data-line-number="35"> <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>input_folds){</a>
<a class="sourceLine" id="cb82-36" data-line-number="36">  test_group &lt;-<span class="st"> </span>eid[(start_spots[i]<span class="op">+</span>((j<span class="dv">-1</span>)<span class="op">*</span>size_group))<span class="op">:</span>(start_spots[i]<span class="op">+</span>(j<span class="op">*</span>size_group))]</a>
<a class="sourceLine" id="cb82-37" data-line-number="37">  train_group &lt;-<span class="st"> </span>eid[<span class="op">!</span>(eid <span class="op">%in%</span><span class="st"> </span>test_group)]</a>
<a class="sourceLine" id="cb82-38" data-line-number="38">  train_group &lt;-<span class="st"> </span>train_group[<span class="op">!</span>(train_group <span class="op">%in%</span><span class="st"> </span>remove_eids)]</a>
<a class="sourceLine" id="cb82-39" data-line-number="39">  test_group &lt;-<span class="st"> </span>test_group[<span class="op">!</span>(test_group <span class="op">%in%</span><span class="st"> </span>remove_eids)]</a>
<a class="sourceLine" id="cb82-40" data-line-number="40">  folds_list[[j]] &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">&quot;train&quot;</span> =<span class="st"> </span>train_group, <span class="st">&quot;test&quot;</span> =<span class="st"> </span>test_group)</a>
<a class="sourceLine" id="cb82-41" data-line-number="41"> }</a>
<a class="sourceLine" id="cb82-42" data-line-number="42"> repeat_list[[i]] &lt;-<span class="st"> </span>folds_list</a>
<a class="sourceLine" id="cb82-43" data-line-number="43">}</a>
<a class="sourceLine" id="cb82-44" data-line-number="44"></a>
<a class="sourceLine" id="cb82-45" data-line-number="45"></a>
<a class="sourceLine" id="cb82-46" data-line-number="46">overall_counter &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb82-47" data-line-number="47">all_conc_holder &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb82-48" data-line-number="48">all_survfit_holder &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb82-49" data-line-number="49">all_auc_holder &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb82-50" data-line-number="50">all_or_holder &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb82-51" data-line-number="51">all_base_holder &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">4</span>, <span class="kw">list</span>())</a></code></pre></div>
<p>I am aware that there are other methods available for handling competing risks. I have found that while Fine-Gray is not perfect it is generally well understood and implemented, so I have chosen to use it here. At this point we are finally ready to get some metrics.</p>
</div>
<div id="survival-base-metrics" class="section level3">
<h3><span class="header-section-number">8.1.3</span> Survival Base Metrics</h3>
<p>We begin with the more difficult survival analyses. Before even starting we split the data into their own training and testing groups. Then we fit a coxph (which is really Fine-Gray) model without any polygenic risk score included. We then use this model upon the testing set to generate a concordance value. We use the survConcordance function to get this value, which I will stress is not the orthodox implementation of survConcordance (see <a href="https://stats.stackexchange.com/questions/234164/how-to-validate-cox-proportional-hazards-model" class="uri">https://stats.stackexchange.com/questions/234164/how-to-validate-cox-proportional-hazards-model</a>, with Dr.Â Harrell who inveneted many related statistics). However, at the end of the day I need a way to make a prediction and produce a global estimate of fit, and this function gets the job done without doing anything outright wrong. The next step is calculating cumulative incidence. This can be relatively easily calculated with the survfit function and pulling out the cumhaz object. Things get complicated when we want to see how much greater is the risk for one group of people than another group of people (group because we cannot analyze everyone at the same time). A great guide to everything survival curve related is within <a href="https://cran.r-project.org/web/packages/survival/vignettes/adjcurve.pdf" class="uri">https://cran.r-project.org/web/packages/survival/vignettes/adjcurve.pdf</a>. Starting in section 5.2 the authors relate how we can basically compare dummy individuals where all of the covariates are held constant except for the group of interest. This clearly creates many problems, which is why a better approach is to model the precise suvival curve of every individual and then average them based on the group the individual is within. The trade-off is that the better approach is very slow. Therefore we will take the slower approach here but when analyzing every score over every fold we will go with the faster approach.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" data-line-number="1"><span class="co">#for(nrepeat in 1:input_repeats){</span></a>
<a class="sourceLine" id="cb83-2" data-line-number="2"><span class="co"># for(nfold in 1:input_folds){</span></a>
<a class="sourceLine" id="cb83-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb83-4" data-line-number="4">  <span class="kw">print</span>(<span class="st">&quot;survival&quot;</span>)</a>
<a class="sourceLine" id="cb83-5" data-line-number="5">  <span class="co"># Set up the survival analysis data</span></a>
<a class="sourceLine" id="cb83-6" data-line-number="6">  fg_diag_train &lt;-<span class="st"> </span>fg_diag[fg_diag<span class="op">$</span>eid <span class="op">%in%</span><span class="st"> </span>repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;train&quot;</span>]],]</a>
<a class="sourceLine" id="cb83-7" data-line-number="7">  fg_diag_test &lt;-<span class="st"> </span>fg_diag[fg_diag<span class="op">$</span>eid <span class="op">%in%</span><span class="st"> </span>repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;test&quot;</span>]],]</a>
<a class="sourceLine" id="cb83-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb83-9" data-line-number="9">  surv_df_train &lt;-<span class="st"> </span>surv_df[surv_df<span class="op">$</span>eid <span class="op">%in%</span><span class="st"> </span>repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;train&quot;</span>]],]</a>
<a class="sourceLine" id="cb83-10" data-line-number="10">  surv_df_test &lt;-<span class="st"> </span>surv_df[surv_df<span class="op">$</span>eid <span class="op">%in%</span><span class="st"> </span>repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;test&quot;</span>]],]</a>
<a class="sourceLine" id="cb83-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb83-12" data-line-number="12">  </a>
<a class="sourceLine" id="cb83-13" data-line-number="13">  <span class="co">###########################################################</span></a>
<a class="sourceLine" id="cb83-14" data-line-number="14">  <span class="co">#                    SURVIVAL ANALYSES                    #</span></a>
<a class="sourceLine" id="cb83-15" data-line-number="15">  <span class="co">###########################################################</span></a>
<a class="sourceLine" id="cb83-16" data-line-number="16">  </a>
<a class="sourceLine" id="cb83-17" data-line-number="17">  base_mod &lt;-<span class="st"> </span><span class="kw">coxph</span>(<span class="kw">Surv</span>(fgstart, fgstop, fgstatus) <span class="op">~</span><span class="st">  </span>age <span class="op">+</span><span class="st"> </span>sex <span class="op">+</span><span class="st"> </span>PC1 <span class="op">+</span><span class="st"> </span>PC2 <span class="op">+</span><span class="st"> </span>PC3 <span class="op">+</span><span class="st"> </span>PC4 <span class="op">+</span><span class="st"> </span>PC5 <span class="op">+</span></a>
<a class="sourceLine" id="cb83-18" data-line-number="18"><span class="st">                     </span>PC6 <span class="op">+</span><span class="st"> </span>PC7 <span class="op">+</span><span class="st"> </span>PC8 <span class="op">+</span><span class="st"> </span>PC9 <span class="op">+</span><span class="st"> </span>PC10, <span class="dt">data =</span> fg_diag_train, <span class="dt">weight =</span> fgwt)</a>
<a class="sourceLine" id="cb83-19" data-line-number="19">  </a>
<a class="sourceLine" id="cb83-20" data-line-number="20">  base_conc &lt;-<span class="st"> </span><span class="kw">survConcordance</span>(<span class="kw">Surv</span>(fgstart, fgstop, fgstatus) <span class="op">~</span><span class="st"> </span><span class="kw">predict</span>(base_mod, fg_diag_test), <span class="dt">data =</span> fg_diag_test, <span class="dt">weight =</span> fgwt)</a>
<a class="sourceLine" id="cb83-21" data-line-number="21">  </a>
<a class="sourceLine" id="cb83-22" data-line-number="22">  </a>
<a class="sourceLine" id="cb83-23" data-line-number="23">  base_survfit &lt;-<span class="st"> </span><span class="kw">survfit</span>(base_mod, fg_diag_test, <span class="dt">se.fit =</span> F)</a>
<a class="sourceLine" id="cb83-24" data-line-number="24">  final_cumhaz &lt;-<span class="st"> </span>base_survfit<span class="op">$</span>cumhaz[<span class="kw">nrow</span>(base_survfit<span class="op">$</span>cumhaz),]</a>
<a class="sourceLine" id="cb83-25" data-line-number="25">  </a>
<a class="sourceLine" id="cb83-26" data-line-number="26">  group_factor &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">length</span>(final_cumhaz))</a>
<a class="sourceLine" id="cb83-27" data-line-number="27">  group_factor[final_cumhaz <span class="op">&lt;</span><span class="st"> </span><span class="kw">quantile</span>(final_cumhaz, <span class="fl">0.2</span>)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb83-28" data-line-number="28">  group_factor[final_cumhaz <span class="op">&gt;</span><span class="st"> </span><span class="kw">quantile</span>(final_cumhaz, <span class="fl">0.8</span>)] &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb83-29" data-line-number="29">  </a>
<a class="sourceLine" id="cb83-30" data-line-number="30">  base_cumhaz &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">time =</span> base_survfit<span class="op">$</span>time,</a>
<a class="sourceLine" id="cb83-31" data-line-number="31">                            <span class="dt">mean_lo =</span> <span class="kw">apply</span>(base_survfit<span class="op">$</span>cumhaz[,group_factor<span class="op">==</span><span class="dv">0</span>], <span class="dv">1</span>, mean),</a>
<a class="sourceLine" id="cb83-32" data-line-number="32">                            <span class="dt">mean_mid =</span> <span class="kw">apply</span>(base_survfit<span class="op">$</span>cumhaz[,group_factor<span class="op">==</span><span class="dv">1</span>], <span class="dv">1</span>, mean),</a>
<a class="sourceLine" id="cb83-33" data-line-number="33">                            <span class="dt">mean_hi =</span> <span class="kw">apply</span>(base_survfit<span class="op">$</span>cumhaz[,group_factor<span class="op">==</span><span class="dv">2</span>], <span class="dv">1</span>, mean),</a>
<a class="sourceLine" id="cb83-34" data-line-number="34">                            <span class="dt">sd_lo =</span> <span class="kw">apply</span>(base_survfit<span class="op">$</span>cumhaz[,group_factor<span class="op">==</span><span class="dv">0</span>], <span class="dv">1</span>, sd),</a>
<a class="sourceLine" id="cb83-35" data-line-number="35">                            <span class="dt">sd_mid =</span> <span class="kw">apply</span>(base_survfit<span class="op">$</span>cumhaz[,group_factor<span class="op">==</span><span class="dv">1</span>], <span class="dv">1</span>, sd),</a>
<a class="sourceLine" id="cb83-36" data-line-number="36">                            <span class="dt">sd_hi =</span> <span class="kw">apply</span>(base_survfit<span class="op">$</span>cumhaz[,group_factor<span class="op">==</span><span class="dv">2</span>], <span class="dv">1</span>, sd))</a></code></pre></div>
<p>An additional note on grouping. I initially planned to evaluate this non-global metric just based on how well the polygenic risk score does in bringing about risk stratification. But following the logic from the AUC metrics, where we find far greater value in comparing the baseline AUC to an AUC that also considers the polygenic risk score, this non-global metric should likely do the same. Therefore we have a baseline cumualtive incidence based on all possible covariates and then a score enhanced cumulative incidence as well.</p>
</div>
<div id="survival-score-metrics" class="section level3">
<h3><span class="header-section-number">8.1.4</span> Survival Score Metrics</h3>
<p>This code is nearly identical to the previous, except now we specify the fast and slow options that I explained in the previous section and iterate over each score, adding the score into the model before evaluating.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1">all_conc &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="kw">ncol</span>(scores), <span class="dt">ncol =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb84-2" data-line-number="2">all_subrates &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb84-3" data-line-number="3"></a>
<a class="sourceLine" id="cb84-4" data-line-number="4"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(all_conc)){</a>
<a class="sourceLine" id="cb84-5" data-line-number="5"> fg_diag_train<span class="op">$</span>score &lt;-<span class="st"> </span>fg_scores_diag[fg_diag<span class="op">$</span>eid <span class="op">%in%</span><span class="st"> </span>repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;train&quot;</span>]],i]</a>
<a class="sourceLine" id="cb84-6" data-line-number="6"> fg_diag_test<span class="op">$</span>score &lt;-<span class="st"> </span>fg_scores_diag[fg_diag<span class="op">$</span>eid <span class="op">%in%</span><span class="st"> </span>repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;test&quot;</span>]],i]</a>
<a class="sourceLine" id="cb84-7" data-line-number="7"> surv_df_train<span class="op">$</span>score &lt;-<span class="st"> </span>scores[surv_df<span class="op">$</span>eid <span class="op">%in%</span><span class="st"> </span>repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;train&quot;</span>]],i]</a>
<a class="sourceLine" id="cb84-8" data-line-number="8"> </a>
<a class="sourceLine" id="cb84-9" data-line-number="9"> <span class="co">#Make the model</span></a>
<a class="sourceLine" id="cb84-10" data-line-number="10"> score_mod &lt;-<span class="st"> </span><span class="kw">coxph</span>(<span class="kw">Surv</span>(fgstart, fgstop, fgstatus) <span class="op">~</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span>sex <span class="op">+</span><span class="st"> </span>PC1 <span class="op">+</span><span class="st"> </span>PC2 <span class="op">+</span><span class="st"> </span>PC3 <span class="op">+</span><span class="st"> </span>PC4 <span class="op">+</span><span class="st"> </span>PC5 <span class="op">+</span></a>
<a class="sourceLine" id="cb84-11" data-line-number="11"><span class="st">                     </span>PC6 <span class="op">+</span><span class="st"> </span>PC7 <span class="op">+</span><span class="st"> </span>PC8 <span class="op">+</span><span class="st"> </span>PC9 <span class="op">+</span><span class="st"> </span>PC10 <span class="op">+</span><span class="st"> </span>score, <span class="dt">data =</span> fg_diag_train, <span class="dt">weight =</span> fgwt)</a>
<a class="sourceLine" id="cb84-12" data-line-number="12"> </a>
<a class="sourceLine" id="cb84-13" data-line-number="13"> <span class="co">#CONCORDANCE ###################################</span></a>
<a class="sourceLine" id="cb84-14" data-line-number="14"> score_conc_obj &lt;-<span class="st"> </span><span class="kw">survConcordance</span>(<span class="kw">Surv</span>(fgstart, fgstop, fgstatus) <span class="op">~</span><span class="st"> </span><span class="kw">predict</span>(score_mod, fg_diag_test), <span class="dt">data =</span> fg_diag_test, <span class="dt">weight =</span> fgwt)</a>
<a class="sourceLine" id="cb84-15" data-line-number="15"> </a>
<a class="sourceLine" id="cb84-16" data-line-number="16"> all_conc[i,<span class="dv">1</span>] &lt;-<span class="st"> </span>score_conc_obj<span class="op">$</span>conc</a>
<a class="sourceLine" id="cb84-17" data-line-number="17"> all_conc[i,<span class="dv">2</span>] &lt;-<span class="st"> </span>score_conc_obj<span class="op">$</span>std.err</a>
<a class="sourceLine" id="cb84-18" data-line-number="18"> </a>
<a class="sourceLine" id="cb84-19" data-line-number="19"> </a>
<a class="sourceLine" id="cb84-20" data-line-number="20"> <span class="co">#SURVFIT ##########################################</span></a>
<a class="sourceLine" id="cb84-21" data-line-number="21"> <span class="co">#SLOW</span></a>
<a class="sourceLine" id="cb84-22" data-line-number="22"> <span class="cf">if</span>(subrate_style <span class="op">==</span><span class="st"> &quot;slow&quot;</span>){</a>
<a class="sourceLine" id="cb84-23" data-line-number="23">  score_survfit &lt;-<span class="st"> </span><span class="kw">survfit</span>(score_mod, fg_diag_test, <span class="dt">se.fit =</span> F)</a>
<a class="sourceLine" id="cb84-24" data-line-number="24">  final_cumhaz &lt;-<span class="st"> </span>score_survfit<span class="op">$</span>cumhaz[<span class="kw">nrow</span>(score_survfit<span class="op">$</span>cumhaz),]</a>
<a class="sourceLine" id="cb84-25" data-line-number="25">  </a>
<a class="sourceLine" id="cb84-26" data-line-number="26">  group_factor &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">length</span>(final_cumhaz))</a>
<a class="sourceLine" id="cb84-27" data-line-number="27">  group_factor[final_cumhaz <span class="op">&lt;</span><span class="st"> </span><span class="kw">quantile</span>(final_cumhaz, <span class="fl">0.2</span>)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb84-28" data-line-number="28">  group_factor[final_cumhaz <span class="op">&gt;</span><span class="st"> </span><span class="kw">quantile</span>(final_cumhaz, <span class="fl">0.8</span>)] &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb84-29" data-line-number="29">  </a>
<a class="sourceLine" id="cb84-30" data-line-number="30">  pred_cumhaz_score &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">time =</span> score_survfit<span class="op">$</span>time,</a>
<a class="sourceLine" id="cb84-31" data-line-number="31">                                  <span class="dt">mean_lo =</span> <span class="kw">apply</span>(score_survfit<span class="op">$</span>cumhaz[,group_factor<span class="op">==</span><span class="dv">0</span>], <span class="dv">1</span>, mean),</a>
<a class="sourceLine" id="cb84-32" data-line-number="32">                                  <span class="dt">mean_mid =</span> <span class="kw">apply</span>(score_survfit<span class="op">$</span>cumhaz[,group_factor<span class="op">==</span><span class="dv">1</span>], <span class="dv">1</span>, mean),</a>
<a class="sourceLine" id="cb84-33" data-line-number="33">                                  <span class="dt">mean_hi =</span> <span class="kw">apply</span>(score_survfit<span class="op">$</span>cumhaz[,group_factor<span class="op">==</span><span class="dv">2</span>], <span class="dv">1</span>, mean),</a>
<a class="sourceLine" id="cb84-34" data-line-number="34">                                  <span class="dt">sd_lo =</span> <span class="kw">apply</span>(score_survfit<span class="op">$</span>cumhaz[,group_factor<span class="op">==</span><span class="dv">0</span>], <span class="dv">1</span>, sd),</a>
<a class="sourceLine" id="cb84-35" data-line-number="35">                                  <span class="dt">sd_mid =</span> <span class="kw">apply</span>(score_survfit<span class="op">$</span>cumhaz[,group_factor<span class="op">==</span><span class="dv">1</span>], <span class="dv">1</span>, sd),</a>
<a class="sourceLine" id="cb84-36" data-line-number="36">                                  <span class="dt">sd_hi =</span> <span class="kw">apply</span>(score_survfit<span class="op">$</span>cumhaz[,group_factor<span class="op">==</span><span class="dv">2</span>], <span class="dv">1</span>, sd))</a>
<a class="sourceLine" id="cb84-37" data-line-number="37">  pred_cumhaz_score &lt;-<span class="st"> </span>pred_cumhaz_score[<span class="op">!</span><span class="kw">duplicated</span>(pred_cumhaz_score<span class="op">$</span>mean_mid),]</a>
<a class="sourceLine" id="cb84-38" data-line-number="38"> } <span class="cf">else</span> <span class="cf">if</span>(subrate_style <span class="op">==</span><span class="st"> &quot;fast&quot;</span>){ </a>
<a class="sourceLine" id="cb84-39" data-line-number="39">  <span class="co">#FAST</span></a>
<a class="sourceLine" id="cb84-40" data-line-number="40">  group_list &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb84-41" data-line-number="41">  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(<span class="kw">names</span>(score_mod<span class="op">$</span>coef))){</a>
<a class="sourceLine" id="cb84-42" data-line-number="42">   group_list[[k]] &lt;-<span class="st">  </span><span class="kw">as.numeric</span>(<span class="kw">quantile</span>(surv_df_train[[<span class="kw">names</span>(score_mod<span class="op">$</span>coef)[k]]], <span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>)))</a>
<a class="sourceLine" id="cb84-43" data-line-number="43">   <span class="cf">if</span>(<span class="kw">sign</span>(score_mod<span class="op">$</span>coef[k] <span class="op">==</span><span class="st"> </span><span class="dv">-1</span>)){</a>
<a class="sourceLine" id="cb84-44" data-line-number="44">    group_list[[k]] &lt;-<span class="st"> </span><span class="kw">rev</span>(group_list[[k]])</a>
<a class="sourceLine" id="cb84-45" data-line-number="45">   }</a>
<a class="sourceLine" id="cb84-46" data-line-number="46">  }</a>
<a class="sourceLine" id="cb84-47" data-line-number="47">  mean_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">do.call</span>(<span class="st">&quot;cbind&quot;</span>, group_list))</a>
<a class="sourceLine" id="cb84-48" data-line-number="48">  <span class="kw">colnames</span>(mean_df) &lt;-<span class="st"> </span><span class="kw">names</span>(score_mod<span class="op">$</span>coef)</a>
<a class="sourceLine" id="cb84-49" data-line-number="49">  <span class="cf">if</span>(<span class="kw">sign</span>(score_mod<span class="op">$</span>coef[<span class="dv">2</span>]) <span class="op">==</span><span class="st"> </span><span class="dv">-1</span>){</a>
<a class="sourceLine" id="cb84-50" data-line-number="50">   mean_df<span class="op">$</span>sex &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.9</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb84-51" data-line-number="51">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb84-52" data-line-number="52">   mean_df<span class="op">$</span>sex &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>)</a>
<a class="sourceLine" id="cb84-53" data-line-number="53">  }</a>
<a class="sourceLine" id="cb84-54" data-line-number="54">  </a>
<a class="sourceLine" id="cb84-55" data-line-number="55">  score_pred &lt;-<span class="st"> </span><span class="kw">survfit</span>(score_mod, <span class="dt">newdata =</span> mean_df)</a>
<a class="sourceLine" id="cb84-56" data-line-number="56">  </a>
<a class="sourceLine" id="cb84-57" data-line-number="57">  pred_cumhaz_score &lt;-<span class="st"> </span><span class="kw">data.frame</span>(score_pred<span class="op">$</span>time, score_pred<span class="op">$</span>cumhaz, score_pred<span class="op">$</span>std.err)</a>
<a class="sourceLine" id="cb84-58" data-line-number="58">  <span class="kw">colnames</span>(pred_cumhaz_score) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;mean_lo&quot;</span>, <span class="st">&quot;mean_mid&quot;</span>, <span class="st">&quot;mean_hi&quot;</span>, <span class="st">&quot;sd_lo&quot;</span>, <span class="st">&quot;sd_mid&quot;</span>, <span class="st">&quot;sd_hi&quot;</span>)</a>
<a class="sourceLine" id="cb84-59" data-line-number="59">  pred_cumhaz_score &lt;-<span class="st"> </span>pred_cumhaz_score[<span class="op">!</span><span class="kw">duplicated</span>(pred_cumhaz_score<span class="op">$</span>mean_mid),]</a>
<a class="sourceLine" id="cb84-60" data-line-number="60"> }</a>
<a class="sourceLine" id="cb84-61" data-line-number="61"> </a>
<a class="sourceLine" id="cb84-62" data-line-number="62"> </a>
<a class="sourceLine" id="cb84-63" data-line-number="63"> all_subrates[[i]] &lt;-<span class="st"> </span>pred_cumhaz_score</a>
<a class="sourceLine" id="cb84-64" data-line-number="64"> </a>
<a class="sourceLine" id="cb84-65" data-line-number="65">}</a></code></pre></div>
</div>
<div id="logistic-regression-base-metrics" class="section level3">
<h3><span class="header-section-number">8.1.5</span> Logistic Regression Base Metrics</h3>
<p>Now we may move onto the relatively easier logistic regression metrics. The overall format of this code is similar to the survival base metrics, as in we first fit a base model and then calculate the AUC by making a prediction on the withheld dataset. Next we move onto the odds ratios, as explained previously the groups (or the exposed/non-exposed individuals) are determined by all the covariates in order to see how much the inclusion of the score improves the odds ratio. After producing the 2x2 contingency table through the full model prediction we get the odds ratio and the confidence intervals through the nice oddsratio.wald function.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" data-line-number="1"><span class="co"># Set up the normal model data</span></a>
<a class="sourceLine" id="cb85-2" data-line-number="2"><span class="kw">print</span>(<span class="st">&quot;normal&quot;</span>)</a>
<a class="sourceLine" id="cb85-3" data-line-number="3"></a>
<a class="sourceLine" id="cb85-4" data-line-number="4">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(pheno, covars[,<span class="op">-</span><span class="dv">1</span>])</a>
<a class="sourceLine" id="cb85-5" data-line-number="5">df_train &lt;-<span class="st"> </span>df[covars[,<span class="dv">1</span>] <span class="op">%in%</span><span class="st"> </span>repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;train&quot;</span>]],]</a>
<a class="sourceLine" id="cb85-6" data-line-number="6">df_test &lt;-<span class="st"> </span>df[covars[,<span class="dv">1</span>] <span class="op">%in%</span><span class="st"> </span>repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;test&quot;</span>]],]</a>
<a class="sourceLine" id="cb85-7" data-line-number="7">scores_train &lt;-<span class="st"> </span>scores[covars[,<span class="dv">1</span>] <span class="op">%in%</span><span class="st"> </span>repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;train&quot;</span>]],]</a>
<a class="sourceLine" id="cb85-8" data-line-number="8">scores_test &lt;-<span class="st"> </span>scores[covars[,<span class="dv">1</span>] <span class="op">%in%</span><span class="st"> </span>repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;test&quot;</span>]],]</a>
<a class="sourceLine" id="cb85-9" data-line-number="9">pheno_test &lt;-<span class="st"> </span>pheno[covars[,<span class="dv">1</span>] <span class="op">%in%</span><span class="st"> </span>repeat_list[[nrepeat]][[nfold]][[<span class="st">&quot;test&quot;</span>]]]</a>
<a class="sourceLine" id="cb85-10" data-line-number="10"></a>
<a class="sourceLine" id="cb85-11" data-line-number="11"><span class="co">###########################################################</span></a>
<a class="sourceLine" id="cb85-12" data-line-number="12"><span class="co">#                    NORMAL MODELS                        #</span></a>
<a class="sourceLine" id="cb85-13" data-line-number="13"><span class="co">###########################################################</span></a>
<a class="sourceLine" id="cb85-14" data-line-number="14"></a>
<a class="sourceLine" id="cb85-15" data-line-number="15">base_mod &lt;-<span class="st"> </span><span class="kw">glm</span>(pheno <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> df_train, <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>)</a>
<a class="sourceLine" id="cb85-16" data-line-number="16">base_pred &lt;-<span class="st"> </span><span class="kw">predict</span>(base_mod, df_test)</a>
<a class="sourceLine" id="cb85-17" data-line-number="17">base_roc &lt;-<span class="st"> </span><span class="kw">roc</span>(pheno_test <span class="op">~</span><span class="st"> </span>base_pred)</a>
<a class="sourceLine" id="cb85-18" data-line-number="18">base_auc &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">ci.auc</span>(base_roc))</a>
<a class="sourceLine" id="cb85-19" data-line-number="19"></a>
<a class="sourceLine" id="cb85-20" data-line-number="20">base_group &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">length</span>(base_pred))</a>
<a class="sourceLine" id="cb85-21" data-line-number="21">base_group[base_pred <span class="op">&lt;</span><span class="st"> </span><span class="kw">quantile</span>(base_pred, <span class="fl">0.2</span>)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb85-22" data-line-number="22">base_group[base_pred <span class="op">&gt;</span><span class="st"> </span><span class="kw">quantile</span>(base_pred, <span class="fl">0.8</span>)] &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb85-23" data-line-number="23">base_odds_table &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">sum</span>(df_test<span class="op">$</span>pheno <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>base_group <span class="op">==</span><span class="st"> </span><span class="dv">2</span>), <span class="kw">sum</span>(df_test<span class="op">$</span>pheno <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>base_group <span class="op">==</span><span class="st"> </span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb85-24" data-line-number="24">                            <span class="kw">sum</span>(df_test<span class="op">$</span>pheno <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>base_group <span class="op">==</span><span class="st"> </span><span class="dv">0</span>), <span class="kw">sum</span>(df_test<span class="op">$</span>pheno <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>base_group <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)), <span class="dt">nrow =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb85-25" data-line-number="25">base_odds_ratio &lt;-<span class="st"> </span><span class="kw">oddsratio.wald</span>(base_odds_table)</a>
<a class="sourceLine" id="cb85-26" data-line-number="26">base_odds_ratio &lt;-<span class="st"> </span>base_odds_ratio<span class="op">$</span>measure[<span class="dv">2</span>,<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">3</span>)]</a></code></pre></div>
</div>
<div id="logistic-regression-score-metrics" class="section level3">
<h3><span class="header-section-number">8.1.6</span> Logistic Regression Score Metrics</h3>
<p>Again, this process is very similar to what was previously explained except now the models include the polygenic risk score. At the end of all the loops we also see how all of the metrics are collected together then saved.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" data-line-number="1">all_auc &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="kw">ncol</span>(scores), <span class="dt">ncol =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb86-2" data-line-number="2">all_odds_ratio &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="kw">ncol</span>(scores), <span class="dt">ncol =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb86-3" data-line-number="3"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(scores)){</a>
<a class="sourceLine" id="cb86-4" data-line-number="4"> df_train<span class="op">$</span>score &lt;-<span class="st"> </span>scores_train[,i]</a>
<a class="sourceLine" id="cb86-5" data-line-number="5"> df_test<span class="op">$</span>score &lt;-<span class="st"> </span>scores_test[,i]</a>
<a class="sourceLine" id="cb86-6" data-line-number="6"> <span class="co">#Make the model</span></a>
<a class="sourceLine" id="cb86-7" data-line-number="7"> score_mod &lt;-<span class="st"> </span><span class="kw">glm</span>(pheno <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> df_train, <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>)</a>
<a class="sourceLine" id="cb86-8" data-line-number="8"> score_pred &lt;-<span class="st"> </span><span class="kw">predict</span>(score_mod, df_test)</a>
<a class="sourceLine" id="cb86-9" data-line-number="9"> </a>
<a class="sourceLine" id="cb86-10" data-line-number="10"> <span class="co"># AUC #####################################</span></a>
<a class="sourceLine" id="cb86-11" data-line-number="11"> score_roc &lt;-<span class="st"> </span><span class="kw">roc</span>(pheno_test <span class="op">~</span><span class="st"> </span>score_pred)</a>
<a class="sourceLine" id="cb86-12" data-line-number="12"> all_auc[i,] &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">ci.auc</span>(score_roc))</a>
<a class="sourceLine" id="cb86-13" data-line-number="13"> </a>
<a class="sourceLine" id="cb86-14" data-line-number="14"> <span class="co"># ODDS RATIO #############################</span></a>
<a class="sourceLine" id="cb86-15" data-line-number="15"> score_group &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">length</span>(score_pred))</a>
<a class="sourceLine" id="cb86-16" data-line-number="16"> score_group[score_pred <span class="op">&lt;</span><span class="st"> </span><span class="kw">quantile</span>(score_pred, <span class="fl">0.2</span>)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb86-17" data-line-number="17"> score_group[score_pred <span class="op">&gt;</span><span class="st"> </span><span class="kw">quantile</span>(score_pred, <span class="fl">0.8</span>)] &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb86-18" data-line-number="18"> </a>
<a class="sourceLine" id="cb86-19" data-line-number="19"> score_odds_table &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">sum</span>(df_test<span class="op">$</span>pheno <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>score_group <span class="op">==</span><span class="st"> </span><span class="dv">2</span>), <span class="kw">sum</span>(df_test<span class="op">$</span>pheno <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>score_group <span class="op">==</span><span class="st"> </span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb86-20" data-line-number="20">                              <span class="kw">sum</span>(df_test<span class="op">$</span>pheno <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>score_group <span class="op">==</span><span class="st"> </span><span class="dv">0</span>), <span class="kw">sum</span>(df_test<span class="op">$</span>pheno <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>score_group <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)), <span class="dt">nrow =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb86-21" data-line-number="21"> score_odds_ratio &lt;-<span class="st"> </span><span class="kw">oddsratio.wald</span>(score_odds_table)</a>
<a class="sourceLine" id="cb86-22" data-line-number="22"> all_odds_ratio[i,] &lt;-<span class="st"> </span>score_odds_ratio<span class="op">$</span>measure[<span class="dv">2</span>,<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">3</span>)]</a>
<a class="sourceLine" id="cb86-23" data-line-number="23">}</a>
<a class="sourceLine" id="cb86-24" data-line-number="24"></a>
<a class="sourceLine" id="cb86-25" data-line-number="25">all_conc_holder[[overall_counter]] &lt;-<span class="st"> </span>all_conc</a>
<a class="sourceLine" id="cb86-26" data-line-number="26">all_survfit_holder[[overall_counter]] &lt;-<span class="st"> </span>all_subrates</a>
<a class="sourceLine" id="cb86-27" data-line-number="27">all_auc_holder[[overall_counter]] &lt;-<span class="st"> </span>all_auc</a>
<a class="sourceLine" id="cb86-28" data-line-number="28">all_or_holder[[overall_counter]] &lt;-<span class="st"> </span>all_odds_ratio</a>
<a class="sourceLine" id="cb86-29" data-line-number="29"></a>
<a class="sourceLine" id="cb86-30" data-line-number="30">all_base_holder[[<span class="dv">1</span>]][[overall_counter]] &lt;-<span class="st"> </span>base_conc</a>
<a class="sourceLine" id="cb86-31" data-line-number="31">all_base_holder[[<span class="dv">2</span>]][[overall_counter]] &lt;-<span class="st"> </span>base_cumhaz</a>
<a class="sourceLine" id="cb86-32" data-line-number="32">all_base_holder[[<span class="dv">3</span>]][[overall_counter]] &lt;-<span class="st"> </span>base_auc</a>
<a class="sourceLine" id="cb86-33" data-line-number="33">all_base_holder[[<span class="dv">4</span>]][[overall_counter]] &lt;-<span class="st"> </span>base_odds_ratio</a>
<a class="sourceLine" id="cb86-34" data-line-number="34">overall_counter &lt;-<span class="st"> </span>overall_counter <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb86-35" data-line-number="35"><span class="co">#}</span></a>
<a class="sourceLine" id="cb86-36" data-line-number="36"><span class="co">#}</span></a>
<a class="sourceLine" id="cb86-37" data-line-number="37"></a>
<a class="sourceLine" id="cb86-38" data-line-number="38"></a>
<a class="sourceLine" id="cb86-39" data-line-number="39">final_obj &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">&quot;conc&quot;</span> =<span class="st"> </span>all_conc_holder, <span class="st">&quot;survfit&quot;</span> =<span class="st"> </span>all_survfit_holder, <span class="st">&quot;auc&quot;</span> =<span class="st"> </span>all_auc_holder, <span class="st">&quot;or&quot;</span> =<span class="st"> </span>all_or_holder)</a>
<a class="sourceLine" id="cb86-40" data-line-number="40"><span class="kw">saveRDS</span>(final_obj, <span class="kw">paste0</span>(<span class="st">&quot;tune_results/&quot;</span>, author, <span class="st">&quot;_res.RDS&quot;</span>))</a></code></pre></div>
</div>
</div>
<div id="choosing-the-best-score" class="section level2">
<h2><span class="header-section-number">8.2</span> Choosing the Best Score</h2>
<p>Now that we have all of the performance metrics all we need to do to pick the best score is average over all of the repats and folds, then find the maximum. All of these are accomplished in a rather straightforward manner in the following script.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" data-line-number="1"><span class="co">#Read in the starting information</span></a>
<a class="sourceLine" id="cb87-2" data-line-number="2">author &lt;-<span class="st"> &quot;IMSGC&quot;</span></a>
<a class="sourceLine" id="cb87-3" data-line-number="3">all_res &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="kw">paste0</span>(<span class="st">&quot;tune_results/&quot;</span>, author, <span class="st">&quot;_res.RDS&quot;</span>))</a>
<a class="sourceLine" id="cb87-4" data-line-number="4"></a>
<a class="sourceLine" id="cb87-5" data-line-number="5"></a>
<a class="sourceLine" id="cb87-6" data-line-number="6"><span class="co">#Average all of the results</span></a>
<a class="sourceLine" id="cb87-7" data-line-number="7">mean_conc &lt;-<span class="st"> </span><span class="kw">Reduce</span>(<span class="st">&quot;+&quot;</span>, all_res[[<span class="st">&quot;conc&quot;</span>]])<span class="op">/</span><span class="kw">length</span>(all_res[[<span class="st">&quot;conc&quot;</span>]])</a>
<a class="sourceLine" id="cb87-8" data-line-number="8"></a>
<a class="sourceLine" id="cb87-9" data-line-number="9">mean_survfit &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="kw">length</span>(all_res[[<span class="st">&quot;survfit&quot;</span>]][[<span class="dv">1</span>]]), <span class="dt">ncol =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb87-10" data-line-number="10"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(all_res[[<span class="st">&quot;survfit&quot;</span>]])){</a>
<a class="sourceLine" id="cb87-11" data-line-number="11">  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">20</span>){</a>
<a class="sourceLine" id="cb87-12" data-line-number="12">    mean_survfit[j,] &lt;-<span class="st"> </span>mean_survfit[j,] <span class="op">+</span><span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">tail</span>(all_res[[<span class="st">&quot;survfit&quot;</span>]][[i]][[j]],<span class="dv">1</span>)[<span class="op">-</span><span class="dv">1</span>])</a>
<a class="sourceLine" id="cb87-13" data-line-number="13">  }</a>
<a class="sourceLine" id="cb87-14" data-line-number="14">}</a>
<a class="sourceLine" id="cb87-15" data-line-number="15">mean_survfit &lt;-<span class="st"> </span>mean_survfit<span class="op">/</span><span class="kw">length</span>(all_res[[<span class="st">&quot;survfit&quot;</span>]])</a>
<a class="sourceLine" id="cb87-16" data-line-number="16"></a>
<a class="sourceLine" id="cb87-17" data-line-number="17">mean_auc &lt;-<span class="st"> </span><span class="kw">Reduce</span>(<span class="st">&quot;+&quot;</span>, all_res[[<span class="st">&quot;auc&quot;</span>]])<span class="op">/</span><span class="kw">length</span>(all_res[[<span class="st">&quot;auc&quot;</span>]])</a>
<a class="sourceLine" id="cb87-18" data-line-number="18"></a>
<a class="sourceLine" id="cb87-19" data-line-number="19">mean_or &lt;-<span class="st"> </span><span class="kw">Reduce</span>(<span class="st">&quot;+&quot;</span>, all_res[[<span class="st">&quot;or&quot;</span>]])<span class="op">/</span><span class="kw">length</span>(all_res[[<span class="st">&quot;or&quot;</span>]])</a>
<a class="sourceLine" id="cb87-20" data-line-number="20"></a>
<a class="sourceLine" id="cb87-21" data-line-number="21"></a>
<a class="sourceLine" id="cb87-22" data-line-number="22"><span class="co">#Get the corresponding best score name</span></a>
<a class="sourceLine" id="cb87-23" data-line-number="23">conc_best_name &lt;-<span class="st"> </span>all_res[[<span class="st">&quot;score_names&quot;</span>]][<span class="kw">which.max</span>(mean_conc[,<span class="dv">2</span>])]</a>
<a class="sourceLine" id="cb87-24" data-line-number="24"></a>
<a class="sourceLine" id="cb87-25" data-line-number="25">survfit_best_name &lt;-<span class="st"> </span>all_res[[<span class="st">&quot;score_names&quot;</span>]][<span class="kw">which.max</span>(mean_survfit[,<span class="dv">3</span>]<span class="op">/</span>mean_survfit[,<span class="dv">1</span>])]</a>
<a class="sourceLine" id="cb87-26" data-line-number="26"></a>
<a class="sourceLine" id="cb87-27" data-line-number="27">auc_best_name &lt;-<span class="st"> </span>all_res[[<span class="st">&quot;score_names&quot;</span>]][<span class="kw">which.max</span>(mean_auc[,<span class="dv">2</span>])]</a>
<a class="sourceLine" id="cb87-28" data-line-number="28"></a>
<a class="sourceLine" id="cb87-29" data-line-number="29">or_best_name &lt;-<span class="st"> </span>all_res[[<span class="st">&quot;score_names&quot;</span>]][<span class="kw">which.max</span>(mean_or[,<span class="dv">2</span>])]</a>
<a class="sourceLine" id="cb87-30" data-line-number="30"></a>
<a class="sourceLine" id="cb87-31" data-line-number="31"></a>
<a class="sourceLine" id="cb87-32" data-line-number="32"><span class="co">#Write the result</span></a>
<a class="sourceLine" id="cb87-33" data-line-number="33">to_write &lt;-<span class="st"> </span><span class="kw">rbind</span>(conc_best_name, survfit_best_name, auc_best_name, or_best_name)</a>
<a class="sourceLine" id="cb87-34" data-line-number="34"><span class="kw">write.table</span>(to_write, <span class="kw">paste0</span>(<span class="st">&quot;tune_results/&quot;</span>, <span class="kw">tolower</span>(author), <span class="st">&quot;.best.ss&quot;</span>), <span class="dt">row.names =</span> T, <span class="dt">col.names =</span> F, <span class="dt">quote =</span> F, <span class="dt">sep =</span> <span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>)</a></code></pre></div>
<p>We can now go onto the testing phase, quickly and easily picking out the score name that corresponds to our preferred metric.</p>
</div>
<div id="plotting" class="section level2">
<h2><span class="header-section-number">8.3</span> Plotting</h2>
<p>To be done</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="score-analysis-set-up.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="non-predictive-evaluation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
